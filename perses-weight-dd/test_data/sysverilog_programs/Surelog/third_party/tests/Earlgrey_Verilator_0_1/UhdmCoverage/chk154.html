
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ibex_ibex_core_0.1/rtl/ibex_cs_registers.sv Cov: 90.9% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Copyright 2018 ETH Zurich and University of Bologna, see also CREDITS.md.</pre>
<pre style="margin:0; padding:0 ">   3: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   4: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   5: </pre>
<pre style="margin:0; padding:0 ">   6: /**</pre>
<pre style="margin:0; padding:0 ">   7:  * Control and Status Registers</pre>
<pre style="margin:0; padding:0 ">   8:  *</pre>
<pre style="margin:0; padding:0 ">   9:  * Control and Status Registers (CSRs) following the RISC-V Privileged</pre>
<pre style="margin:0; padding:0 ">  10:  * Specification, draft version 1.11</pre>
<pre style="margin:0; padding:0 ">  11:  */</pre>
<pre style="margin:0; padding:0 ">  12: </pre>
<pre style="margin:0; padding:0 ">  13: `include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 ">  14: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  15: module ibex_cs_registers #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  16:     parameter bit          DbgTriggerEn      = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  17:     parameter bit          DataIndTiming     = 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:     parameter bit          DummyInstructions = 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  19:     parameter bit          ICache            = 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  20:     parameter int unsigned MHPMCounterNum    = 10,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:     parameter int unsigned MHPMCounterWidth  = 40,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  22:     parameter bit          PMPEnable         = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  23:     parameter int unsigned PMPGranularity    = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  24:     parameter int unsigned PMPNumRegions     = 4,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  25:     parameter bit          RV32E             = 0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:     parameter bit          RV32M             = 0</pre>
<pre style="margin:0; padding:0 ">  27: ) (</pre>
<pre style="margin:0; padding:0 ">  28:     // Clock and Reset</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  29:     input  logic                 clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:     input  logic                 rst_ni,</pre>
<pre style="margin:0; padding:0 ">  31: </pre>
<pre style="margin:0; padding:0 ">  32:     // Hart ID</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:     input  logic [31:0]          hart_id_i,</pre>
<pre style="margin:0; padding:0 ">  34: </pre>
<pre style="margin:0; padding:0 ">  35:     // Privilege mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36:     output ibex_pkg::priv_lvl_e  priv_mode_id_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:     output ibex_pkg::priv_lvl_e  priv_mode_if_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  38:     output ibex_pkg::priv_lvl_e  priv_mode_lsu_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:     output logic                 csr_mstatus_tw_o,</pre>
<pre style="margin:0; padding:0 ">  40: </pre>
<pre style="margin:0; padding:0 ">  41:     // mtvec</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  42:     output logic [31:0]          csr_mtvec_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:     input  logic                 csr_mtvec_init_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:     input  logic [31:0]          boot_addr_i,</pre>
<pre style="margin:0; padding:0 ">  45: </pre>
<pre style="margin:0; padding:0 ">  46:     // Interface to registers (SRAM like)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:     input  logic                 csr_access_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:     input  ibex_pkg::csr_num_e   csr_addr_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  49:     input  logic [31:0]          csr_wdata_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50:     input  ibex_pkg::csr_op_e    csr_op_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:     input                        csr_op_en_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:     output logic [31:0]          csr_rdata_o,</pre>
<pre style="margin:0; padding:0 ">  53: </pre>
<pre style="margin:0; padding:0 ">  54:     // interrupts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  55:     input  logic                 irq_software_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  56:     input  logic                 irq_timer_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  57:     input  logic                 irq_external_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:     input  logic [14:0]          irq_fast_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:     input  logic                 nmi_mode_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:     output logic                 irq_pending_o,          // interrupt request pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:     output ibex_pkg::irqs_t      irqs_o,                 // interrupt requests qualified with mie</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:     output logic                 csr_mstatus_mie_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63:     output logic [31:0]          csr_mepc_o,</pre>
<pre style="margin:0; padding:0 ">  64: </pre>
<pre style="margin:0; padding:0 ">  65:     // PMP</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:     output ibex_pkg::pmp_cfg_t   csr_pmp_cfg_o  [PMPNumRegions],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  67:     output logic [33:0]          csr_pmp_addr_o [PMPNumRegions],</pre>
<pre style="margin:0; padding:0 ">  68: </pre>
<pre style="margin:0; padding:0 ">  69:     // debug</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:     input  logic                 debug_mode_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  71:     input  ibex_pkg::dbg_cause_e debug_cause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  72:     input  logic                 debug_csr_save_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73:     output logic [31:0]          csr_depc_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:     output logic                 debug_single_step_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  75:     output logic                 debug_ebreakm_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76:     output logic                 debug_ebreaku_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:     output logic                 trigger_match_o,</pre>
<pre style="margin:0; padding:0 ">  78: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  79:     input  logic [31:0]          pc_if_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:     input  logic [31:0]          pc_id_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  81:     input  logic [31:0]          pc_wb_i,</pre>
<pre style="margin:0; padding:0 ">  82: </pre>
<pre style="margin:0; padding:0 ">  83:     // CPU control bits</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  84:     output logic                 data_ind_timing_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  85:     output logic                 dummy_instr_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  86:     output logic [2:0]           dummy_instr_mask_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:     output logic                 dummy_instr_seed_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:     output logic [31:0]          dummy_instr_seed_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:     output logic                 icache_enable_o,</pre>
<pre style="margin:0; padding:0 ">  90: </pre>
<pre style="margin:0; padding:0 ">  91:     // Exception save/restore</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  92:     input  logic                 csr_save_if_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  93:     input  logic                 csr_save_id_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:     input  logic                 csr_save_wb_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:     input  logic                 csr_restore_mret_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:     input  logic                 csr_restore_dret_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:     input  logic                 csr_save_cause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  98:     input  ibex_pkg::exc_cause_e csr_mcause_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  99:     input  logic [31:0]          csr_mtval_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:     output logic                 illegal_csr_insn_o,     // access to non-existent CSR,</pre>
<pre style="margin:0; padding:0 "> 101:                                                          // with wrong priviledge level, or</pre>
<pre style="margin:0; padding:0 "> 102:                                                          // missing write permissions</pre>
<pre style="margin:0; padding:0 "> 103:     // Performance Counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:     input  logic                 instr_ret_i,            // instr retired in ID/EX stage</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:     input  logic                 instr_ret_compressed_i, // compressed instr retired</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 106:     input  logic                 iside_wait_i,           // core waiting for the iside</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 107:     input  logic                 jump_i,                 // jump instr seen (j, jr, jal, jalr)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 108:     input  logic                 branch_i,               // branch instr seen (bf, bnf)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:     input  logic                 branch_taken_i,         // branch was taken</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:     input  logic                 mem_load_i,             // load from memory in this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:     input  logic                 mem_store_i,            // store to memory in this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:     input  logic                 dside_wait_i,           // core waiting for the dside</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:     input  logic                 mul_wait_i,             // core waiting for multiply</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:     input  logic                 div_wait_i              // core waiting for divide</pre>
<pre style="margin:0; padding:0 "> 115: );</pre>
<pre style="margin:0; padding:0 "> 116: </pre>
<pre style="margin:0; padding:0 "> 117:   import ibex_pkg::*;</pre>
<pre style="margin:0; padding:0 "> 118: </pre>
<pre style="margin:0; padding:0 "> 119:   // misa</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:   localparam logic [31:0] MISA_VALUE =</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:       (0                 <<  0)  // A - Atomic Instructions extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:     | (1                 <<  2)  // C - Compressed extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 123:     | (0                 <<  3)  // D - Double precision floating-point extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 124:     | (32'(RV32E)        <<  4)  // E - RV32E base ISA</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 125:     | (0                 <<  5)  // F - Single precision floating-point extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 126:     | (32'(!RV32E)       <<  8)  // I - RV32I/64I/128I base ISA</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 127:     | (32'(RV32M)        << 12)  // M - Integer Multiply/Divide extension</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 128:     | (0                 << 13)  // N - User level interrupts supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 129:     | (0                 << 18)  // S - Supervisor mode implemented</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 130:     | (1                 << 20)  // U - User mode implemented</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 131:     | (0                 << 23)  // X - Non-standard extensions present</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132:     | (32'(CSR_MISA_MXL) << 30); // M-XLEN</pre>
<pre style="margin:0; padding:0 "> 133: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:   typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:     logic      mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:     logic      mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 137:     priv_lvl_e mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 138:     logic      mprv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 139:     logic      tw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140:   } Status_t;</pre>
<pre style="margin:0; padding:0 "> 141: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:   typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:     logic      mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:     priv_lvl_e mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:   } StatusStk_t;</pre>
<pre style="margin:0; padding:0 "> 146: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:   typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:       x_debug_ver_e xdebugver;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:       logic [11:0]  zero2;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:       logic         ebreakm;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151:       logic         zero1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:       logic         ebreaks;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 153:       logic         ebreaku;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 154:       logic         stepie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 155:       logic         stopcount;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 156:       logic         stoptime;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 157:       dbg_cause_e   cause;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:       logic         zero0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:       logic         mprven;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:       logic         nmip;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 161:       logic         step;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 162:       priv_lvl_e    prv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 163:   } Dcsr_t;</pre>
<pre style="margin:0; padding:0 "> 164: </pre>
<pre style="margin:0; padding:0 "> 165:   // CPU control register fields</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166:   typedef struct packed {</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:     logic [31:6] unused_ctrl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:     logic [2:0]  dummy_instr_mask;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 169:     logic        dummy_instr_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:     logic        data_ind_timing;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 171:     logic        icache_enable;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:   } CpuCtrl_t;</pre>
<pre style="margin:0; padding:0 "> 173: </pre>
<pre style="margin:0; padding:0 "> 174:   // Interrupt and exception control signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:   logic [31:0] exception_pc;</pre>
<pre style="margin:0; padding:0 "> 176: </pre>
<pre style="margin:0; padding:0 "> 177:   // CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 178:   priv_lvl_e   priv_lvl_q, priv_lvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 179:   Status_t     mstatus_q, mstatus_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180:   irqs_t       mie_q, mie_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 181:   logic [31:0] mscratch_q, mscratch_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 182:   logic [31:0] mepc_q, mepc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 183:   logic  [5:0] mcause_q, mcause_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:   logic [31:0] mtval_q, mtval_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:   logic [31:0] mtvec_q, mtvec_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:   irqs_t       mip;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:   Dcsr_t       dcsr_q, dcsr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:   logic [31:0] depc_q, depc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:   logic [31:0] dscratch0_q, dscratch0_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190:   logic [31:0] dscratch1_q, dscratch1_d;</pre>
<pre style="margin:0; padding:0 "> 191: </pre>
<pre style="margin:0; padding:0 "> 192:   // CSRs for recoverable NMIs</pre>
<pre style="margin:0; padding:0 "> 193:   // NOTE: these CSRS are nonstandard, see https://github.com/riscv/riscv-isa-manual/issues/261</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 194:   StatusStk_t  mstack_q, mstack_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 195:   logic [31:0] mstack_epc_q, mstack_epc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:   logic  [5:0] mstack_cause_q, mstack_cause_d;</pre>
<pre style="margin:0; padding:0 "> 197: </pre>
<pre style="margin:0; padding:0 "> 198:   // PMP Signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:   logic [31:0]                 pmp_addr_rdata  [PMP_MAX_REGIONS];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:   logic [PMP_CFG_W-1:0]        pmp_cfg_rdata   [PMP_MAX_REGIONS];</pre>
<pre style="margin:0; padding:0 "> 201: </pre>
<pre style="margin:0; padding:0 "> 202:   // Hardware performance monitor signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:   logic [31:0]                 mcountinhibit;</pre>
<pre style="margin:0; padding:0 "> 204:   // Only have mcountinhibit flops for counters that actually exist</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205:   logic [MHPMCounterNum+3-1:0] mcountinhibit_d, mcountinhibit_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 206:   logic                        mcountinhibit_we;</pre>
<pre style="margin:0; padding:0 "> 207: </pre>
<pre style="margin:0; padding:0 "> 208:   // mhpmcounter flops are elaborated below providing only the precise number that is required based</pre>
<pre style="margin:0; padding:0 "> 209:   // on MHPMCounterNum/MHPMCounterWidth. This signal connects to the Q output of these flops</pre>
<pre style="margin:0; padding:0 "> 210:   // where they exist and is otherwise 0.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 211:   logic [63:0] mhpmcounter [32];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:   logic [31:0] mhpmcounter_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 213:   logic [31:0] mhpmcounterh_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 214:   logic [31:0] mhpmcounter_incr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 215:   logic [31:0] mhpmevent [32];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:   logic  [4:0] mhpmcounter_idx;</pre>
<pre style="margin:0; padding:0 "> 217: </pre>
<pre style="margin:0; padding:0 "> 218:   // Debug / trigger registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 219:   logic [31:0] tselect_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 220:   logic [31:0] tmatch_control_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:   logic [31:0] tmatch_value_rdata;</pre>
<pre style="margin:0; padding:0 "> 222: </pre>
<pre style="margin:0; padding:0 "> 223:   // CPU control bits</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:   CpuCtrl_t    cpuctrl_rdata, cpuctrl_wdata;</pre>
<pre style="margin:0; padding:0 "> 225: </pre>
<pre style="margin:0; padding:0 "> 226:   // CSR update logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 227:   logic [31:0] csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 228:   logic [31:0] csr_rdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 229:   logic        csr_we_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 230:   logic        csr_wreq;</pre>
<pre style="margin:0; padding:0 "> 231: </pre>
<pre style="margin:0; padding:0 "> 232:   // Access violation signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 233:   logic        illegal_csr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 234:   logic        illegal_csr_priv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:   logic        illegal_csr_write;</pre>
<pre style="margin:0; padding:0 "> 236: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:   logic [7:0]  unused_boot_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:   logic [2:0]  unused_csr_addr;</pre>
<pre style="margin:0; padding:0 "> 239: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 240:   assign unused_boot_addr = boot_addr_i[7:0];</pre>
<pre style="margin:0; padding:0 "> 241: </pre>
<pre style="margin:0; padding:0 "> 242:   /////////////</pre>
<pre style="margin:0; padding:0 "> 243:   // CSR reg //</pre>
<pre style="margin:0; padding:0 "> 244:   /////////////</pre>
<pre style="margin:0; padding:0 "> 245: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:   logic [$bits(csr_num_e)-1:0] csr_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:   assign csr_addr           = {csr_addr_i};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 248:   assign unused_csr_addr    = csr_addr[7:5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 249:   assign mhpmcounter_idx    = csr_addr[4:0];</pre>
<pre style="margin:0; padding:0 "> 250: </pre>
<pre style="margin:0; padding:0 "> 251:   // See RISC-V Privileged Specification, version 1.11, Section 2.1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:   assign illegal_csr_priv   = (csr_addr[9:8] > {priv_lvl_q});</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:   assign illegal_csr_write  = (csr_addr[11:10] == 2'b11) && csr_wreq;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:   assign illegal_csr_insn_o = csr_access_i & (illegal_csr | illegal_csr_write | illegal_csr_priv);</pre>
<pre style="margin:0; padding:0 "> 255: </pre>
<pre style="margin:0; padding:0 "> 256:   // mip CSR is purely combinational - must be able to re-enable the clock upon WFI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 257:   assign mip.irq_software = irq_software_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:   assign mip.irq_timer    = irq_timer_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 259:   assign mip.irq_external = irq_external_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 260:   assign mip.irq_fast     = irq_fast_i;</pre>
<pre style="margin:0; padding:0 "> 261: </pre>
<pre style="margin:0; padding:0 "> 262:   // read logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:     csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 265:     illegal_csr   = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 266: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:     unique case (csr_addr_i)</pre>
<pre style="margin:0; padding:0 "> 268:       // mhartid: unique hardware thread id</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:       CSR_MHARTID: csr_rdata_int = hart_id_i;</pre>
<pre style="margin:0; padding:0 "> 270: </pre>
<pre style="margin:0; padding:0 "> 271:       // mstatus: always M-mode, contains IE bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 272:       CSR_MSTATUS: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 273:         csr_rdata_int                                                   = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 274:         csr_rdata_int[CSR_MSTATUS_MIE_BIT]                              = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 275:         csr_rdata_int[CSR_MSTATUS_MPIE_BIT]                             = mstatus_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:         csr_rdata_int[CSR_MSTATUS_MPP_BIT_HIGH:CSR_MSTATUS_MPP_BIT_LOW] = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 277:         csr_rdata_int[CSR_MSTATUS_MPRV_BIT]                             = mstatus_q.mprv;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 278:         csr_rdata_int[CSR_MSTATUS_TW_BIT]                               = mstatus_q.tw;</pre>
<pre style="margin:0; padding:0 "> 279:       end</pre>
<pre style="margin:0; padding:0 "> 280: </pre>
<pre style="margin:0; padding:0 "> 281:       // misa</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 282:       CSR_MISA: csr_rdata_int = MISA_VALUE;</pre>
<pre style="margin:0; padding:0 "> 283: </pre>
<pre style="margin:0; padding:0 "> 284:       // interrupt enable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285:       CSR_MIE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 286:         csr_rdata_int                                     = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 287:         csr_rdata_int[CSR_MSIX_BIT]                       = mie_q.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288:         csr_rdata_int[CSR_MTIX_BIT]                       = mie_q.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:         csr_rdata_int[CSR_MEIX_BIT]                       = mie_q.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:         csr_rdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW] = mie_q.irq_fast;</pre>
<pre style="margin:0; padding:0 "> 291:       end</pre>
<pre style="margin:0; padding:0 "> 292: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 293:       CSR_MSCRATCH: csr_rdata_int = mscratch_q;</pre>
<pre style="margin:0; padding:0 "> 294: </pre>
<pre style="margin:0; padding:0 "> 295:       // mtvec: trap-vector base address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:       CSR_MTVEC: csr_rdata_int = mtvec_q;</pre>
<pre style="margin:0; padding:0 "> 297: </pre>
<pre style="margin:0; padding:0 "> 298:       // mepc: exception program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:       CSR_MEPC: csr_rdata_int = mepc_q;</pre>
<pre style="margin:0; padding:0 "> 300: </pre>
<pre style="margin:0; padding:0 "> 301:       // mcause: exception cause</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 302:       CSR_MCAUSE: csr_rdata_int = {mcause_q[5], 26'b0, mcause_q[4:0]};</pre>
<pre style="margin:0; padding:0 "> 303: </pre>
<pre style="margin:0; padding:0 "> 304:       // mtval: trap value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 305:       CSR_MTVAL: csr_rdata_int = mtval_q;</pre>
<pre style="margin:0; padding:0 "> 306: </pre>
<pre style="margin:0; padding:0 "> 307:       // mip: interrupt pending</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 308:       CSR_MIP: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309:         csr_rdata_int                                     = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 310:         csr_rdata_int[CSR_MSIX_BIT]                       = mip.irq_software;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:         csr_rdata_int[CSR_MTIX_BIT]                       = mip.irq_timer;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312:         csr_rdata_int[CSR_MEIX_BIT]                       = mip.irq_external;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 313:         csr_rdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW] = mip.irq_fast;</pre>
<pre style="margin:0; padding:0 "> 314:       end</pre>
<pre style="margin:0; padding:0 "> 315: </pre>
<pre style="margin:0; padding:0 "> 316:       // PMP registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:       CSR_PMPCFG0:   csr_rdata_int = {pmp_cfg_rdata[3],  pmp_cfg_rdata[2],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:                                       pmp_cfg_rdata[1],  pmp_cfg_rdata[0]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:       CSR_PMPCFG1:   csr_rdata_int = {pmp_cfg_rdata[7],  pmp_cfg_rdata[6],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 320:                                       pmp_cfg_rdata[5],  pmp_cfg_rdata[4]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:       CSR_PMPCFG2:   csr_rdata_int = {pmp_cfg_rdata[11], pmp_cfg_rdata[10],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:                                       pmp_cfg_rdata[9],  pmp_cfg_rdata[8]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 323:       CSR_PMPCFG3:   csr_rdata_int = {pmp_cfg_rdata[15], pmp_cfg_rdata[14],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 324:                                       pmp_cfg_rdata[13], pmp_cfg_rdata[12]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 325:       CSR_PMPADDR0:  csr_rdata_int = pmp_addr_rdata[0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 326:       CSR_PMPADDR1:  csr_rdata_int = pmp_addr_rdata[1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 327:       CSR_PMPADDR2:  csr_rdata_int = pmp_addr_rdata[2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 328:       CSR_PMPADDR3:  csr_rdata_int = pmp_addr_rdata[3];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 329:       CSR_PMPADDR4:  csr_rdata_int = pmp_addr_rdata[4];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:       CSR_PMPADDR5:  csr_rdata_int = pmp_addr_rdata[5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:       CSR_PMPADDR6:  csr_rdata_int = pmp_addr_rdata[6];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:       CSR_PMPADDR7:  csr_rdata_int = pmp_addr_rdata[7];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:       CSR_PMPADDR8:  csr_rdata_int = pmp_addr_rdata[8];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 334:       CSR_PMPADDR9:  csr_rdata_int = pmp_addr_rdata[9];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 335:       CSR_PMPADDR10: csr_rdata_int = pmp_addr_rdata[10];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:       CSR_PMPADDR11: csr_rdata_int = pmp_addr_rdata[11];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 337:       CSR_PMPADDR12: csr_rdata_int = pmp_addr_rdata[12];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 338:       CSR_PMPADDR13: csr_rdata_int = pmp_addr_rdata[13];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 339:       CSR_PMPADDR14: csr_rdata_int = pmp_addr_rdata[14];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340:       CSR_PMPADDR15: csr_rdata_int = pmp_addr_rdata[15];</pre>
<pre style="margin:0; padding:0 "> 341: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 342:       CSR_DCSR: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:         csr_rdata_int = dcsr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 344:         illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 "> 345:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 346:       CSR_DPC: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 347:         csr_rdata_int = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 348:         illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 "> 349:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:       CSR_DSCRATCH0: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:         csr_rdata_int = dscratch0_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:         illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 "> 353:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354:       CSR_DSCRATCH1: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:         csr_rdata_int = dscratch1_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 356:         illegal_csr = ~debug_mode_i;</pre>
<pre style="margin:0; padding:0 "> 357:       end</pre>
<pre style="margin:0; padding:0 "> 358: </pre>
<pre style="margin:0; padding:0 "> 359:       // machine counter/timers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:       CSR_MCOUNTINHIBIT: csr_rdata_int = mcountinhibit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:       CSR_MHPMEVENT3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:       CSR_MHPMEVENT4,  CSR_MHPMEVENT5,  CSR_MHPMEVENT6,  CSR_MHPMEVENT7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:       CSR_MHPMEVENT8,  CSR_MHPMEVENT9,  CSR_MHPMEVENT10, CSR_MHPMEVENT11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:       CSR_MHPMEVENT12, CSR_MHPMEVENT13, CSR_MHPMEVENT14, CSR_MHPMEVENT15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:       CSR_MHPMEVENT16, CSR_MHPMEVENT17, CSR_MHPMEVENT18, CSR_MHPMEVENT19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 366:       CSR_MHPMEVENT20, CSR_MHPMEVENT21, CSR_MHPMEVENT22, CSR_MHPMEVENT23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:       CSR_MHPMEVENT24, CSR_MHPMEVENT25, CSR_MHPMEVENT26, CSR_MHPMEVENT27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 368:       CSR_MHPMEVENT28, CSR_MHPMEVENT29, CSR_MHPMEVENT30, CSR_MHPMEVENT31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 369:         csr_rdata_int = mhpmevent[mhpmcounter_idx];</pre>
<pre style="margin:0; padding:0 "> 370:       end</pre>
<pre style="margin:0; padding:0 "> 371: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:       CSR_MCYCLE,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 373:       CSR_MINSTRET,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 374:       CSR_MHPMCOUNTER3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 375:       CSR_MHPMCOUNTER4,  CSR_MHPMCOUNTER5,  CSR_MHPMCOUNTER6,  CSR_MHPMCOUNTER7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:       CSR_MHPMCOUNTER8,  CSR_MHPMCOUNTER9,  CSR_MHPMCOUNTER10, CSR_MHPMCOUNTER11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 377:       CSR_MHPMCOUNTER12, CSR_MHPMCOUNTER13, CSR_MHPMCOUNTER14, CSR_MHPMCOUNTER15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 378:       CSR_MHPMCOUNTER16, CSR_MHPMCOUNTER17, CSR_MHPMCOUNTER18, CSR_MHPMCOUNTER19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:       CSR_MHPMCOUNTER20, CSR_MHPMCOUNTER21, CSR_MHPMCOUNTER22, CSR_MHPMCOUNTER23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:       CSR_MHPMCOUNTER24, CSR_MHPMCOUNTER25, CSR_MHPMCOUNTER26, CSR_MHPMCOUNTER27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:       CSR_MHPMCOUNTER28, CSR_MHPMCOUNTER29, CSR_MHPMCOUNTER30, CSR_MHPMCOUNTER31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:         csr_rdata_int = mhpmcounter[mhpmcounter_idx][31:0];</pre>
<pre style="margin:0; padding:0 "> 383:       end</pre>
<pre style="margin:0; padding:0 "> 384: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 385:       CSR_MCYCLEH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 386:       CSR_MINSTRETH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:       CSR_MHPMCOUNTER3H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:       CSR_MHPMCOUNTER4H,  CSR_MHPMCOUNTER5H,  CSR_MHPMCOUNTER6H,  CSR_MHPMCOUNTER7H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389:       CSR_MHPMCOUNTER8H,  CSR_MHPMCOUNTER9H,  CSR_MHPMCOUNTER10H, CSR_MHPMCOUNTER11H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 390:       CSR_MHPMCOUNTER12H, CSR_MHPMCOUNTER13H, CSR_MHPMCOUNTER14H, CSR_MHPMCOUNTER15H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:       CSR_MHPMCOUNTER16H, CSR_MHPMCOUNTER17H, CSR_MHPMCOUNTER18H, CSR_MHPMCOUNTER19H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392:       CSR_MHPMCOUNTER20H, CSR_MHPMCOUNTER21H, CSR_MHPMCOUNTER22H, CSR_MHPMCOUNTER23H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 393:       CSR_MHPMCOUNTER24H, CSR_MHPMCOUNTER25H, CSR_MHPMCOUNTER26H, CSR_MHPMCOUNTER27H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:       CSR_MHPMCOUNTER28H, CSR_MHPMCOUNTER29H, CSR_MHPMCOUNTER30H, CSR_MHPMCOUNTER31H: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 395:         csr_rdata_int = mhpmcounter[mhpmcounter_idx][63:32];</pre>
<pre style="margin:0; padding:0 "> 396:       end</pre>
<pre style="margin:0; padding:0 "> 397: </pre>
<pre style="margin:0; padding:0 "> 398:       // Debug triggers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 399:       CSR_TSELECT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:         csr_rdata_int = tselect_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 401:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 402:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 403:       CSR_TDATA1: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 404:         csr_rdata_int = tmatch_control_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 405:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 406:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 407:       CSR_TDATA2: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 408:         csr_rdata_int = tmatch_value_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 410:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 411:       CSR_TDATA3: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 412:         csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 413:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 414:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 415:       CSR_MCONTEXT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:         csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 417:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 418:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 419:       CSR_SCONTEXT: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 420:         csr_rdata_int = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 421:         illegal_csr   = ~DbgTriggerEn;</pre>
<pre style="margin:0; padding:0 "> 422:       end</pre>
<pre style="margin:0; padding:0 "> 423: </pre>
<pre style="margin:0; padding:0 "> 424:       // Custom CSR for controlling CPU features</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 425:       CSR_CPUCTRL: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:         csr_rdata_int = {cpuctrl_rdata};</pre>
<pre style="margin:0; padding:0 "> 427:       end</pre>
<pre style="margin:0; padding:0 "> 428: </pre>
<pre style="margin:0; padding:0 "> 429:       // Custom CSR for LFSR re-seeding (cannot be read)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 430:       CSR_SECURESEED: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 431:         csr_rdata_int = '0;</pre>
<pre style="margin:0; padding:0 "> 432:       end</pre>
<pre style="margin:0; padding:0 "> 433: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 434:       default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 435:         illegal_csr = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 436:       end</pre>
<pre style="margin:0; padding:0 "> 437:     endcase</pre>
<pre style="margin:0; padding:0 "> 438:   end</pre>
<pre style="margin:0; padding:0 "> 439: </pre>
<pre style="margin:0; padding:0 "> 440:   // write logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 442:     exception_pc = pc_id_i;</pre>
<pre style="margin:0; padding:0 "> 443: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 444:     priv_lvl_d   = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 445:     mstatus_d    = mstatus_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 446:     mie_d        = mie_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 447:     mscratch_d   = mscratch_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 448:     mepc_d       = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 449:     mcause_d     = mcause_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 450:     mtval_d      = mtval_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 451:     mtvec_d      = csr_mtvec_init_i ? {boot_addr_i[31:8], 6'b0, 2'b01} : mtvec_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 452:     dcsr_d       = dcsr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 453:     depc_d       = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 454:     dscratch0_d  = dscratch0_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 455:     dscratch1_d  = dscratch1_q;</pre>
<pre style="margin:0; padding:0 "> 456: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 457:     mstack_d       = mstack_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 458:     mstack_epc_d   = mstack_epc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 459:     mstack_cause_d = mstack_cause_q;</pre>
<pre style="margin:0; padding:0 "> 460: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 461:     mcountinhibit_we = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 462:     mhpmcounter_we   = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:     mhpmcounterh_we  = '0;</pre>
<pre style="margin:0; padding:0 "> 464: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:     if (csr_we_int) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466:       unique case (csr_addr_i)</pre>
<pre style="margin:0; padding:0 "> 467:         // mstatus: IE bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468:         CSR_MSTATUS: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 469:           mstatus_d = '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:               mie:  csr_wdata_int[CSR_MSTATUS_MIE_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:               mpie: csr_wdata_int[CSR_MSTATUS_MPIE_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:               mpp:  priv_lvl_e'(csr_wdata_int[CSR_MSTATUS_MPP_BIT_HIGH:CSR_MSTATUS_MPP_BIT_LOW]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:               mprv: csr_wdata_int[CSR_MSTATUS_MPRV_BIT],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:               tw:   csr_wdata_int[CSR_MSTATUS_TW_BIT]</pre>
<pre style="margin:0; padding:0 "> 475:           };</pre>
<pre style="margin:0; padding:0 "> 476:           // Convert illegal values to M-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:           if ((mstatus_d.mpp != PRIV_LVL_M) && (mstatus_d.mpp != PRIV_LVL_U)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 478:             mstatus_d.mpp = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 "> 479:           end</pre>
<pre style="margin:0; padding:0 "> 480:         end</pre>
<pre style="margin:0; padding:0 "> 481: </pre>
<pre style="margin:0; padding:0 "> 482:         // interrupt enable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 483:         CSR_MIE: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:           mie_d.irq_software = csr_wdata_int[CSR_MSIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:           mie_d.irq_timer    = csr_wdata_int[CSR_MTIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 486:           mie_d.irq_external = csr_wdata_int[CSR_MEIX_BIT];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 487:           mie_d.irq_fast     = csr_wdata_int[CSR_MFIX_BIT_HIGH:CSR_MFIX_BIT_LOW];</pre>
<pre style="margin:0; padding:0 "> 488:         end</pre>
<pre style="margin:0; padding:0 "> 489: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 490:         CSR_MSCRATCH: mscratch_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "> 491: </pre>
<pre style="margin:0; padding:0 "> 492:         // mepc: exception program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:         CSR_MEPC: mepc_d = {csr_wdata_int[31:1], 1'b0};</pre>
<pre style="margin:0; padding:0 "> 494: </pre>
<pre style="margin:0; padding:0 "> 495:         // mcause</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 496:         CSR_MCAUSE: mcause_d = {csr_wdata_int[31], csr_wdata_int[4:0]};</pre>
<pre style="margin:0; padding:0 "> 497: </pre>
<pre style="margin:0; padding:0 "> 498:         // mtval: trap value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 499:         CSR_MTVAL: mtval_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "> 500: </pre>
<pre style="margin:0; padding:0 "> 501:         // mtvec</pre>
<pre style="margin:0; padding:0 "> 502:         // mtvec.MODE set to vectored</pre>
<pre style="margin:0; padding:0 "> 503:         // mtvec.BASE must be 256-byte aligned</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 504:         CSR_MTVEC: mtvec_d = {csr_wdata_int[31:8], 6'b0, 2'b01};</pre>
<pre style="margin:0; padding:0 "> 505: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 506:         CSR_DCSR: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 507:           dcsr_d = csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508:           dcsr_d.xdebugver = XDEBUGVER_STD;</pre>
<pre style="margin:0; padding:0 "> 509:           // Change to PRIV_LVL_M if software writes an unsupported value</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 510:           if ((dcsr_d.prv != PRIV_LVL_M) && (dcsr_d.prv != PRIV_LVL_U)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 511:             dcsr_d.prv = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 "> 512:           end</pre>
<pre style="margin:0; padding:0 "> 513: </pre>
<pre style="margin:0; padding:0 "> 514:           // currently not supported:</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 515:           dcsr_d.nmip = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 516:           dcsr_d.mprven = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 517:           dcsr_d.stopcount = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 518:           dcsr_d.stoptime = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 519: </pre>
<pre style="margin:0; padding:0 "> 520:           // forced to be zero</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 521:           dcsr_d.zero0 = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 522:           dcsr_d.zero1 = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 523:           dcsr_d.zero2 = 12'h0;</pre>
<pre style="margin:0; padding:0 "> 524:         end</pre>
<pre style="margin:0; padding:0 "> 525: </pre>
<pre style="margin:0; padding:0 "> 526:         // dpc: debug program counter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 527:         CSR_DPC: depc_d = {csr_wdata_int[31:1], 1'b0};</pre>
<pre style="margin:0; padding:0 "> 528: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 529:         CSR_DSCRATCH0: dscratch0_d = csr_wdata_int;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 530:         CSR_DSCRATCH1: dscratch1_d = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "> 531: </pre>
<pre style="margin:0; padding:0 "> 532:         // machine counter/timers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 533:         CSR_MCOUNTINHIBIT: mcountinhibit_we = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 534: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 535:         CSR_MCYCLE,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 536:         CSR_MINSTRET,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 537:         CSR_MHPMCOUNTER3,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 538:         CSR_MHPMCOUNTER4,  CSR_MHPMCOUNTER5,  CSR_MHPMCOUNTER6,  CSR_MHPMCOUNTER7,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 539:         CSR_MHPMCOUNTER8,  CSR_MHPMCOUNTER9,  CSR_MHPMCOUNTER10, CSR_MHPMCOUNTER11,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 540:         CSR_MHPMCOUNTER12, CSR_MHPMCOUNTER13, CSR_MHPMCOUNTER14, CSR_MHPMCOUNTER15,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 541:         CSR_MHPMCOUNTER16, CSR_MHPMCOUNTER17, CSR_MHPMCOUNTER18, CSR_MHPMCOUNTER19,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 542:         CSR_MHPMCOUNTER20, CSR_MHPMCOUNTER21, CSR_MHPMCOUNTER22, CSR_MHPMCOUNTER23,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 543:         CSR_MHPMCOUNTER24, CSR_MHPMCOUNTER25, CSR_MHPMCOUNTER26, CSR_MHPMCOUNTER27,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 544:         CSR_MHPMCOUNTER28, CSR_MHPMCOUNTER29, CSR_MHPMCOUNTER30, CSR_MHPMCOUNTER31: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 545:           mhpmcounter_we[mhpmcounter_idx] = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 546:         end</pre>
<pre style="margin:0; padding:0 "> 547: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 548:         CSR_MCYCLEH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 549:         CSR_MINSTRETH,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 550:         CSR_MHPMCOUNTER3H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 551:         CSR_MHPMCOUNTER4H,  CSR_MHPMCOUNTER5H,  CSR_MHPMCOUNTER6H,  CSR_MHPMCOUNTER7H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 552:         CSR_MHPMCOUNTER8H,  CSR_MHPMCOUNTER9H,  CSR_MHPMCOUNTER10H, CSR_MHPMCOUNTER11H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 553:         CSR_MHPMCOUNTER12H, CSR_MHPMCOUNTER13H, CSR_MHPMCOUNTER14H, CSR_MHPMCOUNTER15H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 554:         CSR_MHPMCOUNTER16H, CSR_MHPMCOUNTER17H, CSR_MHPMCOUNTER18H, CSR_MHPMCOUNTER19H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 555:         CSR_MHPMCOUNTER20H, CSR_MHPMCOUNTER21H, CSR_MHPMCOUNTER22H, CSR_MHPMCOUNTER23H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 556:         CSR_MHPMCOUNTER24H, CSR_MHPMCOUNTER25H, CSR_MHPMCOUNTER26H, CSR_MHPMCOUNTER27H,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 557:         CSR_MHPMCOUNTER28H, CSR_MHPMCOUNTER29H, CSR_MHPMCOUNTER30H, CSR_MHPMCOUNTER31H: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 558:           mhpmcounterh_we[mhpmcounter_idx] = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 559:         end</pre>
<pre style="margin:0; padding:0 "> 560: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 561:         default:;</pre>
<pre style="margin:0; padding:0 "> 562:       endcase</pre>
<pre style="margin:0; padding:0 "> 563:     end</pre>
<pre style="margin:0; padding:0 "> 564: </pre>
<pre style="margin:0; padding:0 "> 565:     // exception controller gets priority over other writes</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 566:     unique case (1'b1)</pre>
<pre style="margin:0; padding:0 "> 567: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 568:       csr_save_cause_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 569:         unique case (1'b1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 570:           csr_save_if_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 571:             exception_pc = pc_if_i;</pre>
<pre style="margin:0; padding:0 "> 572:           end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 573:           csr_save_id_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 574:             exception_pc = pc_id_i;</pre>
<pre style="margin:0; padding:0 "> 575:           end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 576:           csr_save_wb_i: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 577:             exception_pc = pc_wb_i;</pre>
<pre style="margin:0; padding:0 "> 578:           end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 579:           default:;</pre>
<pre style="margin:0; padding:0 "> 580:         endcase</pre>
<pre style="margin:0; padding:0 "> 581: </pre>
<pre style="margin:0; padding:0 "> 582:         // Any exception, including debug mode, causes a switch to M-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 583:         priv_lvl_d = PRIV_LVL_M;</pre>
<pre style="margin:0; padding:0 "> 584: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 585:         if (debug_csr_save_i) begin</pre>
<pre style="margin:0; padding:0 "> 586:           // all interrupts are masked</pre>
<pre style="margin:0; padding:0 "> 587:           // do not update cause, epc, tval, epc and status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 588:           dcsr_d.prv   = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 589:           dcsr_d.cause = debug_cause_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 590:           depc_d       = exception_pc;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 591:         end else if (!debug_mode_i) begin</pre>
<pre style="margin:0; padding:0 "> 592:           // In debug mode, "exceptions do not update any registers. That</pre>
<pre style="margin:0; padding:0 "> 593:           // includes cause, epc, tval, dpc and mstatus." [Debug Spec v0.13.2, p.39]</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 594:           mtval_d        = csr_mtval_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 595:           mstatus_d.mie  = 1'b0; // disable interrupts</pre>
<pre style="margin:0; padding:0 "> 596:           // save current status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 597:           mstatus_d.mpie = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 598:           mstatus_d.mpp  = priv_lvl_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 599:           mepc_d         = exception_pc;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 600:           mcause_d       = {csr_mcause_i};</pre>
<pre style="margin:0; padding:0 "> 601:           // save previous status for recoverable NMI</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 602:           mstack_d.mpie  = mstatus_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 603:           mstack_d.mpp   = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 604:           mstack_epc_d   = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 605:           mstack_cause_d = mcause_q;</pre>
<pre style="margin:0; padding:0 "> 606:         end</pre>
<pre style="margin:0; padding:0 "> 607:       end // csr_save_cause_i</pre>
<pre style="margin:0; padding:0 "> 608: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 609:       csr_restore_dret_i: begin // DRET</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 610:         priv_lvl_d = dcsr_q.prv;</pre>
<pre style="margin:0; padding:0 "> 611:       end // csr_restore_dret_i</pre>
<pre style="margin:0; padding:0 "> 612: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 613:       csr_restore_mret_i: begin // MRET</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 614:         priv_lvl_d     = mstatus_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 615:         mstatus_d.mie  = mstatus_q.mpie; // re-enable interrupts</pre>
<pre style="margin:0; padding:0 "> 616: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 617:         if (nmi_mode_i) begin</pre>
<pre style="margin:0; padding:0 "> 618:           // when returning from an NMI restore state from mstack CSR</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 619:           mstatus_d.mpie = mstack_q.mpie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 620:           mstatus_d.mpp  = mstack_q.mpp;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 621:           mepc_d         = mstack_epc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 622:           mcause_d       = mstack_cause_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 623:         end else begin</pre>
<pre style="margin:0; padding:0 "> 624:           // otherwise just set mstatus.MPIE/MPP</pre>
<pre style="margin:0; padding:0 "> 625:           // See RISC-V Privileged Specification, version 1.11, Section 3.1.6.1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 626:           mstatus_d.mpie = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 627:           mstatus_d.mpp  = PRIV_LVL_U;</pre>
<pre style="margin:0; padding:0 "> 628:         end</pre>
<pre style="margin:0; padding:0 "> 629:       end // csr_restore_mret_i</pre>
<pre style="margin:0; padding:0 "> 630: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 631:       default:;</pre>
<pre style="margin:0; padding:0 "> 632:     endcase</pre>
<pre style="margin:0; padding:0 "> 633:   end</pre>
<pre style="margin:0; padding:0 "> 634: </pre>
<pre style="margin:0; padding:0 "> 635:   // CSR operation logic</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 636:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 637:     unique case (csr_op_i)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 638:       CSR_OP_WRITE: csr_wdata_int =  csr_wdata_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 639:       CSR_OP_SET:   csr_wdata_int =  csr_wdata_i | csr_rdata_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 640:       CSR_OP_CLEAR: csr_wdata_int = ~csr_wdata_i & csr_rdata_o;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 641:       CSR_OP_READ:  csr_wdata_int = csr_wdata_i;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 642:       default:      csr_wdata_int = csr_wdata_i;</pre>
<pre style="margin:0; padding:0 "> 643:     endcase</pre>
<pre style="margin:0; padding:0 "> 644:   end</pre>
<pre style="margin:0; padding:0 "> 645: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 646:   assign csr_wreq = csr_op_en_i &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 647:     (csr_op_i inside {CSR_OP_WRITE,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 648:                       CSR_OP_SET,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 649:                       CSR_OP_CLEAR});</pre>
<pre style="margin:0; padding:0 "> 650: </pre>
<pre style="margin:0; padding:0 "> 651:   // only write CSRs during one clock cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 652:   assign csr_we_int  = csr_wreq & ~illegal_csr_insn_o;</pre>
<pre style="margin:0; padding:0 "> 653: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 654:   assign csr_rdata_o = csr_rdata_int;</pre>
<pre style="margin:0; padding:0 "> 655: </pre>
<pre style="margin:0; padding:0 "> 656:   // directly output some registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 657:   assign csr_mepc_o  = mepc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 658:   assign csr_depc_o  = depc_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 659:   assign csr_mtvec_o = mtvec_q;</pre>
<pre style="margin:0; padding:0 "> 660: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 661:   assign csr_mstatus_mie_o   = mstatus_q.mie;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 662:   assign csr_mstatus_tw_o    = mstatus_q.tw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 663:   assign debug_single_step_o = dcsr_q.step;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 664:   assign debug_ebreakm_o     = dcsr_q.ebreakm;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 665:   assign debug_ebreaku_o     = dcsr_q.ebreaku;</pre>
<pre style="margin:0; padding:0 "> 666: </pre>
<pre style="margin:0; padding:0 "> 667:   // Qualify incoming interrupt requests in mip CSR with mie CSR for controller and to re-enable</pre>
<pre style="margin:0; padding:0 "> 668:   // clock upon WFI (must be purely combinational).</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 669:   assign irqs_o        = mip & mie_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 670:   assign irq_pending_o = |irqs_o;</pre>
<pre style="margin:0; padding:0 "> 671: </pre>
<pre style="margin:0; padding:0 "> 672:   // actual registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 673:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 674:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 675:       priv_lvl_q     <= PRIV_LVL_M;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 676:       mstatus_q      <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 677:           mie:  1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 678:           mpie: 1'b1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 679:           mpp:  PRIV_LVL_U,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 680:           mprv: 1'b0,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 681:           tw:   1'b0</pre>
<pre style="margin:0; padding:0 "> 682:       };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 683:       mie_q          <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 684:       mscratch_q     <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 685:       mepc_q         <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 686:       mcause_q       <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 687:       mtval_q        <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 688:       mtvec_q        <= 32'b01;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 689:       dcsr_q         <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 690:           xdebugver: XDEBUGVER_STD,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 691:           cause:     DBG_CAUSE_NONE, // 3'h0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 692:           prv:       PRIV_LVL_M,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 693:           default:   '0</pre>
<pre style="margin:0; padding:0 "> 694:       };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 695:       depc_q         <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 696:       dscratch0_q    <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 697:       dscratch1_q    <= '0;</pre>
<pre style="margin:0; padding:0 "> 698: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 699:       mstack_q       <= '{</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 700:           mpie: 1'b1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 701:           mpp:  PRIV_LVL_U</pre>
<pre style="margin:0; padding:0 "> 702:       };</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 703:       mstack_epc_q   <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 704:       mstack_cause_q <= '0;</pre>
<pre style="margin:0; padding:0 "> 705: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 706:     end else begin</pre>
<pre style="margin:0; padding:0 "> 707:       // update CSRs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 708:       priv_lvl_q     <= priv_lvl_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 709:       mstatus_q      <= mstatus_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 710:       mie_q          <= mie_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 711:       mscratch_q     <= mscratch_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 712:       mepc_q         <= mepc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 713:       mcause_q       <= mcause_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 714:       mtval_q        <= mtval_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 715:       mtvec_q        <= mtvec_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 716:       dcsr_q         <= dcsr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 717:       depc_q         <= depc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 718:       dscratch0_q    <= dscratch0_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 719:       dscratch1_q    <= dscratch1_d;</pre>
<pre style="margin:0; padding:0 "> 720: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 721:       mstack_q       <= mstack_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 722:       mstack_epc_q   <= mstack_epc_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 723:       mstack_cause_q <= mstack_cause_d;</pre>
<pre style="margin:0; padding:0 "> 724: </pre>
<pre style="margin:0; padding:0 "> 725:     end</pre>
<pre style="margin:0; padding:0 "> 726:   end</pre>
<pre style="margin:0; padding:0 "> 727: </pre>
<pre style="margin:0; padding:0 "> 728:   // Send current priv level to the decoder</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 729:   assign priv_mode_id_o = priv_lvl_q;</pre>
<pre style="margin:0; padding:0 "> 730:   // New instruction fetches need to account for updates to priv_lvl_q this cycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 731:   assign priv_mode_if_o = priv_lvl_d;</pre>
<pre style="margin:0; padding:0 "> 732:   // Load/store instructions must factor in MPRV for PMP checking</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 733:   assign priv_mode_lsu_o = mstatus_q.mprv ? mstatus_q.mpp : priv_lvl_q;</pre>
<pre style="margin:0; padding:0 "> 734: </pre>
<pre style="margin:0; padding:0 "> 735:   // -----------------</pre>
<pre style="margin:0; padding:0 "> 736:   // PMP registers</pre>
<pre style="margin:0; padding:0 "> 737:   // -----------------</pre>
<pre style="margin:0; padding:0 "> 738: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 739:   if (PMPEnable) begin : g_pmp_registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 740:     pmp_cfg_t                    pmp_cfg         [PMPNumRegions];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 741:     pmp_cfg_t                    pmp_cfg_wdata   [PMPNumRegions];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 742:     logic [31:0]                 pmp_addr        [PMPNumRegions];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 743:     logic [PMPNumRegions-1:0]    pmp_cfg_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 744:     logic [PMPNumRegions-1:0]    pmp_addr_we;</pre>
<pre style="margin:0; padding:0 "> 745: </pre>
<pre style="margin:0; padding:0 "> 746:     // Expanded / qualified register read data</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 747:     for (genvar i = 0; i < PMP_MAX_REGIONS; i++) begin : g_exp_rd_data</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 748:       if (i < PMPNumRegions) begin : g_implemented_regions</pre>
<pre style="margin:0; padding:0 "> 749:         // Add in zero padding for reserved fields</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 750:         assign pmp_cfg_rdata[i] = {pmp_cfg[i].lock, 2'b00, pmp_cfg[i].mode,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 751:                                    pmp_cfg[i].exec, pmp_cfg[i].write, pmp_cfg[i].read};</pre>
<pre style="margin:0; padding:0 "> 752: </pre>
<pre style="margin:0; padding:0 "> 753:         // Address field read data depends on the current programmed mode and the granularity</pre>
<pre style="margin:0; padding:0 "> 754:         // See RISC-V Privileged Specification, version 1.11, Section 3.6.1</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 755:         if (PMPGranularity == 0) begin : g_pmp_g0</pre>
<pre style="margin:0; padding:0 "> 756:           // If G == 0, read data is unmodified</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 757:           assign pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre style="margin:0; padding:0 "> 758: </pre>
<pre id="id759" style="background-color: #FFB6C1; margin:0; padding:0 "> 759:         end else if (PMPGranularity == 1) begin : g_pmp_g1</pre>
<pre style="margin:0; padding:0 "> 760:           // If G == 1, bit [G-1] reads as zero in TOR or OFF mode</pre>
<pre id="id761" style="background-color: #FFB6C1; margin:0; padding:0 "> 761:           always_comb begin</pre>
<pre id="id762" style="background-color: #FFB6C1; margin:0; padding:0 "> 762:             pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre id="id763" style="background-color: #FFB6C1; margin:0; padding:0 "> 763:             if ((pmp_cfg[i].mode == PMP_MODE_OFF) || (pmp_cfg[i].mode == PMP_MODE_TOR)) begin</pre>
<pre id="id764" style="background-color: #FFB6C1; margin:0; padding:0 "> 764:               pmp_addr_rdata[i][PMPGranularity-1:0] = '0;</pre>
<pre style="margin:0; padding:0 "> 765:             end</pre>
<pre style="margin:0; padding:0 "> 766:           end</pre>
<pre style="margin:0; padding:0 "> 767: </pre>
<pre id="id768" style="background-color: #FFB6C1; margin:0; padding:0 "> 768:         end else begin : g_pmp_g2</pre>
<pre style="margin:0; padding:0 "> 769:           // For G >= 2, bits are masked to one or zero depending on the mode</pre>
<pre id="id770" style="background-color: #FFB6C1; margin:0; padding:0 "> 770:           always_comb begin</pre>
<pre id="id771" style="background-color: #FFB6C1; margin:0; padding:0 "> 771:             pmp_addr_rdata[i] = pmp_addr[i];</pre>
<pre id="id772" style="background-color: #FFB6C1; margin:0; padding:0 "> 772:             if ((pmp_cfg[i].mode == PMP_MODE_OFF) || (pmp_cfg[i].mode == PMP_MODE_TOR)) begin</pre>
<pre style="margin:0; padding:0 "> 773:               // In TOR or OFF mode, bits [G-1:0] must read as zero</pre>
<pre id="id774" style="background-color: #FFB6C1; margin:0; padding:0 "> 774:               pmp_addr_rdata[i][PMPGranularity-1:0] = '0;</pre>
<pre id="id775" style="background-color: #FFB6C1; margin:0; padding:0 "> 775:             end else if (pmp_cfg[i].mode == PMP_MODE_NAPOT) begin</pre>
<pre style="margin:0; padding:0 "> 776:               // In NAPOT mode, bits [G-2:0] must read as one</pre>
<pre id="id777" style="background-color: #FFB6C1; margin:0; padding:0 "> 777:               pmp_addr_rdata[i][PMPGranularity-2:0] = '1;</pre>
<pre style="margin:0; padding:0 "> 778:             end</pre>
<pre style="margin:0; padding:0 "> 779:           end</pre>
<pre style="margin:0; padding:0 "> 780:         end</pre>
<pre style="margin:0; padding:0 "> 781: </pre>
<pre id="id782" style="background-color: #FFB6C1; margin:0; padding:0 "> 782:       end else begin : g_other_regions</pre>
<pre style="margin:0; padding:0 "> 783:         // Non-implemented regions read as zero</pre>
<pre id="id784" style="background-color: #FFB6C1; margin:0; padding:0 "> 784:         assign pmp_cfg_rdata[i]  = '0;</pre>
<pre id="id785" style="background-color: #FFB6C1; margin:0; padding:0 "> 785:         assign pmp_addr_rdata[i] = '0;</pre>
<pre style="margin:0; padding:0 "> 786:       end</pre>
<pre style="margin:0; padding:0 "> 787:     end</pre>
<pre style="margin:0; padding:0 "> 788: </pre>
<pre style="margin:0; padding:0 "> 789:     // Write data calculation</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 790:     for (genvar i = 0; i < PMPNumRegions; i++) begin : g_pmp_csrs</pre>
<pre style="margin:0; padding:0 "> 791:       // -------------------------</pre>
<pre style="margin:0; padding:0 "> 792:       // Instantiate cfg registers</pre>
<pre style="margin:0; padding:0 "> 793:       // -------------------------</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 794:       assign pmp_cfg_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 795:                              (csr_addr == (CSR_OFF_PMP_CFG + (i[11:0] >> 2)));</pre>
<pre style="margin:0; padding:0 "> 796: </pre>
<pre style="margin:0; padding:0 "> 797:       // Select the correct WDATA (each CSR contains 4 CFG fields, each with 2 RES bits)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 798:       assign pmp_cfg_wdata[i].lock  = csr_wdata_int[(i%4)*PMP_CFG_W+7];</pre>
<pre style="margin:0; padding:0 "> 799:       // NA4 mode is not selectable when G > 0, mode is treated as OFF</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 800:       always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 801:         unique case (csr_wdata_int[(i%4)*PMP_CFG_W+3+:2])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 802:           2'b00   : pmp_cfg_wdata[i].mode = PMP_MODE_OFF;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 803:           2'b01   : pmp_cfg_wdata[i].mode = PMP_MODE_TOR;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 804:           2'b10   : pmp_cfg_wdata[i].mode = (PMPGranularity == 0) ? PMP_MODE_NA4:</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 805:                                                                     PMP_MODE_OFF;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 806:           2'b11   : pmp_cfg_wdata[i].mode = PMP_MODE_NAPOT;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 807:           default : pmp_cfg_wdata[i].mode = PMP_MODE_OFF;</pre>
<pre style="margin:0; padding:0 "> 808:         endcase</pre>
<pre style="margin:0; padding:0 "> 809:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 810:       assign pmp_cfg_wdata[i].exec  = csr_wdata_int[(i%4)*PMP_CFG_W+2];</pre>
<pre style="margin:0; padding:0 "> 811:       // W = 1, R = 0 is a reserved combination. For now, we force W to 0 if R == 0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 812:       assign pmp_cfg_wdata[i].write = &csr_wdata_int[(i%4)*PMP_CFG_W+:2];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 813:       assign pmp_cfg_wdata[i].read  = csr_wdata_int[(i%4)*PMP_CFG_W];</pre>
<pre style="margin:0; padding:0 "> 814: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 815:       always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 816:         if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 817:           pmp_cfg[i] <= pmp_cfg_t'('b0);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 818:         end else if (pmp_cfg_we[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 819:           pmp_cfg[i] <= pmp_cfg_wdata[i];</pre>
<pre style="margin:0; padding:0 "> 820:         end</pre>
<pre style="margin:0; padding:0 "> 821:       end</pre>
<pre style="margin:0; padding:0 "> 822: </pre>
<pre style="margin:0; padding:0 "> 823:       // --------------------------</pre>
<pre style="margin:0; padding:0 "> 824:       // Instantiate addr registers</pre>
<pre style="margin:0; padding:0 "> 825:       // --------------------------</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 826:       if (i < PMPNumRegions - 1) begin : g_lower</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 827:         assign pmp_addr_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 828:                                 (pmp_cfg[i+1].mode != PMP_MODE_TOR) &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 829:                                 (csr_addr == (CSR_OFF_PMP_ADDR + i[11:0]));</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 830:       end else begin : g_upper</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 831:         assign pmp_addr_we[i] = csr_we_int & ~pmp_cfg[i].lock &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 832:                                 (csr_addr == (CSR_OFF_PMP_ADDR + i[11:0]));</pre>
<pre style="margin:0; padding:0 "> 833:       end</pre>
<pre style="margin:0; padding:0 "> 834: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 835:       always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 836:         if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 837:           pmp_addr[i] <= 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 838:         end else if (pmp_addr_we[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 839:           pmp_addr[i] <= csr_wdata_int;</pre>
<pre style="margin:0; padding:0 "> 840:         end</pre>
<pre style="margin:0; padding:0 "> 841:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 842:       assign csr_pmp_cfg_o[i]  = pmp_cfg[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 843:       assign csr_pmp_addr_o[i] = {pmp_addr[i],2'b00};</pre>
<pre style="margin:0; padding:0 "> 844:     end</pre>
<pre style="margin:0; padding:0 "> 845: </pre>
<pre id="id846" style="background-color: #FFB6C1; margin:0; padding:0 "> 846:   end else begin : g_no_pmp_tieoffs</pre>
<pre style="margin:0; padding:0 "> 847:     // Generate tieoffs when PMP is not configured</pre>
<pre id="id848" style="background-color: #FFB6C1; margin:0; padding:0 "> 848:     for (genvar i = 0; i < PMP_MAX_REGIONS; i++) begin : g_rdata</pre>
<pre id="id849" style="background-color: #FFB6C1; margin:0; padding:0 "> 849:       assign pmp_addr_rdata[i] = '0;</pre>
<pre id="id850" style="background-color: #FFB6C1; margin:0; padding:0 "> 850:       assign pmp_cfg_rdata[i]  = '0;</pre>
<pre style="margin:0; padding:0 "> 851:     end</pre>
<pre id="id852" style="background-color: #FFB6C1; margin:0; padding:0 "> 852:     for (genvar i = 0; i < PMPNumRegions; i++) begin : g_outputs</pre>
<pre id="id853" style="background-color: #FFB6C1; margin:0; padding:0 "> 853:       assign csr_pmp_cfg_o[i]  = pmp_cfg_t'(1'b0);</pre>
<pre id="id854" style="background-color: #FFB6C1; margin:0; padding:0 "> 854:       assign csr_pmp_addr_o[i] = '0;</pre>
<pre style="margin:0; padding:0 "> 855:     end</pre>
<pre style="margin:0; padding:0 "> 856:   end</pre>
<pre style="margin:0; padding:0 "> 857: </pre>
<pre style="margin:0; padding:0 "> 858:   //////////////////////////</pre>
<pre style="margin:0; padding:0 "> 859:   //  Performance monitor //</pre>
<pre style="margin:0; padding:0 "> 860:   //////////////////////////</pre>
<pre style="margin:0; padding:0 "> 861: </pre>
<pre style="margin:0; padding:0 "> 862:   // update enable signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 863:   always_comb begin : mcountinhibit_update</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 864:     if (mcountinhibit_we == 1'b1) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 865:       mcountinhibit_d = {csr_wdata_int[MHPMCounterNum+2:2], 1'b0, csr_wdata_int[0]}; // bit 1 must always be 0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 866:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 867:       mcountinhibit_d = mcountinhibit_q;</pre>
<pre style="margin:0; padding:0 "> 868:     end</pre>
<pre style="margin:0; padding:0 "> 869:   end</pre>
<pre style="margin:0; padding:0 "> 870: </pre>
<pre style="margin:0; padding:0 "> 871:   // event selection (hardwired) & control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 872:   always_comb begin : gen_mhpmcounter_incr</pre>
<pre style="margin:0; padding:0 "> 873: </pre>
<pre style="margin:0; padding:0 "> 874:     // Assign inactive counters (first to prevent latch inference)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 875:     for (int unsigned i=0; i<32; i++) begin : gen_mhpmcounter_incr_inactive</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 876:       mhpmcounter_incr[i] = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 877:     end</pre>
<pre style="margin:0; padding:0 "> 878: </pre>
<pre style="margin:0; padding:0 "> 879:     // When adding or altering performance counter meanings and default</pre>
<pre style="margin:0; padding:0 "> 880:     // mappings please update dv/verilator/pcount/cpp/ibex_pcounts.cc</pre>
<pre style="margin:0; padding:0 "> 881:     // appropriately.</pre>
<pre style="margin:0; padding:0 "> 882:     //</pre>
<pre style="margin:0; padding:0 "> 883:     // active counters</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 884:     mhpmcounter_incr[0]  = 1'b1;                   // mcycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 885:     mhpmcounter_incr[1]  = 1'b0;                   // reserved</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 886:     mhpmcounter_incr[2]  = instr_ret_i;            // minstret</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 887:     mhpmcounter_incr[3]  = dside_wait_i;           // cycles waiting for data memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 888:     mhpmcounter_incr[4]  = iside_wait_i;           // cycles waiting for instr fetches</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 889:     mhpmcounter_incr[5]  = mem_load_i;             // num of loads</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 890:     mhpmcounter_incr[6]  = mem_store_i;            // num of stores</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 891:     mhpmcounter_incr[7]  = jump_i;                 // num of jumps (unconditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 892:     mhpmcounter_incr[8]  = branch_i;               // num of branches (conditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 893:     mhpmcounter_incr[9]  = branch_taken_i;         // num of taken branches (conditional)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 894:     mhpmcounter_incr[10] = instr_ret_compressed_i; // num of compressed instr</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 895:     mhpmcounter_incr[11] = mul_wait_i;             // cycles waiting for multiply</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 896:     mhpmcounter_incr[12] = div_wait_i;             // cycles waiting for divide</pre>
<pre style="margin:0; padding:0 "> 897:   end</pre>
<pre style="margin:0; padding:0 "> 898: </pre>
<pre style="margin:0; padding:0 "> 899:   // event selector (hardwired, 0 means no event)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 900:   always_comb begin : gen_mhpmevent</pre>
<pre style="margin:0; padding:0 "> 901: </pre>
<pre style="margin:0; padding:0 "> 902:     // activate all</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 903:     for (int i=0; i<32; i++) begin : gen_mhpmevent_active</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 904:       mhpmevent[i]    =   '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 905:       mhpmevent[i][i] = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 906:     end</pre>
<pre style="margin:0; padding:0 "> 907: </pre>
<pre style="margin:0; padding:0 "> 908:     // deactivate</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 909:     mhpmevent[1] = '0; // not existing, reserved</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 910:     for (int unsigned i=3+MHPMCounterNum; i<32; i++) begin : gen_mhpmevent_inactive</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 911:       mhpmevent[i] = '0;</pre>
<pre style="margin:0; padding:0 "> 912:     end</pre>
<pre style="margin:0; padding:0 "> 913:   end</pre>
<pre style="margin:0; padding:0 "> 914: </pre>
<pre style="margin:0; padding:0 "> 915:   // mcycle</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 916:   ibex_counter #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 917:     .CounterWidth(64)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 918:   ) mcycle_counter_i (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 919:     .clk_i(clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 920:     .rst_ni(rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 921:     .counter_inc_i(mhpmcounter_incr[0] & ~mcountinhibit[0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 922:     .counterh_we_i(mhpmcounterh_we[0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 923:     .counter_we_i(mhpmcounter_we[0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 924:     .counter_val_i(csr_wdata_int),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 925:     .counter_val_o(mhpmcounter[0])</pre>
<pre style="margin:0; padding:0 "> 926:   );</pre>
<pre style="margin:0; padding:0 "> 927: </pre>
<pre style="margin:0; padding:0 "> 928:   // minstret</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 929:   ibex_counter #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 930:     .CounterWidth(64)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 931:   ) minstret_counter_i (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 932:     .clk_i(clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 933:     .rst_ni(rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 934:     .counter_inc_i(mhpmcounter_incr[2] & ~mcountinhibit[2]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 935:     .counterh_we_i(mhpmcounterh_we[2]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 936:     .counter_we_i(mhpmcounter_we[2]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 937:     .counter_val_i(csr_wdata_int),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 938:     .counter_val_o(mhpmcounter[2])</pre>
<pre style="margin:0; padding:0 "> 939:   );</pre>
<pre style="margin:0; padding:0 "> 940: </pre>
<pre style="margin:0; padding:0 "> 941:   // reserved:</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 942:   assign mhpmcounter[1] = '0;</pre>
<pre style="margin:0; padding:0 "> 943: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 944:   for (genvar cnt=0; cnt < MHPMCounterNum; cnt++) begin : gen_cntrs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 945:     ibex_counter #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 946:       .CounterWidth(MHPMCounterWidth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 947:     ) mcounters_variable_i (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 948:       .clk_i(clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 949:       .rst_ni(rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 950:       .counter_inc_i(mhpmcounter_incr[cnt+3] & ~mcountinhibit[cnt+3]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 951:       .counterh_we_i(mhpmcounterh_we[cnt+3]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 952:       .counter_we_i(mhpmcounter_we[cnt+3]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 953:       .counter_val_i(csr_wdata_int),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 954:       .counter_val_o(mhpmcounter[cnt+3])</pre>
<pre style="margin:0; padding:0 "> 955:     );</pre>
<pre style="margin:0; padding:0 "> 956:   end</pre>
<pre style="margin:0; padding:0 "> 957: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 958:   if(MHPMCounterNum < 29) begin : g_mcountinhibit_reduced</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 959:     logic [29-MHPMCounterNum-1:0] unused_mhphcounter_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 960:     logic [29-MHPMCounterNum-1:0] unused_mhphcounterh_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 961:     logic [29-MHPMCounterNum-1:0] unused_mhphcounter_incr;</pre>
<pre style="margin:0; padding:0 "> 962: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 963:     assign mcountinhibit = {{29-MHPMCounterNum{1'b1}}, mcountinhibit_q};</pre>
<pre style="margin:0; padding:0 "> 964:     // Lint tieoffs for unused bits</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 965:     assign unused_mhphcounter_we   = mhpmcounter_we[31:MHPMCounterNum+3];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 966:     assign unused_mhphcounterh_we  = mhpmcounterh_we[31:MHPMCounterNum+3];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 967:     assign unused_mhphcounter_incr = mhpmcounter_incr[31:MHPMCounterNum+3];</pre>
<pre id="id968" style="background-color: #FFB6C1; margin:0; padding:0 "> 968:   end else begin : g_mcountinhibit_full</pre>
<pre id="id969" style="background-color: #FFB6C1; margin:0; padding:0 "> 969:     assign mcountinhibit = mcountinhibit_q;</pre>
<pre style="margin:0; padding:0 "> 970:   end</pre>
<pre style="margin:0; padding:0 "> 971: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 972:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 973:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 974:       mcountinhibit_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 975:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 976:       mcountinhibit_q <= mcountinhibit_d;</pre>
<pre style="margin:0; padding:0 "> 977:     end</pre>
<pre style="margin:0; padding:0 "> 978:   end</pre>
<pre style="margin:0; padding:0 "> 979: </pre>
<pre style="margin:0; padding:0 "> 980:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 981:   // Debug trigger registers //</pre>
<pre style="margin:0; padding:0 "> 982:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 983: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 984:   if (DbgTriggerEn) begin : gen_trigger_regs</pre>
<pre style="margin:0; padding:0 "> 985:     // Register values</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 986:     logic        tmatch_control_d, tmatch_control_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 987:     logic [31:0] tmatch_value_d, tmatch_value_q;</pre>
<pre style="margin:0; padding:0 "> 988:     // Write enables</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 989:     logic tmatch_control_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 990:     logic tmatch_value_we;</pre>
<pre style="margin:0; padding:0 "> 991: </pre>
<pre style="margin:0; padding:0 "> 992:     // Write select</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 993:     assign tmatch_control_we = csr_we_int & debug_mode_i & (csr_addr_i == CSR_TDATA1);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 994:     assign tmatch_value_we   = csr_we_int & debug_mode_i & (csr_addr_i == CSR_TDATA2);</pre>
<pre style="margin:0; padding:0 "> 995: </pre>
<pre style="margin:0; padding:0 "> 996:     // tmatch_control is enabled when the execute bit is set</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 997:     assign tmatch_control_d = tmatch_control_we ? csr_wdata_int[2] :</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 998:                                                   tmatch_control_q;</pre>
<pre style="margin:0; padding:0 "> 999:     // tmatch_value has its own clock gate</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1000:     assign tmatch_value_d   = csr_wdata_int[31:0];</pre>
<pre style="margin:0; padding:0 ">1001: </pre>
<pre style="margin:0; padding:0 ">1002:     // Registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1003:     always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1004:       if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1005:         tmatch_control_q <= 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1006:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1007:         tmatch_control_q <= tmatch_control_d;</pre>
<pre style="margin:0; padding:0 ">1008:       end</pre>
<pre style="margin:0; padding:0 ">1009:     end</pre>
<pre style="margin:0; padding:0 ">1010: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1011:     always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1012:       if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1013:         tmatch_value_q <= 'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1014:       end else if (tmatch_value_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1015:         tmatch_value_q <= tmatch_value_d;</pre>
<pre style="margin:0; padding:0 ">1016:       end</pre>
<pre style="margin:0; padding:0 ">1017:     end</pre>
<pre style="margin:0; padding:0 ">1018: </pre>
<pre style="margin:0; padding:0 ">1019:     // Assign read data</pre>
<pre style="margin:0; padding:0 ">1020:     // TSELECT - only one supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1021:     assign tselect_rdata = 'b0;</pre>
<pre style="margin:0; padding:0 ">1022:     // TDATA0 - only support simple address matching</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1023:     assign tmatch_control_rdata = {4'h2,              // type    : address/data match</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1024:                                    1'b1,              // dmode   : access from D mode only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1025:                                    6'h00,             // maskmax : exact match only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1026:                                    1'b0,              // hit     : not supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1027:                                    1'b0,              // select  : address match only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1028:                                    1'b0,              // timing  : match before execution</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1029:                                    2'b00,             // sizelo  : match any access</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1030:                                    4'h1,              // action  : enter debug mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1031:                                    1'b0,              // chain   : not supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1032:                                    4'h0,              // match   : simple match</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1033:                                    1'b1,              // m       : match in m-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1034:                                    1'b0,              // 0       : zero</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1035:                                    1'b0,              // s       : not supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1036:                                    1'b1,              // u       : match in u-mode</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1037:                                    tmatch_control_q,  // execute : match instruction address</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1038:                                    1'b0,              // store   : not supported</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1039:                                    1'b0};             // load    : not supported</pre>
<pre style="margin:0; padding:0 ">1040:     // TDATA1 - address match value only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1041:     assign tmatch_value_rdata = tmatch_value_q;</pre>
<pre style="margin:0; padding:0 ">1042: </pre>
<pre style="margin:0; padding:0 ">1043:     // Breakpoint matching</pre>
<pre style="margin:0; padding:0 ">1044:     // We match against the next address, as the breakpoint must be taken before execution</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1045:     assign trigger_match_o = tmatch_control_q & (pc_if_i[31:0] == tmatch_value_q[31:0]);</pre>
<pre style="margin:0; padding:0 ">1046: </pre>
<pre id="id1047" style="background-color: #FFB6C1; margin:0; padding:0 ">1047:   end else begin : gen_no_trigger_regs</pre>
<pre id="id1048" style="background-color: #FFB6C1; margin:0; padding:0 ">1048:     assign tselect_rdata        = 'b0;</pre>
<pre id="id1049" style="background-color: #FFB6C1; margin:0; padding:0 ">1049:     assign tmatch_control_rdata = 'b0;</pre>
<pre id="id1050" style="background-color: #FFB6C1; margin:0; padding:0 ">1050:     assign tmatch_value_rdata   = 'b0;</pre>
<pre id="id1051" style="background-color: #FFB6C1; margin:0; padding:0 ">1051:     assign trigger_match_o      = 'b0;</pre>
<pre style="margin:0; padding:0 ">1052:   end</pre>
<pre style="margin:0; padding:0 ">1053: </pre>
<pre style="margin:0; padding:0 ">1054:   // CPU control fields</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1055:   assign cpuctrl_rdata.unused_ctrl = '0;</pre>
<pre style="margin:0; padding:0 ">1056:   // Cast register write data</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1057:   assign cpuctrl_wdata = CpuCtrl_t'(csr_wdata_int);</pre>
<pre style="margin:0; padding:0 ">1058: </pre>
<pre style="margin:0; padding:0 ">1059:   // Generate fixed time execution bit</pre>
<pre id="id1060" style="background-color: #FFB6C1; margin:0; padding:0 ">1060:   if (DataIndTiming) begin : gen_dit</pre>
<pre id="id1061" style="background-color: #FFB6C1; margin:0; padding:0 ">1061:     logic data_ind_timing_d, data_ind_timing_q;</pre>
<pre style="margin:0; padding:0 ">1062: </pre>
<pre id="id1063" style="background-color: #FFB6C1; margin:0; padding:0 ">1063:     assign data_ind_timing_d = (csr_we_int && (csr_addr == CSR_CPUCTRL)) ?</pre>
<pre id="id1064" style="background-color: #FFB6C1; margin:0; padding:0 ">1064:       cpuctrl_wdata.data_ind_timing : data_ind_timing_q;</pre>
<pre style="margin:0; padding:0 ">1065: </pre>
<pre id="id1066" style="background-color: #FFB6C1; margin:0; padding:0 ">1066:     always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id1067" style="background-color: #FFB6C1; margin:0; padding:0 ">1067:       if (!rst_ni) begin</pre>
<pre id="id1068" style="background-color: #FFB6C1; margin:0; padding:0 ">1068:         data_ind_timing_q <= 1'b0; // disabled on reset</pre>
<pre id="id1069" style="background-color: #FFB6C1; margin:0; padding:0 ">1069:       end else begin</pre>
<pre id="id1070" style="background-color: #FFB6C1; margin:0; padding:0 ">1070:         data_ind_timing_q <= data_ind_timing_d;</pre>
<pre style="margin:0; padding:0 ">1071:       end</pre>
<pre style="margin:0; padding:0 ">1072:     end</pre>
<pre style="margin:0; padding:0 ">1073: </pre>
<pre id="id1074" style="background-color: #FFB6C1; margin:0; padding:0 ">1074:     assign cpuctrl_rdata.data_ind_timing = data_ind_timing_q;</pre>
<pre style="margin:0; padding:0 ">1075: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1076:   end else begin : gen_no_dit</pre>
<pre style="margin:0; padding:0 ">1077:     // tieoff for the unused bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1078:     logic unused_dit;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1079:     assign unused_dit = cpuctrl_wdata.data_ind_timing;</pre>
<pre style="margin:0; padding:0 ">1080: </pre>
<pre style="margin:0; padding:0 ">1081:     // field will always read as zero if not configured</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1082:     assign cpuctrl_rdata.data_ind_timing = 1'b0;</pre>
<pre style="margin:0; padding:0 ">1083:   end</pre>
<pre style="margin:0; padding:0 ">1084: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1085:   assign data_ind_timing_o = cpuctrl_rdata.data_ind_timing;</pre>
<pre style="margin:0; padding:0 ">1086: </pre>
<pre style="margin:0; padding:0 ">1087:   // Generate dummy instruction signals</pre>
<pre id="id1088" style="background-color: #FFB6C1; margin:0; padding:0 ">1088:   if (DummyInstructions) begin : gen_dummy</pre>
<pre id="id1089" style="background-color: #FFB6C1; margin:0; padding:0 ">1089:     logic       dummy_instr_en_d, dummy_instr_en_q;</pre>
<pre id="id1090" style="background-color: #FFB6C1; margin:0; padding:0 ">1090:     logic [2:0] dummy_instr_mask_d, dummy_instr_mask_q;</pre>
<pre style="margin:0; padding:0 ">1091: </pre>
<pre id="id1092" style="background-color: #FFB6C1; margin:0; padding:0 ">1092:     assign dummy_instr_en_d   = (csr_we_int && (csr_addr == CSR_CPUCTRL)) ?</pre>
<pre id="id1093" style="background-color: #FFB6C1; margin:0; padding:0 ">1093:         cpuctrl_wdata.dummy_instr_en : dummy_instr_en_q;</pre>
<pre style="margin:0; padding:0 ">1094: </pre>
<pre id="id1095" style="background-color: #FFB6C1; margin:0; padding:0 ">1095:     assign dummy_instr_mask_d = (csr_we_int && (csr_addr == CSR_CPUCTRL)) ?</pre>
<pre id="id1096" style="background-color: #FFB6C1; margin:0; padding:0 ">1096:         cpuctrl_wdata.dummy_instr_mask : dummy_instr_mask_q;</pre>
<pre style="margin:0; padding:0 ">1097: </pre>
<pre id="id1098" style="background-color: #FFB6C1; margin:0; padding:0 ">1098:     always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id1099" style="background-color: #FFB6C1; margin:0; padding:0 ">1099:       if (!rst_ni) begin</pre>
<pre id="id1100" style="background-color: #FFB6C1; margin:0; padding:0 ">1100:         dummy_instr_en_q   <= 1'b0; // disabled on reset</pre>
<pre id="id1101" style="background-color: #FFB6C1; margin:0; padding:0 ">1101:         dummy_instr_mask_q <= 3'b000;</pre>
<pre id="id1102" style="background-color: #FFB6C1; margin:0; padding:0 ">1102:       end else begin</pre>
<pre id="id1103" style="background-color: #FFB6C1; margin:0; padding:0 ">1103:         dummy_instr_en_q   <= dummy_instr_en_d;</pre>
<pre id="id1104" style="background-color: #FFB6C1; margin:0; padding:0 ">1104:         dummy_instr_mask_q <= dummy_instr_mask_d;</pre>
<pre style="margin:0; padding:0 ">1105:       end</pre>
<pre style="margin:0; padding:0 ">1106:     end</pre>
<pre style="margin:0; padding:0 ">1107: </pre>
<pre id="id1108" style="background-color: #FFB6C1; margin:0; padding:0 ">1108:     assign cpuctrl_rdata.dummy_instr_en   = dummy_instr_en_q;</pre>
<pre id="id1109" style="background-color: #FFB6C1; margin:0; padding:0 ">1109:     assign cpuctrl_rdata.dummy_instr_mask = dummy_instr_mask_q;</pre>
<pre style="margin:0; padding:0 ">1110:     // Signal a write to the seed register</pre>
<pre id="id1111" style="background-color: #FFB6C1; margin:0; padding:0 ">1111:     assign dummy_instr_seed_en_o = csr_we_int && (csr_addr == CSR_SECURESEED);</pre>
<pre id="id1112" style="background-color: #FFB6C1; margin:0; padding:0 ">1112:     assign dummy_instr_seed_o    = csr_wdata_int;</pre>
<pre style="margin:0; padding:0 ">1113: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1114:   end else begin : gen_no_dummy</pre>
<pre style="margin:0; padding:0 ">1115:     // tieoff for the unused bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1116:     logic       unused_dummy_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1117:     logic [2:0] unused_dummy_mask;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1118:     assign unused_dummy_en   = cpuctrl_wdata.dummy_instr_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1119:     assign unused_dummy_mask = cpuctrl_wdata.dummy_instr_mask;</pre>
<pre style="margin:0; padding:0 ">1120: </pre>
<pre style="margin:0; padding:0 ">1121:     // field will always read as zero if not configured</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1122:     assign cpuctrl_rdata.dummy_instr_en   = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1123:     assign cpuctrl_rdata.dummy_instr_mask = 3'b000;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1124:     assign dummy_instr_seed_en_o          = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1125:     assign dummy_instr_seed_o             = '0;</pre>
<pre style="margin:0; padding:0 ">1126:   end</pre>
<pre style="margin:0; padding:0 ">1127: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1128:   assign dummy_instr_en_o   = cpuctrl_rdata.dummy_instr_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1129:   assign dummy_instr_mask_o = cpuctrl_rdata.dummy_instr_mask;</pre>
<pre style="margin:0; padding:0 ">1130: </pre>
<pre style="margin:0; padding:0 ">1131:   // Generate icache enable bit</pre>
<pre id="id1132" style="background-color: #FFB6C1; margin:0; padding:0 ">1132:   if (ICache) begin : gen_icache_enable</pre>
<pre id="id1133" style="background-color: #FFB6C1; margin:0; padding:0 ">1133:     logic icache_enable_d, icache_enable_q;</pre>
<pre style="margin:0; padding:0 ">1134: </pre>
<pre style="margin:0; padding:0 ">1135:     // Update the value when cpuctrl register is written</pre>
<pre id="id1136" style="background-color: #FFB6C1; margin:0; padding:0 ">1136:     assign icache_enable_d = (csr_we_int & (csr_addr == CSR_CPUCTRL)) ?</pre>
<pre id="id1137" style="background-color: #FFB6C1; margin:0; padding:0 ">1137:         cpuctrl_wdata.icache_enable : icache_enable_q;</pre>
<pre style="margin:0; padding:0 ">1138: </pre>
<pre id="id1139" style="background-color: #FFB6C1; margin:0; padding:0 ">1139:     always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre id="id1140" style="background-color: #FFB6C1; margin:0; padding:0 ">1140:       if (!rst_ni) begin</pre>
<pre id="id1141" style="background-color: #FFB6C1; margin:0; padding:0 ">1141:         icache_enable_q <= 1'b0; // disabled on reset</pre>
<pre id="id1142" style="background-color: #FFB6C1; margin:0; padding:0 ">1142:       end else begin</pre>
<pre id="id1143" style="background-color: #FFB6C1; margin:0; padding:0 ">1143:         icache_enable_q <= icache_enable_d;</pre>
<pre style="margin:0; padding:0 ">1144:       end</pre>
<pre style="margin:0; padding:0 ">1145:     end</pre>
<pre style="margin:0; padding:0 ">1146: </pre>
<pre id="id1147" style="background-color: #FFB6C1; margin:0; padding:0 ">1147:     assign cpuctrl_rdata.icache_enable = icache_enable_q;</pre>
<pre style="margin:0; padding:0 ">1148: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1149:   end else begin : gen_no_icache</pre>
<pre style="margin:0; padding:0 ">1150:     // tieoff for the unused icen bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1151:     logic unused_icen;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1152:     assign unused_icen = cpuctrl_wdata.icache_enable;</pre>
<pre style="margin:0; padding:0 ">1153: </pre>
<pre style="margin:0; padding:0 ">1154:     // icen field will always read as zero if ICache not configured</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1155:     assign cpuctrl_rdata.icache_enable = 1'b0;</pre>
<pre style="margin:0; padding:0 ">1156:   end</pre>
<pre style="margin:0; padding:0 ">1157: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1158:   assign icache_enable_o = cpuctrl_rdata.icache_enable;</pre>
<pre style="margin:0; padding:0 ">1159: </pre>
<pre style="margin:0; padding:0 ">1160:   // tieoff for the currently unused bits of cpuctrl</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1161:   logic [31:6] unused_cpuctrl;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">1162:   assign unused_cpuctrl = {cpuctrl_wdata[31:6]};</pre>
<pre style="margin:0; padding:0 ">1163: </pre>
<pre style="margin:0; padding:0 ">1164: </pre>
<pre style="margin:0; padding:0 ">1165:   ////////////////</pre>
<pre style="margin:0; padding:0 ">1166:   // Assertions //</pre>
<pre style="margin:0; padding:0 ">1167:   ////////////////</pre>
<pre style="margin:0; padding:0 ">1168: </pre>
<pre style="margin:0; padding:0 ">1169:   `ASSERT(IbexCsrOpEnRequiresAccess, csr_op_en_i |-> csr_access_i)</pre>
<pre style="margin:0; padding:0 ">1170: </pre>
<pre style="margin:0; padding:0 ">1171: endmodule</pre>
<pre style="margin:0; padding:0 ">1172: </pre>
</body>
</html>
