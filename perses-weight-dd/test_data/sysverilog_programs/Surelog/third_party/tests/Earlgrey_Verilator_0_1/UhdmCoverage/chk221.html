
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ip_usbdev_0.1/rtl/usbdev.sv Cov: 100% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   3: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   4: //</pre>
<pre style="margin:0; padding:0 ">   5: // USB Full-Speed Device Interface (usbdev).</pre>
<pre style="margin:0; padding:0 ">   6: //</pre>
<pre style="margin:0; padding:0 ">   7: //</pre>
<pre style="margin:0; padding:0 ">   8: </pre>
<pre style="margin:0; padding:0 ">   9: </pre>
<pre style="margin:0; padding:0 ">  10: module usbdev (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  11:   input  logic       clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  12:   input  logic       rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  13:   input  logic       clk_usb_48mhz_i, // use usb_ prefix for signals in this clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  14:   input  logic       rst_usb_48mhz_ni, // async reset, with relase sync to clk_usb_48_mhz_i</pre>
<pre style="margin:0; padding:0 ">  15: </pre>
<pre style="margin:0; padding:0 ">  16:   // Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  17:   input  tlul_pkg::tl_h2d_t tl_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:   output tlul_pkg::tl_d2h_t tl_o,</pre>
<pre style="margin:0; padding:0 ">  19: </pre>
<pre style="margin:0; padding:0 ">  20:   // Data inputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:   input  logic       cio_d_i, // differential</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  22:   input  logic       cio_dp_i, // single-ended, can be used in differential mode to detect SE0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  23:   input  logic       cio_dn_i, // single-ended, can be used in differential mode to detect SE0</pre>
<pre style="margin:0; padding:0 ">  24: </pre>
<pre style="margin:0; padding:0 ">  25:   // Data outputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:   output logic       cio_d_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  27:   output logic       cio_d_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  28:   output logic       cio_dp_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  29:   output logic       cio_dp_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:   output logic       cio_dn_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  31:   output logic       cio_dn_en_o,</pre>
<pre style="margin:0; padding:0 ">  32: </pre>
<pre style="margin:0; padding:0 ">  33:   // Non-data I/O</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:   input  logic       cio_sense_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  35:   output logic       cio_se0_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36:   output logic       cio_se0_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:   output logic       cio_dp_pullup_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  38:   output logic       cio_dp_pullup_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:   output logic       cio_dn_pullup_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:   output logic       cio_dn_pullup_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  41:   output logic       cio_suspend_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  42:   output logic       cio_suspend_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:   output logic       cio_tx_mode_se_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:   output logic       cio_tx_mode_se_en_o,</pre>
<pre style="margin:0; padding:0 ">  45: </pre>
<pre style="margin:0; padding:0 ">  46:   // SOF reference for clock calibration</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:   output logic       usb_ref_val_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:   output logic       usb_ref_pulse_o,</pre>
<pre style="margin:0; padding:0 ">  49: </pre>
<pre style="margin:0; padding:0 ">  50:   // Interrupts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:   output logic       intr_pkt_received_o, // Packet received</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:   output logic       intr_pkt_sent_o, // Packet sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  53:   output logic       intr_connected_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  54:   output logic       intr_disconnected_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  55:   output logic       intr_host_lost_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  56:   output logic       intr_link_reset_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  57:   output logic       intr_link_suspend_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:   output logic       intr_link_resume_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:   output logic       intr_av_empty_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:   output logic       intr_rx_full_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:   output logic       intr_av_overflow_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:   output logic       intr_link_in_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63:   output logic       intr_rx_crc_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  64:   output logic       intr_rx_pid_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  65:   output logic       intr_rx_bitstuff_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:   output logic       intr_frame_o</pre>
<pre style="margin:0; padding:0 ">  67: );</pre>
<pre style="margin:0; padding:0 ">  68: </pre>
<pre style="margin:0; padding:0 ">  69:   import usbdev_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  70: </pre>
<pre style="margin:0; padding:0 ">  71:   // Could make SramDepth, MaxPktSizeByte, AVFifoDepth and RXFifoDepth</pre>
<pre style="margin:0; padding:0 ">  72:   // module parameters but may need to fix register def for the first two</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73:   localparam int SramDw = 32; // Places packing bytes to SRAM assume this</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:   localparam int SramDepth = 512; // 2kB, SRAM Width is DW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  75:   localparam int MaxPktSizeByte = 64;</pre>
<pre style="margin:0; padding:0 ">  76: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:   localparam int SramAw = $clog2(SramDepth);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  78:   localparam int SizeWidth = $clog2(MaxPktSizeByte);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  79:   localparam int NBuf = (SramDepth * SramDw) / (MaxPktSizeByte * 8);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:   localparam int NBufWidth = $clog2(NBuf);</pre>
<pre style="margin:0; padding:0 ">  81: </pre>
<pre style="margin:0; padding:0 ">  82:   // AV fifo just stores buffer numbers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:   localparam int AVFifoWidth = NBufWidth;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  84:   localparam int AVFifoDepth = 4;</pre>
<pre style="margin:0; padding:0 ">  85: </pre>
<pre style="margin:0; padding:0 ">  86:   // RX fifo stores              buf# +  size(0-MaxPktSizeByte)  + EP# + Type</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:   localparam int RXFifoWidth = NBufWidth + (1+SizeWidth)         +  4  + 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:   localparam int RXFifoDepth = 4;</pre>
<pre style="margin:0; padding:0 ">  89: </pre>
<pre style="margin:0; padding:0 ">  90:   // Number of endpoints</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  91:   localparam int NEndpoints = usbdev_reg_pkg::NEndpoints;</pre>
<pre style="margin:0; padding:0 ">  92: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  93:   usbdev_reg2hw_t reg2hw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:   usbdev_hw2reg_t hw2reg;</pre>
<pre style="margin:0; padding:0 ">  95: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:   tlul_pkg::tl_h2d_t tl_sram_h2d [1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:   tlul_pkg::tl_d2h_t tl_sram_d2h [1];</pre>
<pre style="margin:0; padding:0 ">  98: </pre>
<pre style="margin:0; padding:0 ">  99:   // Dual-port SRAM Interface: Refer prim_ram_2p_async_adv.sv</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:   logic              mem_a_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:   logic              mem_a_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102:   logic [SramAw-1:0] mem_a_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:   logic [SramDw-1:0] mem_a_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:   logic              mem_a_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:   logic [SramDw-1:0] mem_a_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 106:   logic [1:0]        mem_a_rerror;</pre>
<pre style="margin:0; padding:0 "> 107: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 108:   logic              usb_mem_b_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:   logic              usb_mem_b_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:   logic [SramAw-1:0] usb_mem_b_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:   logic [SramDw-1:0] usb_mem_b_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:   logic [SramDw-1:0] usb_mem_b_rdata;</pre>
<pre style="margin:0; padding:0 "> 113: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:   logic              usb_clr_devaddr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115:   logic              usb_event_av_empty, event_av_overflow, usb_event_rx_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 116:   logic              event_av_empty, event_rx_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 117:   logic              usb_event_link_reset, usb_event_link_suspend, usb_event_link_resume;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 118:   logic              usb_event_host_lost, usb_event_disconnect, usb_event_connect;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 119:   logic              usb_event_rx_crc_err, usb_event_rx_pid_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:   logic              usb_event_rx_bitstuff_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:   logic              usb_event_in_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:   logic              usb_event_frame;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 123:   logic              usb_link_active;</pre>
<pre style="margin:0; padding:0 "> 124: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 125:   logic              event_link_reset, event_link_suspend, event_link_resume;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 126:   logic              event_host_lost, event_disconnect, event_connect;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 127:   logic              event_rx_crc_err, event_rx_pid_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 128:   logic              event_rx_bitstuff_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 129:   logic              event_in_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 130:   logic              event_frame;</pre>
<pre style="margin:0; padding:0 "> 131: </pre>
<pre style="margin:0; padding:0 "> 132:   // CDC signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:   logic [10:0]       usb_frame;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:   logic [2:0]        usb_link_state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:   logic              usb_enable;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:   logic [6:0]        usb_device_addr;</pre>
<pre style="margin:0; padding:0 "> 137: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 138:   logic                  data_toggle_clear_qe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 139:   logic                  usb_data_toggle_clear_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140:   logic [NEndpoints-1:0] usb_data_toggle_clear;</pre>
<pre style="margin:0; padding:0 "> 141: </pre>
<pre style="margin:0; padding:0 "> 142: </pre>
<pre style="margin:0; padding:0 "> 143:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 144:   // USB IO after CDC & muxing   //</pre>
<pre style="margin:0; padding:0 "> 145:   /////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146:   logic usb_rx_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:   logic usb_rx_se0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:   logic usb_tx_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:   logic usb_tx_se0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:   logic usb_tx_oe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151:   logic usb_pwr_sense;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:   logic usb_pullup_en;</pre>
<pre style="margin:0; padding:0 "> 153: </pre>
<pre style="margin:0; padding:0 "> 154:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 155:   // Receive interface fifos //</pre>
<pre style="margin:0; padding:0 "> 156:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 157: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:   logic              av_fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:   logic              event_pkt_received;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:   logic              usb_av_rvalid, usb_av_rready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 161:   logic              usb_rx_wvalid, usb_rx_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 162:   logic              rx_fifo_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 163:   logic              rx_fifo_re;</pre>
<pre style="margin:0; padding:0 "> 164: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:   logic [AVFifoWidth - 1:0] usb_av_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166:   logic [RXFifoWidth - 1:0] usb_rx_wdata, rx_rdata_raw, rx_rdata;</pre>
<pre style="margin:0; padding:0 "> 167: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:   assign event_av_overflow = reg2hw.avbuffer.qe & (~av_fifo_wready);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 169:   assign hw2reg.usbstat.av_full.d = ~av_fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:   assign hw2reg.usbstat.rx_empty.d = ~rx_fifo_rvalid;</pre>
<pre style="margin:0; padding:0 "> 171: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:   prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 173:     .Width(AVFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174:     .Depth(AVFifoDepth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:   ) usbdev_avfifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176:     .clk_wr_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 177:     .rst_wr_ni (rst_ni),</pre>
<pre style="margin:0; padding:0 "> 178: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 179:     .wvalid    (reg2hw.avbuffer.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180:     .wready    (av_fifo_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 181:     .wdata     (reg2hw.avbuffer.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 182:     .wdepth    (hw2reg.usbstat.av_depth.d),</pre>
<pre style="margin:0; padding:0 "> 183: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:     .clk_rd_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:     .rst_rd_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:     .rvalid    (usb_av_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:     .rready    (usb_av_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:     .rdata     (usb_av_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:     .rdepth    () // only using empty</pre>
<pre style="margin:0; padding:0 "> 190:   );</pre>
<pre style="margin:0; padding:0 "> 191: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 192:   assign rx_fifo_re = reg2hw.rxfifo.ep.re | reg2hw.rxfifo.setup.re |</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 193:                       reg2hw.rxfifo.size.re | reg2hw.rxfifo.buffer.re;</pre>
<pre style="margin:0; padding:0 "> 194: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 195:   prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:     .Width(RXFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:     .Depth(RXFifoDepth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:   ) usbdev_rxfifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:     .clk_wr_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:     .rst_wr_ni (rst_usb_48mhz_ni),</pre>
<pre style="margin:0; padding:0 "> 201: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 202:     .wvalid    (usb_rx_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:     .wready    (usb_rx_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 204:     .wdata     (usb_rx_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205:     .wdepth    (),</pre>
<pre style="margin:0; padding:0 "> 206: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 207:     .clk_rd_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 208:     .rst_rd_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:     .rvalid    (rx_fifo_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 210:     .rready    (rx_fifo_re),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 211:     .rdata     (rx_rdata_raw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:     .rdepth    (hw2reg.usbstat.rx_depth.d)</pre>
<pre style="margin:0; padding:0 "> 213:   );</pre>
<pre style="margin:0; padding:0 "> 214: </pre>
<pre style="margin:0; padding:0 "> 215:   // Return all zero if the FIFO is empty (instead of X)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:   assign rx_rdata = rx_fifo_rvalid ? rx_rdata_raw : '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:   assign hw2reg.rxfifo.ep.d = rx_rdata[16:13];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 218:   assign hw2reg.rxfifo.setup.d = rx_rdata[12];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 219:   assign hw2reg.rxfifo.size.d = rx_rdata[11:5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 220:   assign hw2reg.rxfifo.buffer.d = rx_rdata[4:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:   assign event_pkt_received = rx_fifo_rvalid;</pre>
<pre style="margin:0; padding:0 "> 222: </pre>
<pre style="margin:0; padding:0 "> 223:   // The rxfifo register is hrw, but we just need the read enables.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:   logic [3:0] unused_rxfifo_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 225:   assign unused_rxfifo_q = {reg2hw.rxfifo.ep.q, reg2hw.rxfifo.setup.q,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 226:                             reg2hw.rxfifo.size.q, reg2hw.rxfifo.buffer.q};</pre>
<pre style="margin:0; padding:0 "> 227: </pre>
<pre style="margin:0; padding:0 "> 228:   ////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 229:   // IN (Transmit) interface config //</pre>
<pre style="margin:0; padding:0 "> 230:   ////////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:   logic [NBufWidth-1:0]  usb_in_buf [NEndpoints];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 232:   logic [SizeWidth:0]    usb_in_size [NEndpoints];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 233:   logic [3:0]            usb_in_endpoint;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 234:   logic [NEndpoints-1:0] usb_in_rdy;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:   logic [NEndpoints-1:0] clear_rdybit, set_sentbit, update_pend;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236:   logic                  usb_setup_received, setup_received, usb_set_sent, set_sent;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:   logic [NEndpoints-1:0] ep_iso;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:   logic [NEndpoints-1:0] enable_setup, enable_out, ep_stall;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 239:   logic [NEndpoints-1:0] usb_enable_setup, usb_enable_out, usb_ep_stall;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 240:   logic [NEndpoints-1:0] in_rdy_async;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 241:   logic [3:0]            usb_out_endpoint;</pre>
<pre style="margin:0; padding:0 "> 242: </pre>
<pre style="margin:0; padding:0 "> 243:   // RX enables</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:   always_comb begin : proc_map_rxenable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:       enable_setup[i] = reg2hw.rxenable_setup[i].q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:       enable_out[i]   = reg2hw.rxenable_out[i].q;</pre>
<pre style="margin:0; padding:0 "> 248:     end</pre>
<pre style="margin:0; padding:0 "> 249:   end</pre>
<pre style="margin:0; padding:0 "> 250: </pre>
<pre style="margin:0; padding:0 "> 251:   // STALL for both directions</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:   always_comb begin : proc_map_stall</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:       ep_stall[i] = reg2hw.stall[i];</pre>
<pre style="margin:0; padding:0 "> 255:     end</pre>
<pre style="margin:0; padding:0 "> 256:   end</pre>
<pre style="margin:0; padding:0 "> 257: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 259:     .Width(3*NEndpoints)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 260:   ) usbdev_sync_ep_cfg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 262:     .rst_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:     .d      ({enable_setup, enable_out, ep_stall}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:     .q      ({usb_enable_setup, usb_enable_out, usb_ep_stall})</pre>
<pre style="margin:0; padding:0 "> 265:   );</pre>
<pre style="margin:0; padding:0 "> 266: </pre>
<pre style="margin:0; padding:0 "> 267:   // CDC: ok, quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 268:   always_comb begin : proc_map_iso</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 270:       ep_iso[i] = reg2hw.iso[i].q;</pre>
<pre style="margin:0; padding:0 "> 271:     end</pre>
<pre style="margin:0; padding:0 "> 272:   end</pre>
<pre style="margin:0; padding:0 "> 273: </pre>
<pre style="margin:0; padding:0 "> 274:   // CDC: flop_2sync for ready bit covers others so assigns are ok</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 275:   always_comb begin : proc_map_buf_size</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 277:       usb_in_buf[i]  = reg2hw.configin[i].buffer.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 278:       usb_in_size[i] = reg2hw.configin[i].size.q;</pre>
<pre style="margin:0; padding:0 "> 279:     end</pre>
<pre style="margin:0; padding:0 "> 280:   end</pre>
<pre style="margin:0; padding:0 "> 281: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 282:   always_comb begin : proc_map_rdy_reg2hw</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 283:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 284:       in_rdy_async[i] = reg2hw.configin[i].rdy.q;</pre>
<pre style="margin:0; padding:0 "> 285:     end</pre>
<pre style="margin:0; padding:0 "> 286:   end</pre>
<pre style="margin:0; padding:0 "> 287: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:     .Width (NEndpoints)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:   ) usbdev_rdysync (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 291:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 292:     .rst_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 293:     .d      (in_rdy_async),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 294:     .q      (usb_in_rdy)</pre>
<pre style="margin:0; padding:0 "> 295:   );</pre>
<pre style="margin:0; padding:0 "> 296: </pre>
<pre style="margin:0; padding:0 "> 297:   // CDC: We synchronize the qe (write pulse) and assume that the</pre>
<pre style="margin:0; padding:0 "> 298:   // rest of the register remains stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:   always_comb begin : proc_data_toggle_clear_qe</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 300:     data_toggle_clear_qe = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 301:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 302:       data_toggle_clear_qe |= reg2hw.data_toggle_clear[i].qe;</pre>
<pre style="margin:0; padding:0 "> 303:     end</pre>
<pre style="margin:0; padding:0 "> 304:   end</pre>
<pre style="margin:0; padding:0 "> 305: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 306:   prim_pulse_sync usbdev_data_toggle_clear (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 307:     .clk_src_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 308:     .clk_dst_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309:     .rst_src_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 310:     .rst_dst_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:     .src_pulse_i (data_toggle_clear_qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312:     .dst_pulse_o (usb_data_toggle_clear_en)</pre>
<pre style="margin:0; padding:0 "> 313:   );</pre>
<pre style="margin:0; padding:0 "> 314: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 315:   always_comb begin : proc_usb_data_toggle_clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 316:     usb_data_toggle_clear = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:       if (usb_data_toggle_clear_en) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:         usb_data_toggle_clear[i] = reg2hw.data_toggle_clear[i].q;</pre>
<pre style="margin:0; padding:0 "> 320:       end</pre>
<pre style="margin:0; padding:0 "> 321:     end</pre>
<pre style="margin:0; padding:0 "> 322:   end</pre>
<pre style="margin:0; padding:0 "> 323: </pre>
<pre style="margin:0; padding:0 "> 324:   // Clear of ready and set of sent is a pulse in USB clock domain</pre>
<pre style="margin:0; padding:0 "> 325:   // but needs to ensure register bit is cleared/set in TLUL domain</pre>
<pre style="margin:0; padding:0 "> 326:   // usbdev_pulsesync takes pulse in clk_src to pulse in clk_dst</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 327:   prim_pulse_sync usbdev_setsent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 328:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 329:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:     .src_pulse_i (usb_set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:     .dst_pulse_o (set_sent)</pre>
<pre style="margin:0; padding:0 "> 334:   );</pre>
<pre style="margin:0; padding:0 "> 335: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 337:     set_sentbit = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 338:     if (set_sent) begin</pre>
<pre style="margin:0; padding:0 "> 339:       // synchronization of set_sent ensures usb_endpoint is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340:       set_sentbit[usb_in_endpoint] = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 341:     end</pre>
<pre style="margin:0; padding:0 "> 342:   end</pre>
<pre style="margin:0; padding:0 "> 343: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 344:   always_comb begin : proc_map_sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 345:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 346:       hw2reg.in_sent[i].de = set_sentbit[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 347:       hw2reg.in_sent[i].d  = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 348:     end</pre>
<pre style="margin:0; padding:0 "> 349:   end</pre>
<pre style="margin:0; padding:0 "> 350: </pre>
<pre style="margin:0; padding:0 "> 351:   // Event (pulse) synchronization</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:   prim_pulse_sync usbdev_sync_in_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 353:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 356:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 357:     .src_pulse_i (usb_event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:     .dst_pulse_o (event_in_err)</pre>
<pre style="margin:0; padding:0 "> 359:   );</pre>
<pre style="margin:0; padding:0 "> 360: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:   prim_pulse_sync usbdev_outrdyclr (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 366:     .src_pulse_i (usb_setup_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:     .dst_pulse_o (setup_received)</pre>
<pre style="margin:0; padding:0 "> 368:   );</pre>
<pre style="margin:0; padding:0 "> 369: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 370:   prim_pulse_sync sync_usb_event_rx_crc_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 371:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 373:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 374:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 375:     .src_pulse_i (usb_event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:     .dst_pulse_o (event_rx_crc_err)</pre>
<pre style="margin:0; padding:0 "> 377:   );</pre>
<pre style="margin:0; padding:0 "> 378: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:   prim_pulse_sync sync_usb_event_rx_pid_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 383:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 384:     .src_pulse_i (usb_event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 385:     .dst_pulse_o (event_rx_pid_err)</pre>
<pre style="margin:0; padding:0 "> 386:   );</pre>
<pre style="margin:0; padding:0 "> 387: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:   prim_pulse_sync sync_usb_event_rx_bitstuff_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 390:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 393:     .src_pulse_i (usb_event_rx_bitstuff_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:     .dst_pulse_o (event_rx_bitstuff_err)</pre>
<pre style="margin:0; padding:0 "> 395:   );</pre>
<pre style="margin:0; padding:0 "> 396: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 397:   prim_pulse_sync sync_usb_event_frame (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 398:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 399:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 401:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402:     .src_pulse_i (usb_event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 403:     .dst_pulse_o (event_frame)</pre>
<pre style="margin:0; padding:0 "> 404:   );</pre>
<pre style="margin:0; padding:0 "> 405: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 406:   logic event_link_reset_q;</pre>
<pre style="margin:0; padding:0 "> 407: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 408:   always_ff @(posedge clk_usb_48mhz_i or negedge rst_usb_48mhz_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:     if (!rst_usb_48mhz_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 410:       event_link_reset_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 411:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 412:       event_link_reset_q <= event_link_reset;</pre>
<pre style="margin:0; padding:0 "> 413:     end</pre>
<pre style="margin:0; padding:0 "> 414:   end</pre>
<pre style="margin:0; padding:0 "> 415: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 417:     clear_rdybit = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 418:     update_pend  = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 419:     if (event_link_reset && !event_link_reset_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 420:       clear_rdybit = {NEndpoints{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 421:       update_pend  = {NEndpoints{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 422:     end else begin</pre>
<pre style="margin:0; padding:0 "> 423:       // Clear pending when a SETUP is received</pre>
<pre style="margin:0; padding:0 "> 424:       // CDC: usb_out_endpoint is synchronized implicitly by</pre>
<pre style="margin:0; padding:0 "> 425:       // setup_received, as it is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:       clear_rdybit[usb_out_endpoint] = setup_received;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 427:       update_pend[usb_out_endpoint]  = setup_received;</pre>
<pre style="margin:0; padding:0 "> 428: </pre>
<pre style="margin:0; padding:0 "> 429:       // Clear when a IN transmission was sucessful</pre>
<pre style="margin:0; padding:0 "> 430:       // CDC: usb_in_endpoint is synchronzied implicitly by</pre>
<pre style="margin:0; padding:0 "> 431:       // set_sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:       clear_rdybit[usb_in_endpoint] = set_sent;</pre>
<pre style="margin:0; padding:0 "> 433:     end</pre>
<pre style="margin:0; padding:0 "> 434:   end</pre>
<pre style="margin:0; padding:0 "> 435: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 436:   always_comb begin : proc_map_rdy_hw2reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 437:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 438:       hw2reg.configin[i].rdy.de = clear_rdybit[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 439:       hw2reg.configin[i].rdy.d  = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 440:     end</pre>
<pre style="margin:0; padding:0 "> 441:   end</pre>
<pre style="margin:0; padding:0 "> 442: </pre>
<pre style="margin:0; padding:0 "> 443:   // Update the pending bit by copying the ready bit that is about to clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 444:   always_comb begin : proc_map_pend</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 445:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 446:       hw2reg.configin[i].pend.de = update_pend[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 447:       hw2reg.configin[i].pend.d  = reg2hw.configin[i].rdy.q | reg2hw.configin[i].pend.q;</pre>
<pre style="margin:0; padding:0 "> 448:     end</pre>
<pre style="margin:0; padding:0 "> 449:   end</pre>
<pre style="margin:0; padding:0 "> 450: </pre>
<pre style="margin:0; padding:0 "> 451:   ////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 452:   // USB interface -- everything is in USB clock domain //</pre>
<pre style="margin:0; padding:0 "> 453:   ////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 454: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 455:   usbdev_usbif #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 456:     .NEndpoints     (NEndpoints),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 457:     .AVFifoWidth    (AVFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 458:     .RXFifoWidth    (RXFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 459:     .MaxPktSizeByte (MaxPktSizeByte),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 460:     .NBuf           (NBuf),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 461:     .SramAw         (SramAw)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 462:   ) usbdev_impl (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:     .clk_48mhz_i          (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 464:     .rst_ni               (rst_usb_48mhz_ni),</pre>
<pre style="margin:0; padding:0 "> 465: </pre>
<pre style="margin:0; padding:0 "> 466:     // Pins</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 467:     .usb_d_i              (usb_rx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468:     .usb_se0_i            (usb_rx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 469:     .usb_oe_o             (usb_tx_oe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:     .usb_d_o              (usb_tx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:     .usb_se0_o            (usb_tx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:     .usb_sense_i          (usb_pwr_sense),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:     .usb_pullup_en_o      (usb_pullup_en),</pre>
<pre style="margin:0; padding:0 "> 474: </pre>
<pre style="margin:0; padding:0 "> 475:     // receive side</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 476:     .rx_setup_i           (usb_enable_setup),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:     .rx_out_i             (usb_enable_out),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 478:     .rx_stall_i           (usb_ep_stall),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 479:     .av_rvalid_i          (usb_av_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:     .av_rready_o          (usb_av_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 481:     .av_rdata_i           (usb_av_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 482:     .event_av_empty_o     (usb_event_av_empty),</pre>
<pre style="margin:0; padding:0 "> 483: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:     .rx_wvalid_o          (usb_rx_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:     .rx_wready_i          (usb_rx_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 486:     .rx_wdata_o           (usb_rx_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 487:     .event_rx_full_o      (usb_event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 488:     .setup_received_o     (usb_setup_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 489:     .out_endpoint_o       (usb_out_endpoint),  // will be stable for several cycles</pre>
<pre style="margin:0; padding:0 "> 490: </pre>
<pre style="margin:0; padding:0 "> 491:     // transmit side</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 492:     .in_buf_i             (usb_in_buf[usb_in_endpoint]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:     .in_size_i            (usb_in_size[usb_in_endpoint]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 494:     .in_stall_i           (usb_ep_stall),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 495:     .in_rdy_i             (usb_in_rdy),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 496:     .set_sent_o           (usb_set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 497:     .in_endpoint_o        (usb_in_endpoint),</pre>
<pre style="margin:0; padding:0 "> 498: </pre>
<pre style="margin:0; padding:0 "> 499:     // memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 500:     .mem_req_o            (usb_mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 501:     .mem_write_o          (usb_mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 502:     .mem_addr_o           (usb_mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 503:     .mem_wdata_o          (usb_mem_b_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 504:     .mem_rdata_i          (usb_mem_b_rdata),</pre>
<pre style="margin:0; padding:0 "> 505: </pre>
<pre style="margin:0; padding:0 "> 506:     // control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 507:     .enable_i             (usb_enable),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508:     .devaddr_i            (usb_device_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 509:     .clr_devaddr_o        (usb_clr_devaddr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 510:     .ep_iso_i             (ep_iso), // cdc ok, quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 511:     .cfg_eop_single_bit_i (reg2hw.phy_config.eop_single_bit.q), // cdc ok: quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 512:     .tx_osc_test_mode_i   (1'b0), // cdc ok: quasi-static & testmode only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 513:     .data_toggle_clear_i  (usb_data_toggle_clear),</pre>
<pre style="margin:0; padding:0 "> 514: </pre>
<pre style="margin:0; padding:0 "> 515:     // status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 516:     .frame_o              (usb_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 517:     .frame_start_o        (usb_event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 518:     .link_state_o         (usb_link_state),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 519:     .link_disconnect_o    (usb_event_disconnect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 520:     .link_connect_o       (usb_event_connect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 521:     .link_reset_o         (usb_event_link_reset),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 522:     .link_active_o        (usb_link_active),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 523:     .link_suspend_o       (usb_event_link_suspend),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 524:     .link_resume_o        (usb_event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 525:     .host_lost_o          (usb_event_host_lost),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 526:     .link_in_err_o        (usb_event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 527:     .rx_crc_err_o         (usb_event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 528:     .rx_pid_err_o         (usb_event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 529:     .rx_bitstuff_err_o    (usb_event_rx_bitstuff_err)</pre>
<pre style="margin:0; padding:0 "> 530:   );</pre>
<pre style="margin:0; padding:0 "> 531: </pre>
<pre style="margin:0; padding:0 "> 532:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 533:   // Control signal / status CDC //</pre>
<pre style="margin:0; padding:0 "> 534:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 535: </pre>
<pre style="margin:0; padding:0 "> 536:   // USB clk -> sys clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 537:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 538:     .Width      (3+11)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 539:   ) cdc_usb_to_sys (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 540:     .clk_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 541:     .rst_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 542:     .d      ({usb_link_state,              usb_frame}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 543:     .q      ({hw2reg.usbstat.link_state.d, hw2reg.usbstat.frame.d})</pre>
<pre style="margin:0; padding:0 "> 544:   );</pre>
<pre style="margin:0; padding:0 "> 545: </pre>
<pre style="margin:0; padding:0 "> 546:   // sys clk -> USB clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 547:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 548:     .Width      (1+7)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 549:   ) cdc_sys_to_usb (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 550:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 551:     .rst_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 552:     .d      ({reg2hw.usbctrl.enable.q, reg2hw.usbctrl.device_address.q}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 553:     .q      ({usb_enable,              usb_device_addr})</pre>
<pre style="margin:0; padding:0 "> 554:   );</pre>
<pre style="margin:0; padding:0 "> 555: </pre>
<pre style="margin:0; padding:0 "> 556:   // CDC for event signals (arguably they are there for a long time so would be ok)</pre>
<pre style="margin:0; padding:0 "> 557:   // Just want a pulse to ensure only one interrupt for an event</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 558:   usbdev_flop_2syncpulse #(.Width(5)) syncevent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 559:     .clk_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 560:     .rst_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 561:     .d      ({usb_event_disconnect, usb_event_link_reset, usb_event_link_suspend,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 562:               usb_event_host_lost, usb_event_connect}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 563:     .q      ({event_disconnect, event_link_reset, event_link_suspend,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 564:               event_host_lost, event_connect})</pre>
<pre style="margin:0; padding:0 "> 565:   );</pre>
<pre style="margin:0; padding:0 "> 566: </pre>
<pre style="margin:0; padding:0 "> 567:   // Resume is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 568:   prim_pulse_sync usbdev_resume (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 569:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 570:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 571:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 572:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 573:     .src_pulse_i (usb_event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 574:     .dst_pulse_o (event_link_resume)</pre>
<pre style="margin:0; padding:0 "> 575:   );</pre>
<pre style="margin:0; padding:0 "> 576: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 577:   assign hw2reg.usbstat.host_lost.d = event_host_lost;</pre>
<pre style="margin:0; padding:0 "> 578: </pre>
<pre style="margin:0; padding:0 "> 579:   // resets etc cause the device address to clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 580:   prim_pulse_sync usbdev_devclr (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 581:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 582:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 583:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 584:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 585:     .src_pulse_i (usb_clr_devaddr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 586:     .dst_pulse_o (hw2reg.usbctrl.device_address.de)</pre>
<pre style="margin:0; padding:0 "> 587:   );</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 588:   assign hw2reg.usbctrl.device_address.d = '0;</pre>
<pre style="margin:0; padding:0 "> 589: </pre>
<pre style="margin:0; padding:0 "> 590:   // AV empty is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 591:   prim_pulse_sync sync_usb_event_av_empty (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 592:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 593:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 594:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 595:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 596:     .src_pulse_i (usb_event_av_empty),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 597:     .dst_pulse_o (event_av_empty)</pre>
<pre style="margin:0; padding:0 "> 598:   );</pre>
<pre style="margin:0; padding:0 "> 599: </pre>
<pre style="margin:0; padding:0 "> 600:   // RX full is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 601:   prim_pulse_sync sync_usb_event_rx_full (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 602:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 603:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 604:     .rst_src_ni  (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 605:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 606:     .src_pulse_i (usb_event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 607:     .dst_pulse_o (event_rx_full)</pre>
<pre style="margin:0; padding:0 "> 608:   );</pre>
<pre style="margin:0; padding:0 "> 609: </pre>
<pre style="margin:0; padding:0 "> 610:   // Clear the stall flag when a SETUP is received</pre>
<pre style="margin:0; padding:0 "> 611: </pre>
<pre style="margin:0; padding:0 "> 612:   // CDC: usb_out_endpoint is synchronized implicitly by</pre>
<pre style="margin:0; padding:0 "> 613:   // setup_received, as it is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 614:   always_comb begin : proc_stall_tieoff</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 615:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 616:       hw2reg.stall[i].d  = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 617:       if (setup_received && usb_out_endpoint == 4'(unsigned'(i))) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 618:         hw2reg.stall[i].de = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 619:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 620:         hw2reg.stall[i].de = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 621:       end</pre>
<pre style="margin:0; padding:0 "> 622:     end</pre>
<pre style="margin:0; padding:0 "> 623:   end</pre>
<pre style="margin:0; padding:0 "> 624: </pre>
<pre style="margin:0; padding:0 "> 625:   // TL-UL to SRAM adapter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 626:   tlul_adapter_sram #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 627:     .SramAw(SramAw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 628:     .ByteAccess(0)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 629:   ) u_tlul2sram (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 630:     .clk_i    (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 631:     .rst_ni   (rst_ni),</pre>
<pre style="margin:0; padding:0 "> 632: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 633:     .tl_i     (tl_sram_h2d [0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 634:     .tl_o     (tl_sram_d2h [0]),</pre>
<pre style="margin:0; padding:0 "> 635: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 636:     .req_o    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 637:     .gnt_i    (mem_a_req),  //Always grant when request</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 638:     .we_o     (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 639:     .addr_o   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 640:     .wdata_o  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 641:     .wmask_o  (),           // Not used</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 642:     .rdata_i  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 643:     .rvalid_i (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 644:     .rerror_i (mem_a_rerror)</pre>
<pre style="margin:0; padding:0 "> 645:   );</pre>
<pre style="margin:0; padding:0 "> 646: </pre>
<pre style="margin:0; padding:0 "> 647:   // SRAM Wrapper</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 648:   prim_ram_2p_async_adv #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 649:     .Depth (SramDepth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 650:     .Width (SramDw),    // 32 x 512 --> 2kB</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 651:     .CfgW  (8),</pre>
<pre style="margin:0; padding:0 "> 652: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 653:     .EnableECC           (0), // No Protection</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 654:     .EnableParity        (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 655:     .EnableInputPipeline (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 656:     .EnableOutputPipeline(0)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 657:   ) u_memory_2p (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 658:     .clk_a_i    (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 659:     .clk_b_i    (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 660:     .rst_a_ni   (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 661:     .rst_b_ni   (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 662:     .a_req_i    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 663:     .a_write_i  (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 664:     .a_addr_i   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 665:     .a_wdata_i  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 666:     .a_wmask_i  ({SramDw{1'b1}}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 667:     .a_rvalid_o (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 668:     .a_rdata_o  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 669:     .a_rerror_o (mem_a_rerror),</pre>
<pre style="margin:0; padding:0 "> 670: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 671:     .b_req_i    (usb_mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 672:     .b_write_i  (usb_mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 673:     .b_addr_i   (usb_mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 674:     .b_wdata_i  (usb_mem_b_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 675:     .b_wmask_i  ({SramDw{1'b1}}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 676:     .b_rvalid_o (),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 677:     .b_rdata_o  (usb_mem_b_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 678:     .b_rerror_o (),</pre>
<pre style="margin:0; padding:0 "> 679: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 680:     .cfg_i      (8'h0)</pre>
<pre style="margin:0; padding:0 "> 681:   );</pre>
<pre style="margin:0; padding:0 "> 682: </pre>
<pre style="margin:0; padding:0 "> 683:   // Register module</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 684:   usbdev_reg_top u_reg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 685:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 686:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 687: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 688:     .tl_i (tl_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 689:     .tl_o (tl_o),</pre>
<pre style="margin:0; padding:0 "> 690: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 691:     .tl_win_o (tl_sram_h2d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 692:     .tl_win_i (tl_sram_d2h),</pre>
<pre style="margin:0; padding:0 "> 693: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 694:     .reg2hw,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 695:     .hw2reg,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 696:     .devmode_i (1'b1)</pre>
<pre style="margin:0; padding:0 "> 697:   );</pre>
<pre style="margin:0; padding:0 "> 698: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 699:   prim_intr_hw #(.Width(1)) intr_hw_pkt_received (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 700:     .event_intr_i           (event_pkt_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 701:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 702:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 703:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.pkt_received.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 704:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 705:     .hw2reg_intr_state_de_o (hw2reg.intr_state.pkt_received.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 706:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.pkt_received.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 707:     .intr_o                 (intr_pkt_received_o)</pre>
<pre style="margin:0; padding:0 "> 708:   );</pre>
<pre style="margin:0; padding:0 "> 709: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 710:   prim_intr_hw #(.Width(1)) intr_hw_pkt_sent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 711:     .event_intr_i           (set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 712:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 713:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 714:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.pkt_sent.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 715:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 716:     .hw2reg_intr_state_de_o (hw2reg.intr_state.pkt_sent.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 717:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.pkt_sent.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 718:     .intr_o                 (intr_pkt_sent_o)</pre>
<pre style="margin:0; padding:0 "> 719:   );</pre>
<pre style="margin:0; padding:0 "> 720: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 721:   prim_intr_hw #(.Width(1)) intr_disconnected (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 722:     .event_intr_i           (event_disconnect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 723:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 724:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 725:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.disconnected.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 726:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 727:     .hw2reg_intr_state_de_o (hw2reg.intr_state.disconnected.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 728:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.disconnected.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 729:     .intr_o                 (intr_disconnected_o)</pre>
<pre style="margin:0; padding:0 "> 730:   );</pre>
<pre style="margin:0; padding:0 "> 731: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 732:   prim_intr_hw #(.Width(1)) intr_connected (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 733:     .event_intr_i           (event_connect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 734:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 735:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 736:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.connected.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 737:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 738:     .hw2reg_intr_state_de_o (hw2reg.intr_state.connected.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 739:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.connected.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 740:     .intr_o                 (intr_connected_o)</pre>
<pre style="margin:0; padding:0 "> 741:   );</pre>
<pre style="margin:0; padding:0 "> 742: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 743:   prim_intr_hw #(.Width(1)) intr_host_lost (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 744:     .event_intr_i           (event_host_lost),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 745:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 746:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 747:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.host_lost.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 748:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 749:     .hw2reg_intr_state_de_o (hw2reg.intr_state.host_lost.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 750:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.host_lost.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 751:     .intr_o                 (intr_host_lost_o)</pre>
<pre style="margin:0; padding:0 "> 752:   );</pre>
<pre style="margin:0; padding:0 "> 753: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 754:   prim_intr_hw #(.Width(1)) intr_link_reset (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 755:     .event_intr_i           (event_link_reset),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 756:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 757:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 758:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_reset.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 759:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 760:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_reset.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 761:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_reset.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 762:     .intr_o                 (intr_link_reset_o)</pre>
<pre style="margin:0; padding:0 "> 763:   );</pre>
<pre style="margin:0; padding:0 "> 764: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 765:   prim_intr_hw #(.Width(1)) intr_link_suspend (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 766:     .event_intr_i           (event_link_suspend),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 767:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 768:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 769:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_suspend.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 770:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 771:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_suspend.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 772:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_suspend.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 773:     .intr_o                 (intr_link_suspend_o)</pre>
<pre style="margin:0; padding:0 "> 774:   );</pre>
<pre style="margin:0; padding:0 "> 775: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 776:   prim_intr_hw #(.Width(1)) intr_link_resume (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 777:     .event_intr_i           (event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 778:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 779:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 780:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_resume.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 781:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 782:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_resume.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 783:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_resume.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 784:     .intr_o                 (intr_link_resume_o)</pre>
<pre style="margin:0; padding:0 "> 785:   );</pre>
<pre style="margin:0; padding:0 "> 786: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 787:   prim_intr_hw #(.Width(1)) intr_av_empty (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 788:     .event_intr_i           (event_av_empty),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 789:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 790:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 791:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.av_empty.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 792:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 793:     .hw2reg_intr_state_de_o (hw2reg.intr_state.av_empty.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 794:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.av_empty.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 795:     .intr_o                 (intr_av_empty_o)</pre>
<pre style="margin:0; padding:0 "> 796:   );</pre>
<pre style="margin:0; padding:0 "> 797: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 798:   prim_intr_hw #(.Width(1)) intr_rx_full (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 799:     .event_intr_i           (event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 800:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 801:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 802:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_full.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 803:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 804:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_full.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 805:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_full.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 806:     .intr_o                 (intr_rx_full_o)</pre>
<pre style="margin:0; padding:0 "> 807:   );</pre>
<pre style="margin:0; padding:0 "> 808: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 809:   prim_intr_hw #(.Width(1)) intr_av_overflow (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 810:     .event_intr_i           (event_av_overflow),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 811:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 812:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 813:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.av_overflow.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 814:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 815:     .hw2reg_intr_state_de_o (hw2reg.intr_state.av_overflow.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 816:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.av_overflow.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 817:     .intr_o                 (intr_av_overflow_o)</pre>
<pre style="margin:0; padding:0 "> 818:   );</pre>
<pre style="margin:0; padding:0 "> 819: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 820:   prim_intr_hw #(.Width(1)) intr_link_in_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 821:     .event_intr_i           (event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 822:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 823:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 824:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_in_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 825:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 826:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_in_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 827:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_in_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 828:     .intr_o                 (intr_link_in_err_o)</pre>
<pre style="margin:0; padding:0 "> 829:   );</pre>
<pre style="margin:0; padding:0 "> 830: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 831:   prim_intr_hw #(.Width(1)) intr_rx_crc_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 832:     .event_intr_i           (event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 833:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 834:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 835:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_crc_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 836:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 837:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_crc_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 838:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_crc_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 839:     .intr_o                 (intr_rx_crc_err_o)</pre>
<pre style="margin:0; padding:0 "> 840:   );</pre>
<pre style="margin:0; padding:0 "> 841: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 842:   prim_intr_hw #(.Width(1)) intr_rx_pid_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 843:     .event_intr_i           (event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 844:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 845:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 846:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_pid_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 847:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 848:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_pid_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 849:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_pid_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 850:     .intr_o                 (intr_rx_pid_err_o)</pre>
<pre style="margin:0; padding:0 "> 851:   );</pre>
<pre style="margin:0; padding:0 "> 852: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 853:   prim_intr_hw #(.Width(1)) intr_rx_bitstuff_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 854:     .event_intr_i           (event_rx_bitstuff_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 855:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 856:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 857:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_bitstuff_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 858:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 859:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_bitstuff_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 860:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_bitstuff_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 861:     .intr_o                 (intr_rx_bitstuff_err_o)</pre>
<pre style="margin:0; padding:0 "> 862:   );</pre>
<pre style="margin:0; padding:0 "> 863: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 864:   prim_intr_hw #(.Width(1)) intr_frame (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 865:     .event_intr_i           (event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 866:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 867:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 868:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.frame.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 869:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 870:     .hw2reg_intr_state_de_o (hw2reg.intr_state.frame.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 871:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.frame.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 872:     .intr_o                 (intr_frame_o)</pre>
<pre style="margin:0; padding:0 "> 873:   );</pre>
<pre style="margin:0; padding:0 "> 874: </pre>
<pre style="margin:0; padding:0 "> 875:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 876:   // USB IO Muxing               //</pre>
<pre style="margin:0; padding:0 "> 877:   /////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 878:   logic cio_oe;</pre>
<pre style="margin:0; padding:0 "> 879: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 880:   usbdev_iomux i_usbdev_iomux (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 881:     .clk_i                  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 882:     .rst_ni                 (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 883:     .clk_usb_48mhz_i        (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 884:     .rst_usb_48mhz_ni       (rst_usb_48mhz_ni),</pre>
<pre style="margin:0; padding:0 "> 885: </pre>
<pre style="margin:0; padding:0 "> 886:     // Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 887:     .sys_reg2hw_config_i    (reg2hw.phy_config),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 888:     .sys_usb_sense_o        (hw2reg.usbstat.sense.d),</pre>
<pre style="margin:0; padding:0 "> 889: </pre>
<pre style="margin:0; padding:0 "> 890:     // Chip IO</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 891:     .cio_usb_d_i            (cio_d_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 892:     .cio_usb_dp_i           (cio_dp_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 893:     .cio_usb_dn_i           (cio_dn_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 894:     .cio_usb_d_o            (cio_d_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 895:     .cio_usb_se0_o          (cio_se0_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 896:     .cio_usb_dp_o           (cio_dp_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 897:     .cio_usb_dn_o           (cio_dn_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 898:     .cio_usb_oe_o           (cio_oe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 899:     .cio_usb_tx_mode_se_o   (cio_tx_mode_se_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 900:     .cio_usb_sense_i        (cio_sense_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 901:     .cio_usb_dp_pullup_en_o (cio_dp_pullup_en_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 902:     .cio_usb_dn_pullup_en_o (cio_dn_pullup_en_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 903:     .cio_usb_suspend_o      (cio_suspend_o),</pre>
<pre style="margin:0; padding:0 "> 904: </pre>
<pre style="margin:0; padding:0 "> 905:     // Internal interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 906:     .usb_rx_d_o             (usb_rx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 907:     .usb_rx_se0_o           (usb_rx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 908:     .usb_tx_d_i             (usb_tx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 909:     .usb_tx_se0_i           (usb_tx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 910:     .usb_tx_oe_i            (usb_tx_oe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 911:     .usb_pwr_sense_o        (usb_pwr_sense),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 912:     .usb_pullup_en_i        (usb_pullup_en),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 913:     .usb_suspend_i          (usb_event_link_suspend)</pre>
<pre style="margin:0; padding:0 "> 914:   );</pre>
<pre style="margin:0; padding:0 "> 915: </pre>
<pre style="margin:0; padding:0 "> 916:   ////////////////////////</pre>
<pre style="margin:0; padding:0 "> 917:   // USB Output Enables //</pre>
<pre style="margin:0; padding:0 "> 918:   ////////////////////////</pre>
<pre style="margin:0; padding:0 "> 919: </pre>
<pre style="margin:0; padding:0 "> 920:   // Data outputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 921:   assign cio_d_en_o  = cio_oe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 922:   assign cio_dp_en_o = cio_oe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 923:   assign cio_dn_en_o = cio_oe;</pre>
<pre style="margin:0; padding:0 "> 924: </pre>
<pre style="margin:0; padding:0 "> 925:   // Non-data outputs - always enabled.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 926:   assign cio_se0_en_o        = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 927:   assign cio_suspend_en_o    = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 928:   assign cio_tx_mode_se_en_o = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 929: </pre>
<pre style="margin:0; padding:0 "> 930:   // Pullup</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 931:   assign cio_dp_pullup_o     = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 932:   assign cio_dn_pullup_o     = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 933: </pre>
<pre style="margin:0; padding:0 "> 934:   /////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 935:   // SOF Reference for Clock Calibration //</pre>
<pre style="margin:0; padding:0 "> 936:   /////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 937: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 938:   logic usb_ref_val_d, usb_ref_val_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 939:   logic usb_ref_disable;</pre>
<pre style="margin:0; padding:0 "> 940: </pre>
<pre style="margin:0; padding:0 "> 941:   // sys clk -> USB clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 942:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 943:     .Width      (1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 944:   ) usbdev_sync_phy_config (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 945:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 946:     .rst_ni (rst_usb_48mhz_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 947:     .d      (reg2hw.phy_config.usb_ref_disable.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 948:     .q      (usb_ref_disable)</pre>
<pre style="margin:0; padding:0 "> 949:   );</pre>
<pre style="margin:0; padding:0 "> 950: </pre>
<pre style="margin:0; padding:0 "> 951:   // Directly forward the pulse unless disabled.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 952:   assign usb_ref_pulse_o = usb_ref_disable ? 1'b0 : usb_event_frame;</pre>
<pre style="margin:0; padding:0 "> 953: </pre>
<pre style="margin:0; padding:0 "> 954:   // The first pulse is always ignored, but causes the valid to be asserted.</pre>
<pre style="margin:0; padding:0 "> 955:   // The valid signal is deasserted when:</pre>
<pre style="margin:0; padding:0 "> 956:   // - The link is no longer active.</pre>
<pre style="margin:0; padding:0 "> 957:   // - The host is lost (no SOF for 4ms).</pre>
<pre style="margin:0; padding:0 "> 958:   // - The reference generation is disabled.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 959:   assign usb_ref_val_d = usb_ref_pulse_o                           ? 1'b1 :</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 960:       (!usb_link_active || usb_event_host_lost || usb_ref_disable) ? 1'b0 : usb_ref_val_q;</pre>
<pre style="margin:0; padding:0 "> 961: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 962:   always_ff @(posedge clk_usb_48mhz_i or negedge rst_usb_48mhz_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 963:     if (!rst_usb_48mhz_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 964:       usb_ref_val_q <= 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 965:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 966:       usb_ref_val_q <= usb_ref_val_d;</pre>
<pre style="margin:0; padding:0 "> 967:     end</pre>
<pre style="margin:0; padding:0 "> 968:   end</pre>
<pre style="margin:0; padding:0 "> 969: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 970:   assign usb_ref_val_o = usb_ref_val_q;</pre>
<pre style="margin:0; padding:0 "> 971: </pre>
<pre style="margin:0; padding:0 "> 972: endmodule</pre>
<pre style="margin:0; padding:0 "> 973: </pre>
</body>
</html>
