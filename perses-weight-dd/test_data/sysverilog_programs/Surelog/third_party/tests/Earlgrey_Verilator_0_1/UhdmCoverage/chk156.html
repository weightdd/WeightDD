
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ip_usb_fs_nb_pe_0.1/rtl/usb_fs_rx.sv Cov: 100% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Copyright ETH Zurich.</pre>
<pre style="margin:0; padding:0 ">   3: // Copyright Luke Valenty (TinyFPGA project, https://github.com/tinyfpga/TinyFPGA-Bootloader).</pre>
<pre style="margin:0; padding:0 ">   4: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   5: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   6: </pre>
<pre style="margin:0; padding:0 ">   7: module usb_fs_rx (</pre>
<pre style="margin:0; padding:0 ">   8:   // A 48MHz clock is required to recover the clock from the incoming data.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   9:   input  logic clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  10:   input  logic rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  11:   input  logic link_reset_i,</pre>
<pre style="margin:0; padding:0 ">  12: </pre>
<pre style="margin:0; padding:0 ">  13:   // EOP configuration</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  14:   input  logic cfg_eop_single_bit_i,</pre>
<pre style="margin:0; padding:0 ">  15: </pre>
<pre style="margin:0; padding:0 ">  16:   // USB data+ and data- lines (synchronous)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  17:   input  logic usb_d_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:   input  logic usb_se0_i,</pre>
<pre style="margin:0; padding:0 ">  19: </pre>
<pre style="margin:0; padding:0 ">  20:   // Transmit enable disables the receier</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:   input  logic tx_en_i,</pre>
<pre style="margin:0; padding:0 ">  22: </pre>
<pre style="margin:0; padding:0 ">  23:   // pulse on every bit transition.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  24:   output logic bit_strobe_o,</pre>
<pre style="margin:0; padding:0 ">  25: </pre>
<pre style="margin:0; padding:0 ">  26:   // Pulse on beginning of new packet.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  27:   output logic pkt_start_o,</pre>
<pre style="margin:0; padding:0 ">  28: </pre>
<pre style="margin:0; padding:0 ">  29:   // Pulse on end of current packet.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:   output logic pkt_end_o,</pre>
<pre style="margin:0; padding:0 ">  31: </pre>
<pre style="margin:0; padding:0 ">  32:   // Most recent packet decoded.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:   output logic [3:0]  pid_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:   output logic [6:0]  addr_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  35:   output logic [3:0]  endp_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36:   output logic [10:0] frame_num_o,</pre>
<pre style="margin:0; padding:0 ">  37: </pre>
<pre style="margin:0; padding:0 ">  38:   // Pulse on valid data on rx_data.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:   output logic rx_data_put_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:   output logic [7:0] rx_data_o,</pre>
<pre style="margin:0; padding:0 ">  41: </pre>
<pre style="margin:0; padding:0 ">  42:   // Most recent packet passes PID and CRC checks</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:   output logic valid_packet_o,</pre>
<pre style="margin:0; padding:0 ">  44: </pre>
<pre style="margin:0; padding:0 ">  45:   // Error detection</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  46:   output logic crc_error_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:   output logic pid_error_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:   output logic bitstuff_error_o</pre>
<pre style="margin:0; padding:0 ">  49: );</pre>
<pre style="margin:0; padding:0 ">  50: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:   logic [6:0] bitstuff_history_q, bitstuff_history_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:   logic       bitstuff_error;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  53:   logic       bitstuff_error_q, bitstuff_error_d;</pre>
<pre style="margin:0; padding:0 ">  54: </pre>
<pre style="margin:0; padding:0 ">  55:   //////////////////////</pre>
<pre style="margin:0; padding:0 ">  56:   // usb receive path //</pre>
<pre style="margin:0; padding:0 ">  57:   //////////////////////</pre>
<pre style="margin:0; padding:0 ">  58: </pre>
<pre style="margin:0; padding:0 ">  59:   ///////////////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  60:   // line state recovery state machine //</pre>
<pre style="margin:0; padding:0 ">  61:   ///////////////////////////////////////</pre>
<pre style="margin:0; padding:0 ">  62: </pre>
<pre style="margin:0; padding:0 ">  63:   // The receive path doesn't currently use a differential reciever.  because of</pre>
<pre style="margin:0; padding:0 ">  64:   // this there is a chance that one of the differential pairs will appear to have</pre>
<pre style="margin:0; padding:0 ">  65:   // changed to the new state while the other is still in the old state.  the</pre>
<pre style="margin:0; padding:0 ">  66:   // following state machine detects transitions and waits an extra sampling clock</pre>
<pre style="margin:0; padding:0 ">  67:   // before decoding the state on the differential pair.  this transition period</pre>
<pre style="margin:0; padding:0 ">  68:   // will only ever last for one clock as long as there is no noise on the line.</pre>
<pre style="margin:0; padding:0 ">  69:   // if there is enough noise on the line then the data may be corrupted and the</pre>
<pre style="margin:0; padding:0 ">  70:   // packet will fail the data integrity checks.</pre>
<pre style="margin:0; padding:0 ">  71: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  72:   logic [2:0] line_state_q, line_state_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73:   localparam logic [2:0]  DT = 3'b100; // transition state</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:   localparam logic [2:0]  DJ = 3'b010; // J - idle line state</pre>
<pre style="margin:0; padding:0 ">  75:   // localparam logic [2:0]  DK = 3'b001; // K - inverse of J</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76:   localparam logic [2:0] SE0 = 3'b000; // single-ended 0 - end of packet or detached</pre>
<pre style="margin:0; padding:0 ">  77:   // localparam logic [2:0] SE1 = 3'b011; // single-ended 1 - illegal</pre>
<pre style="margin:0; padding:0 ">  78: </pre>
<pre style="margin:0; padding:0 ">  79:   // Mute the input if we're transmitting</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:   logic [1:0] dpair;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  81:   always_comb begin : proc_dpair_mute</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  82:     if (tx_en_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:       dpair = DJ[1:0]; // J</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  84:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  85:       dpair = (usb_se0_i) ? 2'b00 : {usb_d_i, ~usb_d_i};</pre>
<pre style="margin:0; padding:0 ">  86:     end</pre>
<pre style="margin:0; padding:0 ">  87:   end</pre>
<pre style="margin:0; padding:0 ">  88: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_line_state_q</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  90:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  91:       line_state_q <= SE0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  92:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  93:       if (link_reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:         line_state_q <= SE0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:         line_state_q <= line_state_d;</pre>
<pre style="margin:0; padding:0 ">  97:       end</pre>
<pre style="margin:0; padding:0 ">  98:     end</pre>
<pre style="margin:0; padding:0 ">  99:   end</pre>
<pre style="margin:0; padding:0 "> 100: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:   always_comb begin : proc_line_state_d</pre>
<pre style="margin:0; padding:0 "> 102:     // Default assignment</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:     line_state_d = line_state_q;</pre>
<pre style="margin:0; padding:0 "> 104: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:     if (line_state_q == DT) begin</pre>
<pre style="margin:0; padding:0 "> 106:       // if we are in a transition state, then we can sample the pair and</pre>
<pre style="margin:0; padding:0 "> 107:       // move to the next corresponding line state</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 108:       line_state_d = {1'b0, dpair};</pre>
<pre style="margin:0; padding:0 "> 109: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:     end else begin</pre>
<pre style="margin:0; padding:0 "> 111:       // if we are in a valid line state and the value of the pair changes,</pre>
<pre style="margin:0; padding:0 "> 112:       // then we need to move to the transition state</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:       if (dpair != line_state_q[1:0]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:         line_state_d = DT;</pre>
<pre style="margin:0; padding:0 "> 115:       end</pre>
<pre style="margin:0; padding:0 "> 116:     end</pre>
<pre style="margin:0; padding:0 "> 117:   end</pre>
<pre style="margin:0; padding:0 "> 118: </pre>
<pre style="margin:0; padding:0 "> 119:   ////////////////////</pre>
<pre style="margin:0; padding:0 "> 120:   // clock recovery //</pre>
<pre style="margin:0; padding:0 "> 121:   ////////////////////</pre>
<pre style="margin:0; padding:0 "> 122: </pre>
<pre style="margin:0; padding:0 "> 123:   // the DT state from the line state recovery state machine is used to align to</pre>
<pre style="margin:0; padding:0 "> 124:   // transmit clock.  the line state is sampled in the middle of the bit time.</pre>
<pre style="margin:0; padding:0 "> 125: </pre>
<pre style="margin:0; padding:0 "> 126:   // example of signal relationships</pre>
<pre style="margin:0; padding:0 "> 127:   // -------------------------------</pre>
<pre style="margin:0; padding:0 "> 128:   // line_state        DT  DJ  DJ  DJ  DT  DK  DK  DK  DK  DK  DK  DT  DJ  DJ  DJ</pre>
<pre style="margin:0; padding:0 "> 129:   // line_state_valid  ________----____________----____________----________----____</pre>
<pre style="margin:0; padding:0 "> 130:   // bit_phase         0   0   1   2   3   0   1   2   3   0   1   2   0   1   2</pre>
<pre style="margin:0; padding:0 "> 131: </pre>
<pre style="margin:0; padding:0 "> 132: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:   logic [1:0] bit_phase_q, bit_phase_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:   logic line_state_valid;</pre>
<pre style="margin:0; padding:0 "> 135: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:   assign line_state_valid = (bit_phase_q == 2'd1);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 137:   assign bit_strobe_o     = (bit_phase_q == 2'd2);</pre>
<pre style="margin:0; padding:0 "> 138: </pre>
<pre style="margin:0; padding:0 "> 139:   // keep track of phase within each bit</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140:   assign bit_phase_d = (line_state_q == DT) ? 0 : bit_phase_q + 1;</pre>
<pre style="margin:0; padding:0 "> 141: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_bit_phase_q</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:       bit_phase_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146:       if (link_reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:         bit_phase_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:         bit_phase_q <= bit_phase_d;</pre>
<pre style="margin:0; padding:0 "> 150:       end</pre>
<pre style="margin:0; padding:0 "> 151:     end</pre>
<pre style="margin:0; padding:0 "> 152:   end</pre>
<pre style="margin:0; padding:0 "> 153: </pre>
<pre style="margin:0; padding:0 "> 154: </pre>
<pre style="margin:0; padding:0 "> 155:   //////////////////////</pre>
<pre style="margin:0; padding:0 "> 156:   // packet detection //</pre>
<pre style="margin:0; padding:0 "> 157:   //////////////////////</pre>
<pre style="margin:0; padding:0 "> 158: </pre>
<pre style="margin:0; padding:0 "> 159:   // usb uses a sync to denote the beginning of a packet and two single-ended-0 to</pre>
<pre style="margin:0; padding:0 "> 160:   // denote the end of a packet.  this state machine recognizes the beginning and</pre>
<pre style="margin:0; padding:0 "> 161:   // end of packets for subsequent layers to process.</pre>
<pre style="margin:0; padding:0 "> 162: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 163:   logic [11:0] line_history_q, line_history_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 164:   logic packet_valid_q, packet_valid_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:   logic see_eop, packet_start, packet_end;</pre>
<pre style="margin:0; padding:0 "> 166: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:   assign packet_start = packet_valid_d & ~packet_valid_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:   assign packet_end   = ~packet_valid_d & packet_valid_q;</pre>
<pre style="margin:0; padding:0 "> 169: </pre>
<pre style="margin:0; padding:0 "> 170:   // EOP detection is configurable for 1/2 bit periods of SE0.</pre>
<pre style="margin:0; padding:0 "> 171:   // The standard (Table 7-7) mandates min = 82 ns = 1 bit period.</pre>
<pre style="margin:0; padding:0 "> 172:   // We also trigger an EOP on seeing a bitstuff error.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 173:   assign see_eop = (cfg_eop_single_bit_i && line_history_q[1:0] == 2'b00)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174:     || (line_history_q[3:0] == 4'b0000) || bitstuff_error_q;</pre>
<pre style="margin:0; padding:0 "> 175: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176:   always_comb begin : proc_packet_valid_d</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 177:     if (line_state_valid) begin</pre>
<pre style="margin:0; padding:0 "> 178:       // check for packet start: KJKJKK, we use the last 6 bits</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 179:       if (!packet_valid_q && line_history_q[11:0] == 12'b011001100101) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180:         packet_valid_d = 1;</pre>
<pre style="margin:0; padding:0 "> 181:       end</pre>
<pre style="margin:0; padding:0 "> 182: </pre>
<pre style="margin:0; padding:0 "> 183:       // check for packet end: SE0 SE0</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:       else if (packet_valid_q && see_eop) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:         packet_valid_d = 0;</pre>
<pre style="margin:0; padding:0 "> 186: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:         packet_valid_d = packet_valid_q;</pre>
<pre style="margin:0; padding:0 "> 189:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 191:       packet_valid_d = packet_valid_q;</pre>
<pre style="margin:0; padding:0 "> 192:     end</pre>
<pre style="margin:0; padding:0 "> 193:   end</pre>
<pre style="margin:0; padding:0 "> 194: </pre>
<pre style="margin:0; padding:0 "> 195:   // keep a history of the last two states on the line</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:   assign line_history_d = line_state_valid ? {line_history_q[9:0], line_state_q[1:0]} :</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:                                               line_history_q;</pre>
<pre style="margin:0; padding:0 "> 198: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_reg_pkt_line</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 201:       packet_valid_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 202:       line_history_q <= 12'b101010101010; // all K</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 204:       if (link_reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205:         packet_valid_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 206:         line_history_q <= 12'b101010101010; // all K</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 207:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 208:         packet_valid_q <= packet_valid_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:         line_history_q <= line_history_d;</pre>
<pre style="margin:0; padding:0 "> 210:       end</pre>
<pre style="margin:0; padding:0 "> 211:     end</pre>
<pre style="margin:0; padding:0 "> 212:   end</pre>
<pre style="margin:0; padding:0 "> 213: </pre>
<pre style="margin:0; padding:0 "> 214: </pre>
<pre style="margin:0; padding:0 "> 215:   /////////////////</pre>
<pre style="margin:0; padding:0 "> 216:   // NRZI decode //</pre>
<pre style="margin:0; padding:0 "> 217:   /////////////////</pre>
<pre style="margin:0; padding:0 "> 218: </pre>
<pre style="margin:0; padding:0 "> 219:   // in order to ensure there are enough bit transitions for a receiver to recover</pre>
<pre style="margin:0; padding:0 "> 220:   // the clock usb uses NRZI encoding.</pre>
<pre style="margin:0; padding:0 "> 221: </pre>
<pre style="margin:0; padding:0 "> 222:   // https://en.wikipedia.org/wiki/Non-return-to-zero</pre>
<pre style="margin:0; padding:0 "> 223: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:   logic dvalid_raw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 225:   logic din;</pre>
<pre style="margin:0; padding:0 "> 226: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 227:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 228:     unique case (line_history_q[3:0])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 229:       4'b0101 : din = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 230:       4'b0110 : din = 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:       4'b1001 : din = 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 232:       4'b1010 : din = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 233:       default : din = 0;</pre>
<pre style="margin:0; padding:0 "> 234:     endcase</pre>
<pre style="margin:0; padding:0 "> 235: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236:     if (packet_valid_q && line_state_valid) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:       unique case (line_history_q[3:0])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:         4'b0101 : dvalid_raw = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 239:         4'b0110 : dvalid_raw = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 240:         4'b1001 : dvalid_raw = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 241:         4'b1010 : dvalid_raw = 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 242:         default : dvalid_raw = 0;</pre>
<pre style="margin:0; padding:0 "> 243:       endcase</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:       dvalid_raw = 0;</pre>
<pre style="margin:0; padding:0 "> 246:     end</pre>
<pre style="margin:0; padding:0 "> 247:   end</pre>
<pre style="margin:0; padding:0 "> 248: </pre>
<pre style="margin:0; padding:0 "> 249:   //////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 250:   // Undo bit stuffing and detect bit stuffing errors //</pre>
<pre style="margin:0; padding:0 "> 251:   //////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 252: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:   always_comb begin : proc_bitstuff_history_d</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:     if (packet_end) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:       bitstuff_history_d = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 256:     end else if (dvalid_raw) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 257:       bitstuff_history_d = {bitstuff_history_q[5:0], din};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 259:       bitstuff_history_d = bitstuff_history_q;</pre>
<pre style="margin:0; padding:0 "> 260:     end</pre>
<pre style="margin:0; padding:0 "> 261:   end</pre>
<pre style="margin:0; padding:0 "> 262: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_bitstuff_history_q</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 265:       bitstuff_history_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 266:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:       if (link_reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 268:         bitstuff_history_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 270:         bitstuff_history_q <= bitstuff_history_d;</pre>
<pre style="margin:0; padding:0 "> 271:       end</pre>
<pre style="margin:0; padding:0 "> 272:     end</pre>
<pre style="margin:0; padding:0 "> 273:   end</pre>
<pre style="margin:0; padding:0 "> 274: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 275:   logic dvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:   assign dvalid = dvalid_raw && !(bitstuff_history_q[5:0] == 6'b111111);</pre>
<pre style="margin:0; padding:0 "> 277: </pre>
<pre style="margin:0; padding:0 "> 278:   // 7 consecutive ones should not be seen on the bus</pre>
<pre style="margin:0; padding:0 "> 279:   // USB spec, 7.1.9.1: "If the receiver sees seven</pre>
<pre style="margin:0; padding:0 "> 280:   // consecutive ones anywhere in the packet, then a bit stuffing error</pre>
<pre style="margin:0; padding:0 "> 281:   // has occurred and the packet should be ignored."</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 282:   assign bitstuff_error = bitstuff_history_q == 7'b1111111;</pre>
<pre style="margin:0; padding:0 "> 283: </pre>
<pre style="margin:0; padding:0 "> 284:   // remember the bitstuff errors</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285:   always_comb begin : proc_bistuff_error_d</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 286:     bitstuff_error_d = bitstuff_error_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 287:     if (packet_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288:       bitstuff_error_d = 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:     end else if (bitstuff_error && dvalid_raw) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:       bitstuff_error_d = 1;</pre>
<pre style="margin:0; padding:0 "> 291:     end</pre>
<pre style="margin:0; padding:0 "> 292:   end</pre>
<pre style="margin:0; padding:0 "> 293: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 294:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_bitstuff_error_q</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 295:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:       bitstuff_error_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 298:       bitstuff_error_q <= bitstuff_error_d;</pre>
<pre style="margin:0; padding:0 "> 299:     end</pre>
<pre style="margin:0; padding:0 "> 300:   end</pre>
<pre style="margin:0; padding:0 "> 301: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 302:   assign bitstuff_error_o = bitstuff_error_q && packet_end;</pre>
<pre style="margin:0; padding:0 "> 303: </pre>
<pre style="margin:0; padding:0 "> 304: </pre>
<pre style="margin:0; padding:0 "> 305:   ////////////////////////</pre>
<pre style="margin:0; padding:0 "> 306:   // save and check pid //</pre>
<pre style="margin:0; padding:0 "> 307:   ////////////////////////</pre>
<pre style="margin:0; padding:0 "> 308: </pre>
<pre style="margin:0; padding:0 "> 309:   // shift in the entire 8-bit pid with an additional 9th bit used as a sentinal.</pre>
<pre style="margin:0; padding:0 "> 310: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:   logic [8:0] full_pid_q, full_pid_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312:   logic pid_valid, pid_complete;</pre>
<pre style="margin:0; padding:0 "> 313: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314:   assign pid_valid    = full_pid_q[4:1] == ~full_pid_q[8:5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 315:   assign pid_complete = full_pid_q[0];</pre>
<pre style="margin:0; padding:0 "> 316: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:   always_comb begin : proc_full_pid_d</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:     if (dvalid && !pid_complete) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:       full_pid_d = {din, full_pid_q[8:1]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 320:     end else if (packet_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:       full_pid_d = 9'b100000000;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 323:       full_pid_d = full_pid_q;</pre>
<pre style="margin:0; padding:0 "> 324:     end</pre>
<pre style="margin:0; padding:0 "> 325:   end</pre>
<pre style="margin:0; padding:0 "> 326: </pre>
<pre style="margin:0; padding:0 "> 327:   ////////////////</pre>
<pre style="margin:0; padding:0 "> 328:   // check crc5 //</pre>
<pre style="margin:0; padding:0 "> 329:   ////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:   logic [4:0] crc5_q, crc5_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:   logic crc5_valid, crc5_invert;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:   assign crc5_valid  = crc5_q == 5'b01100;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:   assign crc5_invert = din ^ crc5_q[4];</pre>
<pre style="margin:0; padding:0 "> 334: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 335:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:     crc5_d = crc5_q; // default value</pre>
<pre style="margin:0; padding:0 "> 337: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 338:     if (packet_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 339:       crc5_d = 5'b11111;</pre>
<pre style="margin:0; padding:0 "> 340:     end</pre>
<pre style="margin:0; padding:0 "> 341: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 342:     if (dvalid && pid_complete) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:       crc5_d = {crc5_q[3:0], 1'b0} ^ ({5{crc5_invert}} & 5'b00101);</pre>
<pre style="margin:0; padding:0 "> 344:     end</pre>
<pre style="margin:0; padding:0 "> 345:   end</pre>
<pre style="margin:0; padding:0 "> 346: </pre>
<pre style="margin:0; padding:0 "> 347: </pre>
<pre style="margin:0; padding:0 "> 348:   /////////////////</pre>
<pre style="margin:0; padding:0 "> 349:   // check crc16 //</pre>
<pre style="margin:0; padding:0 "> 350:   /////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:   logic [15:0] crc16_q, crc16_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:   logic crc16_valid, crc16_invert;</pre>
<pre style="margin:0; padding:0 "> 353: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354:   assign crc16_valid  = crc16_q == 16'b1000000000001101;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:   assign crc16_invert = din ^ crc16_q[15];</pre>
<pre style="margin:0; padding:0 "> 356: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 357:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:     crc16_d = crc16_q; // default value</pre>
<pre style="margin:0; padding:0 "> 359: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:     if (packet_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:       crc16_d = 16'b1111111111111111;</pre>
<pre style="margin:0; padding:0 "> 362:     end</pre>
<pre style="margin:0; padding:0 "> 363: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:     if (dvalid && pid_complete) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:       crc16_d = {crc16_q[14:0], 1'b0} ^ ({16{crc16_invert}} & 16'b1000000000000101);</pre>
<pre style="margin:0; padding:0 "> 366:     end</pre>
<pre style="margin:0; padding:0 "> 367:   end</pre>
<pre style="margin:0; padding:0 "> 368: </pre>
<pre style="margin:0; padding:0 "> 369: </pre>
<pre style="margin:0; padding:0 "> 370:   ////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 371:   // output control signals //</pre>
<pre style="margin:0; padding:0 "> 372:   ////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 373:   logic pkt_is_token, pkt_is_data, pkt_is_handshake;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 374:   assign pkt_is_token     = full_pid_q[2:1] == 2'b01;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 375:   assign pkt_is_data      = full_pid_q[2:1] == 2'b11;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:   assign pkt_is_handshake = full_pid_q[2:1] == 2'b10;</pre>
<pre style="margin:0; padding:0 "> 377: </pre>
<pre style="margin:0; padding:0 "> 378: </pre>
<pre style="margin:0; padding:0 "> 379:   // TODO: need to check for data packet babble</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:   assign valid_packet_o = pid_valid && !bitstuff_error_q &&</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     ((pkt_is_handshake) ||</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:     (pkt_is_data && crc16_valid) ||</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 383:     (pkt_is_token && crc5_valid)</pre>
<pre style="margin:0; padding:0 "> 384:   );</pre>
<pre style="margin:0; padding:0 "> 385: </pre>
<pre style="margin:0; padding:0 "> 386:   // Detect CRC errors</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:   assign crc_error_o = ((pkt_is_data && !crc16_valid) ||</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:     (pkt_is_token && !crc5_valid)) && packet_end;</pre>
<pre style="margin:0; padding:0 "> 389: </pre>
<pre style="margin:0; padding:0 "> 390:   // Detect PID errors</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:   assign pid_error_o = !pid_valid && packet_end;</pre>
<pre style="margin:0; padding:0 "> 392: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 393:   logic [11:0] token_payload_q, token_payload_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:   logic token_payload_done;</pre>
<pre style="margin:0; padding:0 "> 395: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 396:   assign token_payload_done = token_payload_q[0];</pre>
<pre style="margin:0; padding:0 "> 397: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 398:   logic [6:0] addr_q, addr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 399:   logic [3:0] endp_q, endp_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:   logic [10:0] frame_num_q, frame_num_d;</pre>
<pre style="margin:0; padding:0 "> 401: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 403:     token_payload_d = token_payload_q; // default</pre>
<pre style="margin:0; padding:0 "> 404: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 405:     if (packet_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 406:       token_payload_d = 12'b100000000000;</pre>
<pre style="margin:0; padding:0 "> 407:     end</pre>
<pre style="margin:0; padding:0 "> 408: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:     if (dvalid && pid_complete && pkt_is_token && !token_payload_done) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 410:       token_payload_d = {din, token_payload_q[11:1]};</pre>
<pre style="margin:0; padding:0 "> 411:     end</pre>
<pre style="margin:0; padding:0 "> 412:   end</pre>
<pre style="margin:0; padding:0 "> 413: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 414:   always_comb begin</pre>
<pre style="margin:0; padding:0 "> 415:     // defaults</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:     addr_d      = addr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 417:     endp_d      = endp_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 418:     frame_num_d = frame_num_q;</pre>
<pre style="margin:0; padding:0 "> 419: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 420:     if (token_payload_done && pkt_is_token) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 421:       addr_d      = token_payload_q[7:1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 422:       endp_d      = token_payload_q[11:8];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 423:       frame_num_d = token_payload_q[11:1];</pre>
<pre style="margin:0; padding:0 "> 424:     end</pre>
<pre style="margin:0; padding:0 "> 425:   end</pre>
<pre style="margin:0; padding:0 "> 426: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 427:   assign addr_o      = addr_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 428:   assign endp_o      = endp_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 429:   assign frame_num_o = frame_num_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 430:   assign pid_o       = full_pid_q[4:1];</pre>
<pre style="margin:0; padding:0 "> 431: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:   assign pkt_start_o = packet_start;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 433:   assign pkt_end_o   = packet_end;</pre>
<pre style="margin:0; padding:0 "> 434: </pre>
<pre style="margin:0; padding:0 "> 435: </pre>
<pre style="margin:0; padding:0 "> 436:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 437:   // deserialize and output data //</pre>
<pre style="margin:0; padding:0 "> 438:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 439:   //assign rx_data_put = dvalid && pid_complete && pkt_is_data;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 440:   logic [8:0] rx_data_buffer_q, rx_data_buffer_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:   logic rx_data_buffer_full;</pre>
<pre style="margin:0; padding:0 "> 442: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 443:   assign rx_data_buffer_full = rx_data_buffer_q[0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 444:   assign rx_data_put_o       = rx_data_buffer_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 445:   assign rx_data_o           = rx_data_buffer_q[8:1];</pre>
<pre style="margin:0; padding:0 "> 446: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 447:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 448:     rx_data_buffer_d = rx_data_buffer_q; // default</pre>
<pre style="margin:0; padding:0 "> 449: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 450:     if (packet_start || rx_data_buffer_full) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 451:       rx_data_buffer_d = 9'b100000000;</pre>
<pre style="margin:0; padding:0 "> 452:     end</pre>
<pre style="margin:0; padding:0 "> 453: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 454:     if (dvalid && pid_complete && pkt_is_data) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 455:       rx_data_buffer_d = {din, rx_data_buffer_q[8:1]};</pre>
<pre style="margin:0; padding:0 "> 456:     end</pre>
<pre style="margin:0; padding:0 "> 457:   end</pre>
<pre style="margin:0; padding:0 "> 458: </pre>
<pre style="margin:0; padding:0 "> 459: </pre>
<pre style="margin:0; padding:0 "> 460:   ///////////////</pre>
<pre style="margin:0; padding:0 "> 461:   // Registers //</pre>
<pre style="margin:0; padding:0 "> 462:   ///////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:   always_ff @(posedge clk_i or negedge rst_ni) begin : proc_gp_regs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 464:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:       full_pid_q          <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466:       crc16_q             <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 467:       crc5_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468:       token_payload_q     <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 469:       addr_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:       endp_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:       frame_num_q         <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:       rx_data_buffer_q    <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:       if (link_reset_i) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 475:         full_pid_q          <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 476:         crc16_q             <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:         crc5_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 478:         token_payload_q     <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 479:         addr_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:         endp_q              <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 481:         frame_num_q         <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 482:         rx_data_buffer_q    <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 483:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:         full_pid_q          <= full_pid_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:         crc16_q             <= crc16_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 486:         crc5_q              <= crc5_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 487:         token_payload_q     <= token_payload_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 488:         addr_q              <= addr_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 489:         endp_q              <= endp_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 490:         frame_num_q         <= frame_num_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 491:         rx_data_buffer_q    <= rx_data_buffer_d;</pre>
<pre style="margin:0; padding:0 "> 492:       end</pre>
<pre style="margin:0; padding:0 "> 493:     end</pre>
<pre style="margin:0; padding:0 "> 494:   end</pre>
<pre style="margin:0; padding:0 "> 495: </pre>
<pre style="margin:0; padding:0 "> 496: endmodule // usb_fs_rx</pre>
<pre style="margin:0; padding:0 "> 497: </pre>
</body>
</html>
