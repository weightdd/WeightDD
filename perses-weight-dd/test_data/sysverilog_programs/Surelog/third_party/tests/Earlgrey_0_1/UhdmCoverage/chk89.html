
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>hw/ip/usbdev/rtl/usbdev.sv Cov: 100% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   3: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   4: //</pre>
<pre style="margin:0; padding:0 ">   5: // USB Full-Speed Device Interface (usbdev).</pre>
<pre style="margin:0; padding:0 ">   6: //</pre>
<pre style="margin:0; padding:0 ">   7: //</pre>
<pre style="margin:0; padding:0 ">   8: </pre>
<pre style="margin:0; padding:0 ">   9: </pre>
<pre style="margin:0; padding:0 ">  10: module usbdev (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  11:   input  logic       clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  12:   input  logic       rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  13:   input  logic       clk_usb_48mhz_i, // use usb_ prefix for signals in this clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  14:   input  logic       rst_usb_ni, // async reset, with relase sync to clk_usb_48_mhz_i</pre>
<pre style="margin:0; padding:0 ">  15: </pre>
<pre style="margin:0; padding:0 ">  16:   // Register interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  17:   input  tlul_pkg::tl_h2d_t tl_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:   output tlul_pkg::tl_d2h_t tl_o,</pre>
<pre style="margin:0; padding:0 ">  19: </pre>
<pre style="margin:0; padding:0 ">  20:   // USB Interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:   input  logic       cio_usb_d_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  22:   input  logic       cio_usb_dp_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  23:   input  logic       cio_usb_dn_i,</pre>
<pre style="margin:0; padding:0 ">  24: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  25:   output logic       cio_usb_d_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:   output logic       cio_usb_se0_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  27:   output logic       cio_usb_dp_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  28:   output logic       cio_usb_dn_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  29:   output logic       cio_usb_oe_o,</pre>
<pre style="margin:0; padding:0 ">  30: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  31:   output logic       cio_usb_tx_mode_se_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  32:   input  logic       cio_usb_sense_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:   output logic       cio_usb_pullup_en_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:   output logic       cio_usb_suspend_o,</pre>
<pre style="margin:0; padding:0 ">  35: </pre>
<pre style="margin:0; padding:0 ">  36:   // Interrupts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:   output logic       intr_pkt_received_o, // Packet received</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  38:   output logic       intr_pkt_sent_o, // Packet sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:   output logic       intr_connected_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:   output logic       intr_disconnected_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  41:   output logic       intr_host_lost_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  42:   output logic       intr_link_reset_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:   output logic       intr_link_suspend_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:   output logic       intr_link_resume_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  45:   output logic       intr_av_empty_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  46:   output logic       intr_rx_full_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:   output logic       intr_av_overflow_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:   output logic       intr_link_in_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  49:   output logic       intr_rx_crc_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50:   output logic       intr_rx_pid_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:   output logic       intr_rx_bitstuff_err_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:   output logic       intr_frame_o</pre>
<pre style="margin:0; padding:0 ">  53: );</pre>
<pre style="margin:0; padding:0 ">  54: </pre>
<pre style="margin:0; padding:0 ">  55:   import usbdev_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  56: </pre>
<pre style="margin:0; padding:0 ">  57:   // Could make SramDepth, MaxPktSizeByte, AVFifoDepth and RXFifoDepth</pre>
<pre style="margin:0; padding:0 ">  58:   // module parameters but may need to fix register def for the first two</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:   localparam int SramDw = 32; // Places packing bytes to SRAM assume this</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:   localparam int SramDepth = 512; // 2kB, SRAM Width is DW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:   localparam int MaxPktSizeByte = 64;</pre>
<pre style="margin:0; padding:0 ">  62: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63:   localparam int SramAw = $clog2(SramDepth);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  64:   localparam int SizeWidth = $clog2(MaxPktSizeByte);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  65:   localparam int NBuf = (SramDepth * SramDw) / (MaxPktSizeByte * 8);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:   localparam int NBufWidth = $clog2(NBuf);</pre>
<pre style="margin:0; padding:0 ">  67: </pre>
<pre style="margin:0; padding:0 ">  68:   // AV fifo just stores buffer numbers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  69:   localparam int AVFifoWidth = NBufWidth;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:   localparam int AVFifoDepth = 4;</pre>
<pre style="margin:0; padding:0 ">  71: </pre>
<pre style="margin:0; padding:0 ">  72:   // RX fifo stores              buf# +  size(0-MaxPktSizeByte)  + EP# + Type</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73:   localparam int RXFifoWidth = NBufWidth + (1+SizeWidth)         +  4  + 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:   localparam int RXFifoDepth = 4;</pre>
<pre style="margin:0; padding:0 ">  75: </pre>
<pre style="margin:0; padding:0 ">  76:   // Number of endpoints</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:   localparam int NEndpoints = usbdev_reg_pkg::NEndpoints;</pre>
<pre style="margin:0; padding:0 ">  78: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  79:   usbdev_reg2hw_t reg2hw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:   usbdev_hw2reg_t hw2reg;</pre>
<pre style="margin:0; padding:0 ">  81: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  82:   tlul_pkg::tl_h2d_t tl_sram_h2d [1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:   tlul_pkg::tl_d2h_t tl_sram_d2h [1];</pre>
<pre style="margin:0; padding:0 ">  84: </pre>
<pre style="margin:0; padding:0 ">  85:   // Dual-port SRAM Interface: Refer prim_ram_2p_wrapper.sv</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  86:   logic              mem_a_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:   logic              mem_a_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:   logic [SramAw-1:0] mem_a_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:   logic [SramDw-1:0] mem_a_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  90:   logic              mem_a_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  91:   logic [SramDw-1:0] mem_a_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  92:   logic [1:0]        mem_a_rerror;</pre>
<pre style="margin:0; padding:0 ">  93: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:   logic              usb_mem_b_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:   logic              usb_mem_b_write;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:   logic [SramAw-1:0] usb_mem_b_addr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:   logic [SramDw-1:0] usb_mem_b_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  98:   logic [SramDw-1:0] usb_mem_b_rdata;</pre>
<pre style="margin:0; padding:0 ">  99: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:   logic              usb_clr_devaddr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:   logic              usb_event_av_empty, event_av_overflow, usb_event_rx_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102:   logic              event_av_empty, event_rx_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:   logic              usb_event_link_reset, usb_event_link_suspend, usb_event_link_resume;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:   logic              usb_event_host_lost, usb_event_disconnect, usb_event_connect;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:   logic              usb_event_rx_crc_err, usb_event_rx_pid_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 106:   logic              usb_event_rx_bitstuff_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 107:   logic              usb_event_in_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 108:   logic              usb_event_frame;</pre>
<pre style="margin:0; padding:0 "> 109: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:   logic              event_link_reset, event_link_suspend, event_link_resume;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:   logic              event_host_lost, event_disconnect, event_connect;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:   logic              event_rx_crc_err, event_rx_pid_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:   logic              event_rx_bitstuff_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:   logic              event_in_err;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115:   logic              event_frame;</pre>
<pre style="margin:0; padding:0 "> 116: </pre>
<pre style="margin:0; padding:0 "> 117:   // CDC signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 118:   logic [10:0]       usb_frame;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 119:   logic [2:0]        usb_link_state;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:   logic              usb_enable;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:   logic [6:0]        usb_device_addr;</pre>
<pre style="margin:0; padding:0 "> 122: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 123:   logic                  usb_data_toggle_clear_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 124:   logic [NEndpoints-1:0] usb_data_toggle_clear;</pre>
<pre style="margin:0; padding:0 "> 125: </pre>
<pre style="margin:0; padding:0 "> 126: </pre>
<pre style="margin:0; padding:0 "> 127:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 128:   // USB IO after CDC & muxing   //</pre>
<pre style="margin:0; padding:0 "> 129:   /////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 130:   logic usb_rx_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 131:   logic usb_rx_se0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132:   logic usb_tx_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:   logic usb_tx_se0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:   logic usb_tx_oe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:   logic usb_pwr_sense;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:   logic usb_pullup_en;</pre>
<pre style="margin:0; padding:0 "> 137: </pre>
<pre style="margin:0; padding:0 "> 138:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 139:   // Receive interface fifos //</pre>
<pre style="margin:0; padding:0 "> 140:   /////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 141: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:   logic              av_fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:   logic              event_pkt_received;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:   logic              usb_av_rvalid, usb_av_rready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:   logic              usb_rx_wvalid, usb_rx_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146:   logic              rx_fifo_rvalid;</pre>
<pre style="margin:0; padding:0 "> 147: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:   logic [AVFifoWidth - 1:0] usb_av_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:   logic [RXFifoWidth - 1:0] usb_rx_wdata, rx_rdata_raw, rx_rdata;</pre>
<pre style="margin:0; padding:0 "> 150: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151:   assign event_av_overflow = reg2hw.avbuffer.qe & (~av_fifo_wready);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:   assign hw2reg.usbstat.av_full.d = ~av_fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 153:   assign hw2reg.usbstat.rx_empty.d = ~rx_fifo_rvalid;</pre>
<pre style="margin:0; padding:0 "> 154: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 155:   prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 156:     .Width(AVFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 157:     .Depth(AVFifoDepth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:   ) usbdev_avfifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:     .clk_wr_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:     .rst_wr_ni (rst_ni),</pre>
<pre style="margin:0; padding:0 "> 161: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 162:     .wvalid    (reg2hw.avbuffer.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 163:     .wready    (av_fifo_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 164:     .wdata     (reg2hw.avbuffer.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:     .wdepth    (hw2reg.usbstat.av_depth.d),</pre>
<pre style="margin:0; padding:0 "> 166: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:     .clk_rd_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:     .rst_rd_ni (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 169:     .rvalid    (usb_av_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:     .rready    (usb_av_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 171:     .rdata     (usb_av_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:     .rdepth    () // only using empty</pre>
<pre style="margin:0; padding:0 "> 173:   );</pre>
<pre style="margin:0; padding:0 "> 174: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:   prim_fifo_async #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176:     .Width(RXFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 177:     .Depth(RXFifoDepth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 178:   ) usbdev_rxfifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 179:     .clk_wr_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 180:     .rst_wr_ni (rst_usb_ni),</pre>
<pre style="margin:0; padding:0 "> 181: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 182:     .wvalid    (usb_rx_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 183:     .wready    (usb_rx_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:     .wdata     (usb_rx_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:     .wdepth    (),</pre>
<pre style="margin:0; padding:0 "> 186: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:     .clk_rd_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:     .rst_rd_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:     .rvalid    (rx_fifo_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190:     .rready    (reg2hw.rxfifo.buffer.re),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 191:     .rdata     (rx_rdata_raw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 192:     .rdepth    (hw2reg.usbstat.rx_depth.d)</pre>
<pre style="margin:0; padding:0 "> 193:   );</pre>
<pre style="margin:0; padding:0 "> 194: </pre>
<pre style="margin:0; padding:0 "> 195:   // Return all zero if the FIFO is empty (instead of X)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:   assign rx_rdata = rx_fifo_rvalid ? rx_rdata_raw : '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:   assign hw2reg.rxfifo.ep.d = rx_rdata[16:13];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:   assign hw2reg.rxfifo.setup.d = rx_rdata[12];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:   assign hw2reg.rxfifo.size.d = rx_rdata[11:5];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:   assign hw2reg.rxfifo.buffer.d = rx_rdata[4:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 201:   assign event_pkt_received = rx_fifo_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 202:   logic [2:0]               unused_re;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:   assign unused_re = {reg2hw.rxfifo.ep.re, reg2hw.rxfifo.setup.re, reg2hw.rxfifo.size.re};</pre>
<pre style="margin:0; padding:0 "> 204: </pre>
<pre style="margin:0; padding:0 "> 205:   ////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 206:   // IN (Transmit) interface config //</pre>
<pre style="margin:0; padding:0 "> 207:   ////////////////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 208:   logic [NBufWidth-1:0]  usb_in_buf [NEndpoints];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:   logic [SizeWidth:0]    usb_in_size [NEndpoints];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 210:   logic [3:0]            usb_in_endpoint;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 211:   logic [NEndpoints-1:0] usb_in_rdy;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:   logic [NEndpoints-1:0] clear_rdybit, set_sentbit, update_pend;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 213:   logic                  usb_setup_received, setup_received, usb_set_sent, set_sent;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 214:   logic [NEndpoints-1:0] ep_iso;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 215:   logic [NEndpoints-1:0] enable_setup, enable_out, ep_stall;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:   logic [NEndpoints-1:0] usb_enable_setup, usb_enable_out, usb_ep_stall;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:   logic [NEndpoints-1:0] in_rdy_async;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 218:   logic [3:0]            usb_out_endpoint;</pre>
<pre style="margin:0; padding:0 "> 219: </pre>
<pre style="margin:0; padding:0 "> 220:   // RX enables</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:   always_comb begin : proc_map_rxenable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 222:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 223:       enable_setup[i] = reg2hw.rxenable_setup[i].q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:       enable_out[i]   = reg2hw.rxenable_out[i].q;</pre>
<pre style="margin:0; padding:0 "> 225:     end</pre>
<pre style="margin:0; padding:0 "> 226:   end</pre>
<pre style="margin:0; padding:0 "> 227: </pre>
<pre style="margin:0; padding:0 "> 228:   // STALL for both directions</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 229:   always_comb begin : proc_map_stall</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 230:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:       ep_stall[i] = reg2hw.stall[i];</pre>
<pre style="margin:0; padding:0 "> 232:     end</pre>
<pre style="margin:0; padding:0 "> 233:   end</pre>
<pre style="margin:0; padding:0 "> 234: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236:     .Width(3*NEndpoints)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:   ) usbdev_sync_ep_cfg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 239:     .rst_ni (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 240:     .d      ({enable_setup, enable_out, ep_stall}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 241:     .q      ({usb_enable_setup, usb_enable_out, usb_ep_stall})</pre>
<pre style="margin:0; padding:0 "> 242:   );</pre>
<pre style="margin:0; padding:0 "> 243: </pre>
<pre style="margin:0; padding:0 "> 244:   // CDC: ok, quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:   always_comb begin : proc_map_iso</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:       ep_iso[i] = reg2hw.iso[i].q;</pre>
<pre style="margin:0; padding:0 "> 248:     end</pre>
<pre style="margin:0; padding:0 "> 249:   end</pre>
<pre style="margin:0; padding:0 "> 250: </pre>
<pre style="margin:0; padding:0 "> 251:   // CDC: flop_2sync for ready bit covers others so assigns are ok</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:   always_comb begin : proc_map_buf_size</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:       usb_in_buf[i]  = reg2hw.configin[i].buffer.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:       usb_in_size[i] = reg2hw.configin[i].size.q;</pre>
<pre style="margin:0; padding:0 "> 256:     end</pre>
<pre style="margin:0; padding:0 "> 257:   end</pre>
<pre style="margin:0; padding:0 "> 258: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 259:   always_comb begin : proc_map_rdy_reg2hw</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 260:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:       in_rdy_async[i] = reg2hw.configin[i].rdy.q;</pre>
<pre style="margin:0; padding:0 "> 262:     end</pre>
<pre style="margin:0; padding:0 "> 263:   end</pre>
<pre style="margin:0; padding:0 "> 264: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 265:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 266:     .Width (NEndpoints)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:   ) usbdev_rdysync (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 268:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:     .rst_ni (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 270:     .d      (in_rdy_async),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 271:     .q      (usb_in_rdy)</pre>
<pre style="margin:0; padding:0 "> 272:   );</pre>
<pre style="margin:0; padding:0 "> 273: </pre>
<pre style="margin:0; padding:0 "> 274:   // CDC: We synchronize the qe (write pulse) and assume that the</pre>
<pre style="margin:0; padding:0 "> 275:   // rest of the register remains stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:   prim_pulse_sync usbdev_data_toggle_clear (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 277:     .clk_src_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 278:     .clk_dst_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 279:     .rst_src_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 280:     .rst_dst_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 281:     .src_pulse_i (reg2hw.data_toggle_clear[0].qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 282:     .dst_pulse_o (usb_data_toggle_clear_en)</pre>
<pre style="margin:0; padding:0 "> 283:   );</pre>
<pre style="margin:0; padding:0 "> 284: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285:   always_comb begin : proc_usb_data_toggle_clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 286:     usb_data_toggle_clear = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 287:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288:       if (usb_data_toggle_clear_en) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:         usb_data_toggle_clear[i] = reg2hw.data_toggle_clear[i].q;</pre>
<pre style="margin:0; padding:0 "> 290:       end</pre>
<pre style="margin:0; padding:0 "> 291:     end</pre>
<pre style="margin:0; padding:0 "> 292:   end</pre>
<pre style="margin:0; padding:0 "> 293: </pre>
<pre style="margin:0; padding:0 "> 294:   // Clear of ready and set of sent is a pulse in USB clock domain</pre>
<pre style="margin:0; padding:0 "> 295:   // but needs to ensure register bit is cleared/set in TLUL domain</pre>
<pre style="margin:0; padding:0 "> 296:   // usbdev_pulsesync takes pulse in clk_src to pulse in clk_dst</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:   prim_pulse_sync usbdev_setsent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 298:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 300:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 301:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 302:     .src_pulse_i (usb_set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 303:     .dst_pulse_o (set_sent)</pre>
<pre style="margin:0; padding:0 "> 304:   );</pre>
<pre style="margin:0; padding:0 "> 305: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 306:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 307:     set_sentbit = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 308:     if (set_sent) begin</pre>
<pre style="margin:0; padding:0 "> 309:       // synchronization of set_sent ensures usb_endpoint is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 310:       set_sentbit[usb_in_endpoint] = 1; // lint: usb_in_endpoint range was checked</pre>
<pre style="margin:0; padding:0 "> 311:     end</pre>
<pre style="margin:0; padding:0 "> 312:   end</pre>
<pre style="margin:0; padding:0 "> 313: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314:   always_comb begin : proc_map_sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 315:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 316:       hw2reg.in_sent[i].de = set_sentbit[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:       hw2reg.in_sent[i].d  = 1'b1;</pre>
<pre style="margin:0; padding:0 "> 318:     end</pre>
<pre style="margin:0; padding:0 "> 319:   end</pre>
<pre style="margin:0; padding:0 "> 320: </pre>
<pre style="margin:0; padding:0 "> 321:   // Event (pulse) synchronization</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:   prim_pulse_sync usbdev_sync_in_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 323:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 324:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 325:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 326:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 327:     .src_pulse_i (usb_event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 328:     .dst_pulse_o (event_in_err)</pre>
<pre style="margin:0; padding:0 "> 329:   );</pre>
<pre style="margin:0; padding:0 "> 330: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:   prim_pulse_sync usbdev_outrdyclr (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 334:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 335:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:     .src_pulse_i (usb_setup_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 337:     .dst_pulse_o (setup_received)</pre>
<pre style="margin:0; padding:0 "> 338:   );</pre>
<pre style="margin:0; padding:0 "> 339: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340:   prim_pulse_sync sync_usb_event_rx_crc_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 341:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 342:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 344:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 345:     .src_pulse_i (usb_event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 346:     .dst_pulse_o (event_rx_crc_err)</pre>
<pre style="margin:0; padding:0 "> 347:   );</pre>
<pre style="margin:0; padding:0 "> 348: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 349:   prim_pulse_sync sync_usb_event_rx_pid_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 353:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 354:     .src_pulse_i (usb_event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:     .dst_pulse_o (event_rx_pid_err)</pre>
<pre style="margin:0; padding:0 "> 356:   );</pre>
<pre style="margin:0; padding:0 "> 357: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:   prim_pulse_sync sync_usb_event_rx_bitstuff_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 359:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:     .src_pulse_i (usb_event_rx_bitstuff_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:     .dst_pulse_o (event_rx_bitstuff_err)</pre>
<pre style="margin:0; padding:0 "> 365:   );</pre>
<pre style="margin:0; padding:0 "> 366: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:   prim_pulse_sync sync_usb_event_frame (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 368:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 369:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 370:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 371:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:     .src_pulse_i (usb_event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 373:     .dst_pulse_o (event_frame)</pre>
<pre style="margin:0; padding:0 "> 374:   );</pre>
<pre style="margin:0; padding:0 "> 375: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:   logic event_link_reset_q;</pre>
<pre style="margin:0; padding:0 "> 377: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 378:   always_ff @(posedge clk_usb_48mhz_i or negedge rst_usb_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:     if (!rst_usb_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:       event_link_reset_q <= 0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:       event_link_reset_q <= event_link_reset;</pre>
<pre style="margin:0; padding:0 "> 383:     end</pre>
<pre style="margin:0; padding:0 "> 384:   end</pre>
<pre style="margin:0; padding:0 "> 385: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 386:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:     clear_rdybit = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:     update_pend  = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389:     if (event_link_reset && !event_link_reset_q) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 390:       clear_rdybit = {NEndpoints{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:       update_pend  = {NEndpoints{1'b1}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392:     end else begin</pre>
<pre style="margin:0; padding:0 "> 393:       // Clear pending when a SETUP is received</pre>
<pre style="margin:0; padding:0 "> 394:       // CDC: usb_out_endpoint is synchronized implicitly by</pre>
<pre style="margin:0; padding:0 "> 395:       // setup_received, as it is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 396:       clear_rdybit[usb_out_endpoint] = setup_received;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 397:       update_pend[usb_out_endpoint]  = setup_received;</pre>
<pre style="margin:0; padding:0 "> 398: </pre>
<pre style="margin:0; padding:0 "> 399:       // Clear when a IN transmission was sucessful</pre>
<pre style="margin:0; padding:0 "> 400:       // CDC: usb_in_endpoint is synchronzied implicitly by</pre>
<pre style="margin:0; padding:0 "> 401:       // set_sent</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402:       clear_rdybit[usb_in_endpoint] = set_sent;</pre>
<pre style="margin:0; padding:0 "> 403:     end</pre>
<pre style="margin:0; padding:0 "> 404:   end</pre>
<pre style="margin:0; padding:0 "> 405: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 406:   always_comb begin : proc_map_rdy_hw2reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 407:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 408:       hw2reg.configin[i].rdy.de = clear_rdybit[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:       hw2reg.configin[i].rdy.d  = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 410:     end</pre>
<pre style="margin:0; padding:0 "> 411:   end</pre>
<pre style="margin:0; padding:0 "> 412: </pre>
<pre style="margin:0; padding:0 "> 413:   // Update the pending bit by copying the ready bit that is about to clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 414:   always_comb begin : proc_map_pend</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 415:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:       hw2reg.configin[i].pend.de = update_pend[i];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 417:       hw2reg.configin[i].pend.d  = reg2hw.configin[i].rdy.q | reg2hw.configin[i].pend.q;</pre>
<pre style="margin:0; padding:0 "> 418:     end</pre>
<pre style="margin:0; padding:0 "> 419:   end</pre>
<pre style="margin:0; padding:0 "> 420: </pre>
<pre style="margin:0; padding:0 "> 421:   ////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 422:   // USB interface -- everything is in USB clock domain //</pre>
<pre style="margin:0; padding:0 "> 423:   ////////////////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 424: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 425:   usbdev_usbif #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:     .NEndpoints     (NEndpoints),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 427:     .AVFifoWidth    (AVFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 428:     .RXFifoWidth    (RXFifoWidth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 429:     .MaxPktSizeByte (MaxPktSizeByte),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 430:     .NBuf           (NBuf),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 431:     .SramAw         (SramAw)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:   ) usbdev_impl (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 433:     .clk_48mhz_i          (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 434:     .rst_ni               (rst_usb_ni),</pre>
<pre style="margin:0; padding:0 "> 435: </pre>
<pre style="margin:0; padding:0 "> 436:     // Pins</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 437:     .usb_d_i              (usb_rx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 438:     .usb_se0_i            (usb_rx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 439:     .usb_oe_o             (usb_tx_oe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 440:     .usb_d_o              (usb_tx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:     .usb_se0_o            (usb_tx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 442:     .usb_sense_i          (usb_pwr_sense),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 443:     .usb_pullup_en_o      (usb_pullup_en),</pre>
<pre style="margin:0; padding:0 "> 444: </pre>
<pre style="margin:0; padding:0 "> 445:     // receive side</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 446:     .rx_setup_i           (usb_enable_setup),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 447:     .rx_out_i             (usb_enable_out),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 448:     .rx_stall_i           (usb_ep_stall),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 449:     .av_rvalid_i          (usb_av_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 450:     .av_rready_o          (usb_av_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 451:     .av_rdata_i           (usb_av_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 452:     .event_av_empty_o     (usb_event_av_empty),</pre>
<pre style="margin:0; padding:0 "> 453: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 454:     .rx_wvalid_o          (usb_rx_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 455:     .rx_wready_i          (usb_rx_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 456:     .rx_wdata_o           (usb_rx_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 457:     .event_rx_full_o      (usb_event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 458:     .setup_received_o     (usb_setup_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 459:     .out_endpoint_o       (usb_out_endpoint),  // will be stable for several cycles</pre>
<pre style="margin:0; padding:0 "> 460: </pre>
<pre style="margin:0; padding:0 "> 461:     // transmit side</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 462:     .in_buf_i             (usb_in_buf[usb_in_endpoint]),  // lint: usb_in_endpoint range was checked</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 463:     .in_size_i            (usb_in_size[usb_in_endpoint]),  // lint: usb_in_endpoint range was checked</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 464:     .in_stall_i           (usb_ep_stall),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:     .in_rdy_i             (usb_in_rdy),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466:     .set_sent_o           (usb_set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 467:     .in_endpoint_o        (usb_in_endpoint),</pre>
<pre style="margin:0; padding:0 "> 468: </pre>
<pre style="margin:0; padding:0 "> 469:     // memory</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:     .mem_req_o            (usb_mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:     .mem_write_o          (usb_mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:     .mem_addr_o           (usb_mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:     .mem_wdata_o          (usb_mem_b_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:     .mem_rdata_i          (usb_mem_b_rdata),</pre>
<pre style="margin:0; padding:0 "> 475: </pre>
<pre style="margin:0; padding:0 "> 476:     // control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:     .enable_i             (usb_enable),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 478:     .devaddr_i            (usb_device_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 479:     .clr_devaddr_o        (usb_clr_devaddr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:     .ep_iso_i             (ep_iso), // cdc ok, quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 481:     .cfg_eop_single_bit_i (reg2hw.phy_config.eop_single_bit.q), // cdc ok: quasi-static</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 482:     .tx_osc_test_mode_i   (1'b0), // cdc ok: quasi-static & testmode only</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 483:     .data_toggle_clear_i  (usb_data_toggle_clear),</pre>
<pre style="margin:0; padding:0 "> 484: </pre>
<pre style="margin:0; padding:0 "> 485:     // status</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 486:     .frame_o              (usb_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 487:     .frame_start_o        (usb_event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 488:     .link_state_o         (usb_link_state),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 489:     .link_disconnect_o    (usb_event_disconnect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 490:     .link_connect_o       (usb_event_connect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 491:     .link_reset_o         (usb_event_link_reset),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 492:     .link_suspend_o       (usb_event_link_suspend),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:     .link_resume_o        (usb_event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 494:     .host_lost_o          (usb_event_host_lost),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 495:     .link_in_err_o        (usb_event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 496:     .rx_crc_err_o         (usb_event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 497:     .rx_pid_err_o         (usb_event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 498:     .rx_bitstuff_err_o    (usb_event_rx_bitstuff_err)</pre>
<pre style="margin:0; padding:0 "> 499:   );</pre>
<pre style="margin:0; padding:0 "> 500: </pre>
<pre style="margin:0; padding:0 "> 501:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 502:   // Control signal / status CDC //</pre>
<pre style="margin:0; padding:0 "> 503:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 504: </pre>
<pre style="margin:0; padding:0 "> 505:   // USB clk -> sys clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 506:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 507:     .Width      (3+11)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508:   ) cdc_usb_to_sys (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 509:     .clk_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 510:     .rst_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 511:     .d      ({usb_link_state,              usb_frame}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 512:     .q      ({hw2reg.usbstat.link_state.d, hw2reg.usbstat.frame.d})</pre>
<pre style="margin:0; padding:0 "> 513:   );</pre>
<pre style="margin:0; padding:0 "> 514: </pre>
<pre style="margin:0; padding:0 "> 515:   // sys clk -> USB clk</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 516:   prim_flop_2sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 517:     .Width      (1+7)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 518:   ) cdc_sys_to_usb (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 519:     .clk_i  (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 520:     .rst_ni (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 521:     .d      ({reg2hw.usbctrl.enable.q, reg2hw.usbctrl.device_address.q}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 522:     .q      ({usb_enable,              usb_device_addr})</pre>
<pre style="margin:0; padding:0 "> 523:   );</pre>
<pre style="margin:0; padding:0 "> 524: </pre>
<pre style="margin:0; padding:0 "> 525:   // CDC for event signals (arguably they are there for a long time so would be ok)</pre>
<pre style="margin:0; padding:0 "> 526:   // Just want a pulse to ensure only one interrupt for an event</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 527:   usbdev_flop_2syncpulse #(.Width(5)) syncevent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 528:     .clk_i  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 529:     .rst_ni (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 530:     .d      ({usb_event_disconnect, usb_event_link_reset, usb_event_link_suspend,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 531:               usb_event_host_lost, usb_event_connect}),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 532:     .q      ({event_disconnect, event_link_reset, event_link_suspend,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 533:               event_host_lost, event_connect})</pre>
<pre style="margin:0; padding:0 "> 534:   );</pre>
<pre style="margin:0; padding:0 "> 535: </pre>
<pre style="margin:0; padding:0 "> 536:   // Resume is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 537:   prim_pulse_sync usbdev_resume (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 538:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 539:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 540:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 541:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 542:     .src_pulse_i (usb_event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 543:     .dst_pulse_o (event_link_resume)</pre>
<pre style="margin:0; padding:0 "> 544:   );</pre>
<pre style="margin:0; padding:0 "> 545: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 546:   assign hw2reg.usbstat.host_lost.d = event_host_lost;</pre>
<pre style="margin:0; padding:0 "> 547: </pre>
<pre style="margin:0; padding:0 "> 548:   // resets etc cause the device address to clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 549:   prim_pulse_sync usbdev_devclr (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 550:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 551:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 552:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 553:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 554:     .src_pulse_i (usb_clr_devaddr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 555:     .dst_pulse_o (hw2reg.usbctrl.device_address.de)</pre>
<pre style="margin:0; padding:0 "> 556:   );</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 557:   assign hw2reg.usbctrl.device_address.d = '0;</pre>
<pre style="margin:0; padding:0 "> 558: </pre>
<pre style="margin:0; padding:0 "> 559:   // AV empty is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 560:   prim_pulse_sync sync_usb_event_av_empty (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 561:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 562:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 563:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 564:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 565:     .src_pulse_i (usb_event_av_empty),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 566:     .dst_pulse_o (event_av_empty)</pre>
<pre style="margin:0; padding:0 "> 567:   );</pre>
<pre style="margin:0; padding:0 "> 568: </pre>
<pre style="margin:0; padding:0 "> 569:   // RX full is a single pulse so needs pulsesync</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 570:   prim_pulse_sync sync_usb_event_rx_full (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 571:     .clk_src_i   (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 572:     .clk_dst_i   (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 573:     .rst_src_ni  (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 574:     .rst_dst_ni  (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 575:     .src_pulse_i (usb_event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 576:     .dst_pulse_o (event_rx_full)</pre>
<pre style="margin:0; padding:0 "> 577:   );</pre>
<pre style="margin:0; padding:0 "> 578: </pre>
<pre style="margin:0; padding:0 "> 579:   // Clear the stall flag when a SETUP is received</pre>
<pre style="margin:0; padding:0 "> 580: </pre>
<pre style="margin:0; padding:0 "> 581:   // CDC: usb_out_endpoint is synchronized implicitly by</pre>
<pre style="margin:0; padding:0 "> 582:   // setup_received, as it is stable</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 583:   always_comb begin : proc_stall_tieoff</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 584:     for (int i = 0; i < NEndpoints; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 585:       hw2reg.stall[i].d  = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 586:       if (setup_received && usb_out_endpoint == 4'(i)) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 587:         hw2reg.stall[i].de = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 588:       end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 589:         hw2reg.stall[i].de = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 590:       end</pre>
<pre style="margin:0; padding:0 "> 591:     end</pre>
<pre style="margin:0; padding:0 "> 592:   end</pre>
<pre style="margin:0; padding:0 "> 593: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 594:   logic        unused_mem_a_rerror_d;</pre>
<pre style="margin:0; padding:0 "> 595: </pre>
<pre style="margin:0; padding:0 "> 596:   // TL-UL to SRAM adapter</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 597:   tlul_adapter_sram #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 598:     .SramAw(SramAw),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 599:     .ByteAccess(0)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 600:   ) u_tlul2sram (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 601:     .clk_i    (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 602:     .rst_ni   (rst_ni),</pre>
<pre style="margin:0; padding:0 "> 603: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 604:     .tl_i     (tl_sram_h2d [0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 605:     .tl_o     (tl_sram_d2h [0]),</pre>
<pre style="margin:0; padding:0 "> 606: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 607:     .req_o    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 608:     .gnt_i    (mem_a_req),  //Always grant when request</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 609:     .we_o     (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 610:     .addr_o   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 611:     .wdata_o  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 612:     .wmask_o  (),           // Not used</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 613:     .rdata_i  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 614:     .rvalid_i (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 615:     .rerror_i (mem_a_rerror)</pre>
<pre style="margin:0; padding:0 "> 616:   );</pre>
<pre style="margin:0; padding:0 "> 617: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 618:   assign unused_mem_a_rerror_d = mem_a_rerror[1] ; // Only uncorrectable error</pre>
<pre style="margin:0; padding:0 "> 619: </pre>
<pre style="margin:0; padding:0 "> 620:   // SRAM Wrapper</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 621:   prim_ram_2p_async_adv #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 622:     .Depth (SramDepth),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 623:     .Width (SramDw),    // 32 x 512 --> 2kB</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 624:     .CfgW  (8),</pre>
<pre style="margin:0; padding:0 "> 625: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 626:     .EnableECC           (0), // No Protection</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 627:     .EnableParity        (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 628:     .EnableInputPipeline (0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 629:     .EnableOutputPipeline(0),</pre>
<pre style="margin:0; padding:0 "> 630: </pre>
<pre style="margin:0; padding:0 "> 631:     // large memory, implement with SRAMs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 632:     .MemT ("SRAM")</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 633:   ) u_memory_2p (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 634:     .clk_a_i    (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 635:     .clk_b_i    (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 636:     .rst_a_ni   (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 637:     .rst_b_ni   (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 638:     .a_req_i    (mem_a_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 639:     .a_write_i  (mem_a_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 640:     .a_addr_i   (mem_a_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 641:     .a_wdata_i  (mem_a_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 642:     .a_rvalid_o (mem_a_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 643:     .a_rdata_o  (mem_a_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 644:     .a_rerror_o (mem_a_rerror),</pre>
<pre style="margin:0; padding:0 "> 645: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 646:     .b_req_i    (usb_mem_b_req),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 647:     .b_write_i  (usb_mem_b_write),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 648:     .b_addr_i   (usb_mem_b_addr),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 649:     .b_wdata_i  (usb_mem_b_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 650:     .b_rvalid_o (),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 651:     .b_rdata_o  (usb_mem_b_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 652:     .b_rerror_o (),</pre>
<pre style="margin:0; padding:0 "> 653: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 654:     .cfg_i      (8'h0)</pre>
<pre style="margin:0; padding:0 "> 655:   );</pre>
<pre style="margin:0; padding:0 "> 656: </pre>
<pre style="margin:0; padding:0 "> 657:   // Register module</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 658:   usbdev_reg_top u_reg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 659:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 660:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 661: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 662:     .tl_i (tl_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 663:     .tl_o (tl_o),</pre>
<pre style="margin:0; padding:0 "> 664: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 665:     .tl_win_o (tl_sram_h2d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 666:     .tl_win_i (tl_sram_d2h),</pre>
<pre style="margin:0; padding:0 "> 667: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 668:     .reg2hw,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 669:     .hw2reg,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 670:     .devmode_i (1'b1)</pre>
<pre style="margin:0; padding:0 "> 671:   );</pre>
<pre style="margin:0; padding:0 "> 672: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 673:   prim_intr_hw #(.Width(1)) intr_hw_pkt_received (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 674:     .event_intr_i           (event_pkt_received),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 675:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 676:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 677:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.pkt_received.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 678:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.pkt_received.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 679:     .hw2reg_intr_state_de_o (hw2reg.intr_state.pkt_received.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 680:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.pkt_received.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 681:     .intr_o                 (intr_pkt_received_o)</pre>
<pre style="margin:0; padding:0 "> 682:   );</pre>
<pre style="margin:0; padding:0 "> 683: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 684:   prim_intr_hw #(.Width(1)) intr_hw_pkt_sent (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 685:     .event_intr_i           (set_sent),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 686:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 687:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 688:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.pkt_sent.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 689:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.pkt_sent.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 690:     .hw2reg_intr_state_de_o (hw2reg.intr_state.pkt_sent.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 691:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.pkt_sent.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 692:     .intr_o                 (intr_pkt_sent_o)</pre>
<pre style="margin:0; padding:0 "> 693:   );</pre>
<pre style="margin:0; padding:0 "> 694: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 695:   prim_intr_hw #(.Width(1)) intr_disconnected (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 696:     .event_intr_i           (event_disconnect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 697:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 698:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 699:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.disconnected.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 700:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.disconnected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 701:     .hw2reg_intr_state_de_o (hw2reg.intr_state.disconnected.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 702:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.disconnected.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 703:     .intr_o                 (intr_disconnected_o)</pre>
<pre style="margin:0; padding:0 "> 704:   );</pre>
<pre style="margin:0; padding:0 "> 705: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 706:   prim_intr_hw #(.Width(1)) intr_connected (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 707:     .event_intr_i           (event_connect),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 708:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 709:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 710:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.connected.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 711:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.connected.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 712:     .hw2reg_intr_state_de_o (hw2reg.intr_state.connected.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 713:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.connected.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 714:     .intr_o                 (intr_connected_o)</pre>
<pre style="margin:0; padding:0 "> 715:   );</pre>
<pre style="margin:0; padding:0 "> 716: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 717:   prim_intr_hw #(.Width(1)) intr_host_lost (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 718:     .event_intr_i           (event_host_lost),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 719:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 720:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 721:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.host_lost.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 722:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.host_lost.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 723:     .hw2reg_intr_state_de_o (hw2reg.intr_state.host_lost.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 724:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.host_lost.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 725:     .intr_o                 (intr_host_lost_o)</pre>
<pre style="margin:0; padding:0 "> 726:   );</pre>
<pre style="margin:0; padding:0 "> 727: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 728:   prim_intr_hw #(.Width(1)) intr_link_reset (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 729:     .event_intr_i           (event_link_reset),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 730:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 731:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 732:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_reset.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 733:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_reset.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 734:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_reset.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 735:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_reset.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 736:     .intr_o                 (intr_link_reset_o)</pre>
<pre style="margin:0; padding:0 "> 737:   );</pre>
<pre style="margin:0; padding:0 "> 738: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 739:   prim_intr_hw #(.Width(1)) intr_link_suspend (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 740:     .event_intr_i           (event_link_suspend),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 741:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 742:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 743:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_suspend.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 744:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_suspend.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 745:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_suspend.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 746:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_suspend.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 747:     .intr_o                 (intr_link_suspend_o)</pre>
<pre style="margin:0; padding:0 "> 748:   );</pre>
<pre style="margin:0; padding:0 "> 749: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 750:   prim_intr_hw #(.Width(1)) intr_link_resume (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 751:     .event_intr_i           (event_link_resume),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 752:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 753:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 754:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_resume.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 755:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_resume.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 756:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_resume.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 757:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_resume.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 758:     .intr_o                 (intr_link_resume_o)</pre>
<pre style="margin:0; padding:0 "> 759:   );</pre>
<pre style="margin:0; padding:0 "> 760: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 761:   prim_intr_hw #(.Width(1)) intr_av_empty (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 762:     .event_intr_i           (event_av_empty),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 763:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 764:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 765:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.av_empty.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 766:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.av_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 767:     .hw2reg_intr_state_de_o (hw2reg.intr_state.av_empty.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 768:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.av_empty.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 769:     .intr_o                 (intr_av_empty_o)</pre>
<pre style="margin:0; padding:0 "> 770:   );</pre>
<pre style="margin:0; padding:0 "> 771: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 772:   prim_intr_hw #(.Width(1)) intr_rx_full (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 773:     .event_intr_i           (event_rx_full),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 774:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 775:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 776:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_full.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 777:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_full.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 778:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_full.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 779:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_full.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 780:     .intr_o                 (intr_rx_full_o)</pre>
<pre style="margin:0; padding:0 "> 781:   );</pre>
<pre style="margin:0; padding:0 "> 782: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 783:   prim_intr_hw #(.Width(1)) intr_av_overflow (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 784:     .event_intr_i           (event_av_overflow),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 785:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 786:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 787:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.av_overflow.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 788:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.av_overflow.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 789:     .hw2reg_intr_state_de_o (hw2reg.intr_state.av_overflow.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 790:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.av_overflow.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 791:     .intr_o                 (intr_av_overflow_o)</pre>
<pre style="margin:0; padding:0 "> 792:   );</pre>
<pre style="margin:0; padding:0 "> 793: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 794:   prim_intr_hw #(.Width(1)) intr_link_in_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 795:     .event_intr_i           (event_in_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 796:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 797:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 798:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.link_in_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 799:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.link_in_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 800:     .hw2reg_intr_state_de_o (hw2reg.intr_state.link_in_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 801:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.link_in_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 802:     .intr_o                 (intr_link_in_err_o)</pre>
<pre style="margin:0; padding:0 "> 803:   );</pre>
<pre style="margin:0; padding:0 "> 804: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 805:   prim_intr_hw #(.Width(1)) intr_rx_crc_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 806:     .event_intr_i           (event_rx_crc_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 807:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 808:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 809:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_crc_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 810:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_crc_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 811:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_crc_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 812:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_crc_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 813:     .intr_o                 (intr_rx_crc_err_o)</pre>
<pre style="margin:0; padding:0 "> 814:   );</pre>
<pre style="margin:0; padding:0 "> 815: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 816:   prim_intr_hw #(.Width(1)) intr_rx_pid_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 817:     .event_intr_i           (event_rx_pid_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 818:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 819:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 820:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_pid_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 821:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_pid_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 822:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_pid_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 823:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_pid_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 824:     .intr_o                 (intr_rx_pid_err_o)</pre>
<pre style="margin:0; padding:0 "> 825:   );</pre>
<pre style="margin:0; padding:0 "> 826: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 827:   prim_intr_hw #(.Width(1)) intr_rx_bitstuff_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 828:     .event_intr_i           (event_rx_bitstuff_err),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 829:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 830:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 831:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.rx_bitstuff_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 832:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.rx_bitstuff_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 833:     .hw2reg_intr_state_de_o (hw2reg.intr_state.rx_bitstuff_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 834:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.rx_bitstuff_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 835:     .intr_o                 (intr_rx_bitstuff_err_o)</pre>
<pre style="margin:0; padding:0 "> 836:   );</pre>
<pre style="margin:0; padding:0 "> 837: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 838:   prim_intr_hw #(.Width(1)) intr_frame (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 839:     .event_intr_i           (event_frame),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 840:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 841:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 842:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.frame.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 843:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.frame.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 844:     .hw2reg_intr_state_de_o (hw2reg.intr_state.frame.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 845:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.frame.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 846:     .intr_o                 (intr_frame_o)</pre>
<pre style="margin:0; padding:0 "> 847:   );</pre>
<pre style="margin:0; padding:0 "> 848: </pre>
<pre style="margin:0; padding:0 "> 849:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 850:   // USB IO Muxing               //</pre>
<pre style="margin:0; padding:0 "> 851:   /////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 852: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 853:   usbdev_iomux i_usbdev_iomux (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 854:     .clk_i                  (clk_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 855:     .rst_ni                 (rst_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 856:     .clk_usb_48mhz_i        (clk_usb_48mhz_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 857:     .rst_usb_ni             (rst_usb_ni),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 858:     .rx_differential_mode_i (reg2hw.phy_config.rx_differential_mode),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 859:     .tx_differential_mode_i (reg2hw.phy_config.tx_differential_mode),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 860:     .sys_reg2hw_config_i    (reg2hw.phy_config),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 861:     .sys_usb_sense_o        (hw2reg.usbstat.usb_sense.d),</pre>
<pre style="margin:0; padding:0 "> 862: </pre>
<pre style="margin:0; padding:0 "> 863:     // Chip IO</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 864:     .cio_usb_d_i            (cio_usb_d_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 865:     .cio_usb_dp_i           (cio_usb_dp_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 866:     .cio_usb_dn_i           (cio_usb_dn_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 867:     .cio_usb_d_o            (cio_usb_d_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 868:     .cio_usb_se0_o          (cio_usb_se0_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 869:     .cio_usb_dp_o           (cio_usb_dp_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 870:     .cio_usb_dn_o           (cio_usb_dn_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 871:     .cio_usb_oe_o           (cio_usb_oe_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 872:     .cio_usb_tx_mode_se_o   (cio_usb_tx_mode_se_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 873:     .cio_usb_sense_i        (cio_usb_sense_i),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 874:     .cio_usb_pullup_en_o    (cio_usb_pullup_en_o),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 875:     .cio_usb_suspend_o      (cio_usb_suspend_o),</pre>
<pre style="margin:0; padding:0 "> 876: </pre>
<pre style="margin:0; padding:0 "> 877:     // Internal interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 878:     .usb_rx_d_o             (usb_rx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 879:     .usb_rx_se0_o           (usb_rx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 880:     .usb_tx_d_i             (usb_tx_d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 881:     .usb_tx_se0_i           (usb_tx_se0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 882:     .usb_tx_oe_i            (usb_tx_oe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 883:     .usb_pwr_sense_o        (usb_pwr_sense),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 884:     .usb_pullup_en_i        (usb_pullup_en),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 885:     .usb_suspend_i          (usb_event_link_suspend)</pre>
<pre style="margin:0; padding:0 "> 886:   );</pre>
<pre style="margin:0; padding:0 "> 887: </pre>
<pre style="margin:0; padding:0 "> 888: endmodule</pre>
<pre style="margin:0; padding:0 "> 889: </pre>
</body>
</html>
