
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>../src/lowrisc_ip_hmac_0.1/rtl/hmac.sv Cov: 99.7% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   3: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   4: //</pre>
<pre style="margin:0; padding:0 ">   5: // HMAC-SHA256</pre>
<pre style="margin:0; padding:0 ">   6: </pre>
<pre style="margin:0; padding:0 ">   7: `include "prim_assert.sv"</pre>
<pre style="margin:0; padding:0 ">   8: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   9: module hmac</pre>
<pre style="margin:0; padding:0 ">  10:   import prim_alert_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  11:   import hmac_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  12:   import hmac_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  13: (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  14:   input clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  15:   input rst_ni,</pre>
<pre style="margin:0; padding:0 ">  16: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  17:   input  tlul_pkg::tl_h2d_t tl_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  18:   output tlul_pkg::tl_d2h_t tl_o,</pre>
<pre style="margin:0; padding:0 ">  19: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  20:   output logic intr_hmac_done_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  21:   output logic intr_fifo_empty_o,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  22:   output logic intr_hmac_err_o,</pre>
<pre style="margin:0; padding:0 ">  23: </pre>
<pre style="margin:0; padding:0 ">  24:   // alerts</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  25:   input  alert_rx_t [NumAlerts-1:0] alert_rx_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:   output alert_tx_t [NumAlerts-1:0] alert_tx_o</pre>
<pre style="margin:0; padding:0 ">  27: );</pre>
<pre style="margin:0; padding:0 ">  28: </pre>
<pre style="margin:0; padding:0 ">  29: </pre>
<pre style="margin:0; padding:0 ">  30:   /////////////////////////</pre>
<pre style="margin:0; padding:0 ">  31:   // Signal declarations //</pre>
<pre style="margin:0; padding:0 ">  32:   /////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:   hmac_reg2hw_t reg2hw;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:   hmac_hw2reg_t hw2reg;</pre>
<pre style="margin:0; padding:0 ">  35: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  36:   tlul_pkg::tl_h2d_t  tl_win_h2d[1];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:   tlul_pkg::tl_d2h_t  tl_win_d2h[1];</pre>
<pre style="margin:0; padding:0 ">  38: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:   logic [255:0] secret_key;</pre>
<pre style="margin:0; padding:0 ">  40: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  41:   logic        wipe_secret;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  42:   logic [31:0] wipe_v;</pre>
<pre style="margin:0; padding:0 ">  43: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:   logic        fifo_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  45:   logic        fifo_rready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  46:   sha_fifo_t   fifo_rdata;</pre>
<pre style="margin:0; padding:0 ">  47: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:   logic        fifo_wvalid, fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  49:   sha_fifo_t   fifo_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50:   logic        fifo_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:   logic        fifo_empty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:   logic [4:0]  fifo_depth;</pre>
<pre style="margin:0; padding:0 ">  53: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  54:   logic        msg_fifo_req;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  55:   logic        msg_fifo_gnt;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  56:   logic        msg_fifo_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  57:   logic [8:0]  msg_fifo_addr;   // NOT_READ</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:   logic [31:0] msg_fifo_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:   logic [31:0] msg_fifo_wmask;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:   logic [31:0] msg_fifo_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:   logic        msg_fifo_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:   logic [1:0]  msg_fifo_rerror;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63:   logic [31:0] msg_fifo_wdata_endian;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  64:   logic [31:0] msg_fifo_wmask_endian;</pre>
<pre style="margin:0; padding:0 ">  65: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:   logic        packer_ready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  67:   logic        packer_flush_done;</pre>
<pre style="margin:0; padding:0 ">  68: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  69:   logic        reg_fifo_wvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:   sha_word_t   reg_fifo_wdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  71:   sha_word_t   reg_fifo_wmask;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  72:   logic        hmac_fifo_wsel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  73:   logic        hmac_fifo_wvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:   logic [2:0]  hmac_fifo_wdata_sel;</pre>
<pre style="margin:0; padding:0 ">  75: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76:   logic        shaf_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:   sha_fifo_t   shaf_rdata;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  78:   logic        shaf_rready;</pre>
<pre style="margin:0; padding:0 ">  79: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:   logic        sha_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  81:   logic        hmac_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  82:   logic        endian_swap;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  83:   logic        digest_swap;</pre>
<pre style="margin:0; padding:0 ">  84: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  85:   logic        reg_hash_start;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  86:   logic        sha_hash_start;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:   logic        hash_start;      // Valid hash_start_signal</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:   logic        reg_hash_process;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:   logic        sha_hash_process;</pre>
<pre style="margin:0; padding:0 ">  90: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  91:   logic        reg_hash_done;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  92:   logic        sha_hash_done;</pre>
<pre style="margin:0; padding:0 ">  93: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:   logic [63:0] message_length;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:   logic [63:0] sha_message_length;</pre>
<pre style="margin:0; padding:0 ">  96: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:   err_code_e   err_code;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  98:   logic        err_valid;</pre>
<pre style="margin:0; padding:0 ">  99: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 100:   sha_word_t [7:0] digest;</pre>
<pre style="margin:0; padding:0 "> 101: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102:   hmac_reg2hw_cfg_reg_t cfg_reg;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 103:   logic                 cfg_block;  // Prevent changing config</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:   logic                 msg_allowed; // MSG_FIFO from software is allowed</pre>
<pre style="margin:0; padding:0 "> 105: </pre>
<pre style="margin:0; padding:0 "> 106:   ///////////////////////</pre>
<pre style="margin:0; padding:0 "> 107:   // Connect registers //</pre>
<pre style="margin:0; padding:0 "> 108:   ///////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:   assign hw2reg.status.fifo_full.d  = fifo_full;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 110:   assign hw2reg.status.fifo_empty.d = fifo_empty;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:   assign hw2reg.status.fifo_depth.d = fifo_depth;</pre>
<pre style="margin:0; padding:0 "> 112: </pre>
<pre style="margin:0; padding:0 "> 113:   // secret key</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:   assign wipe_secret = reg2hw.wipe_secret.qe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115:   assign wipe_v      = reg2hw.wipe_secret.q;</pre>
<pre style="margin:0; padding:0 "> 116: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 117:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 118:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 119:       secret_key <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 120:     end else if (wipe_secret) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:       secret_key <= secret_key ^ {8{wipe_v}};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:     end else if (!cfg_block) begin</pre>
<pre style="margin:0; padding:0 "> 123:       // Allow updating secret key only when the engine is in Idle.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 124:       for (int i = 0; i < 8; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 125:         if (reg2hw.key[7-i].qe) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 126:           secret_key[32*i+:32] <= reg2hw.key[7-i].q;</pre>
<pre style="margin:0; padding:0 "> 127:         end</pre>
<pre style="margin:0; padding:0 "> 128:       end</pre>
<pre style="margin:0; padding:0 "> 129:     end</pre>
<pre style="margin:0; padding:0 "> 130:   end</pre>
<pre style="margin:0; padding:0 "> 131: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132:   for (genvar i = 0; i < 8; i++) begin : gen_key_digest</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:     assign hw2reg.key[7-i].d      = '0;</pre>
<pre style="margin:0; padding:0 "> 134:     // digest</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:     assign hw2reg.digest[i].d = conv_endian(digest[i], digest_swap);</pre>
<pre style="margin:0; padding:0 "> 136:   end</pre>
<pre style="margin:0; padding:0 "> 137: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 138:   logic [3:0] unused_cfg_qe;</pre>
<pre style="margin:0; padding:0 "> 139: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 140:   assign unused_cfg_qe = {cfg_reg.sha_en.qe,      cfg_reg.hmac_en.qe,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 141:                           cfg_reg.endian_swap.qe, cfg_reg.digest_swap.qe};</pre>
<pre style="margin:0; padding:0 "> 142: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:   assign sha_en      = cfg_reg.sha_en.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:   assign hmac_en     = cfg_reg.hmac_en.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:   assign endian_swap = cfg_reg.endian_swap.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 146:   assign digest_swap = cfg_reg.digest_swap.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 147:   assign hw2reg.cfg.hmac_en.d     = cfg_reg.hmac_en.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 148:   assign hw2reg.cfg.sha_en.d      = cfg_reg.sha_en.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 149:   assign hw2reg.cfg.endian_swap.d = cfg_reg.endian_swap.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:   assign hw2reg.cfg.digest_swap.d = cfg_reg.digest_swap.q;</pre>
<pre style="margin:0; padding:0 "> 151: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:   assign reg_hash_start   = reg2hw.cmd.hash_start.qe   & reg2hw.cmd.hash_start.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 153:   assign reg_hash_process = reg2hw.cmd.hash_process.qe & reg2hw.cmd.hash_process.q;</pre>
<pre style="margin:0; padding:0 "> 154: </pre>
<pre style="margin:0; padding:0 "> 155:   // Error code register</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 156:   assign hw2reg.err_code.de = err_valid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 157:   assign hw2reg.err_code.d  = err_code;</pre>
<pre style="margin:0; padding:0 "> 158: </pre>
<pre style="margin:0; padding:0 "> 159:   /////////////////////</pre>
<pre style="margin:0; padding:0 "> 160:   // Control signals //</pre>
<pre style="margin:0; padding:0 "> 161:   /////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 162:   assign hash_start = reg_hash_start & sha_en & ~cfg_block;</pre>
<pre style="margin:0; padding:0 "> 163: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 164:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166:       cfg_block <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:     end else if (hash_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 168:       cfg_block <= 1'b 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 169:     end else if (reg_hash_done) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:       cfg_block <= 1'b 0;</pre>
<pre style="margin:0; padding:0 "> 171:     end</pre>
<pre style="margin:0; padding:0 "> 172:   end</pre>
<pre style="margin:0; padding:0 "> 173:   // Hold the configuration during the process</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 176:       cfg_reg <= '{endian_swap: '{q: 1'b1, qe: 1'b0}, default:'0};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 177:     end else if (!cfg_block && reg2hw.cfg.hmac_en.qe) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 178:       cfg_reg <= reg2hw.cfg ;</pre>
<pre style="margin:0; padding:0 "> 179:     end</pre>
<pre style="margin:0; padding:0 "> 180:   end</pre>
<pre style="margin:0; padding:0 "> 181: </pre>
<pre style="margin:0; padding:0 "> 182:   // Open up the MSG_FIFO from the TL-UL port when it is ready</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 183:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 184:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 185:       msg_allowed <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:     end else if (hash_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:       msg_allowed <= 1'b 1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:     end else if (packer_flush_done) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:       msg_allowed <= 1'b 0;</pre>
<pre style="margin:0; padding:0 "> 190:     end</pre>
<pre style="margin:0; padding:0 "> 191:   end</pre>
<pre style="margin:0; padding:0 "> 192:   ////////////////</pre>
<pre style="margin:0; padding:0 "> 193:   // Interrupts //</pre>
<pre style="margin:0; padding:0 "> 194:   ////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 195:   logic fifo_empty_q, fifo_empty_event;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:       fifo_empty_q <= '1; // By default, it is empty</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:     end else if (!hmac_fifo_wsel) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:       fifo_empty_q <= fifo_empty;</pre>
<pre style="margin:0; padding:0 "> 201:     end</pre>
<pre style="margin:0; padding:0 "> 202:   end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 203:   assign fifo_empty_event = fifo_empty & ~fifo_empty_q;</pre>
<pre style="margin:0; padding:0 "> 204: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 205:   logic [2:0] event_intr;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 206:   assign event_intr = {err_valid, fifo_empty_event, reg_hash_done};</pre>
<pre style="margin:0; padding:0 "> 207: </pre>
<pre style="margin:0; padding:0 "> 208:   // instantiate interrupt hardware primitive</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:   prim_intr_hw #(.Width(1)) intr_hw_hmac_done (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 210:     .event_intr_i           (event_intr[0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 211:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.hmac_done.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.hmac_done.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 213:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.hmac_done.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 214:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.hmac_done.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 215:     .hw2reg_intr_state_de_o (hw2reg.intr_state.hmac_done.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 216:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.hmac_done.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:     .intr_o                 (intr_hmac_done_o)</pre>
<pre style="margin:0; padding:0 "> 218:   );</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 219:   prim_intr_hw #(.Width(1)) intr_hw_fifo_empty (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 220:     .event_intr_i           (event_intr[1]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.fifo_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 222:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.fifo_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 223:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.fifo_empty.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 224:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.fifo_empty.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 225:     .hw2reg_intr_state_de_o (hw2reg.intr_state.fifo_empty.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 226:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.fifo_empty.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 227:     .intr_o                 (intr_fifo_empty_o)</pre>
<pre style="margin:0; padding:0 "> 228:   );</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 229:   prim_intr_hw #(.Width(1)) intr_hw_hmac_err (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 230:     .event_intr_i           (event_intr[2]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 231:     .reg2hw_intr_enable_q_i (reg2hw.intr_enable.hmac_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 232:     .reg2hw_intr_test_q_i   (reg2hw.intr_test.hmac_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 233:     .reg2hw_intr_test_qe_i  (reg2hw.intr_test.hmac_err.qe),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 234:     .reg2hw_intr_state_q_i  (reg2hw.intr_state.hmac_err.q),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:     .hw2reg_intr_state_de_o (hw2reg.intr_state.hmac_err.de),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236:     .hw2reg_intr_state_d_o  (hw2reg.intr_state.hmac_err.d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:     .intr_o                 (intr_hmac_err_o)</pre>
<pre style="margin:0; padding:0 "> 238:   );</pre>
<pre style="margin:0; padding:0 "> 239: </pre>
<pre style="margin:0; padding:0 "> 240:   ///////////////</pre>
<pre style="margin:0; padding:0 "> 241:   // Instances //</pre>
<pre style="margin:0; padding:0 "> 242:   ///////////////</pre>
<pre style="margin:0; padding:0 "> 243: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:   assign msg_fifo_rvalid = msg_fifo_req & ~msg_fifo_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:   assign msg_fifo_rdata  = '1;  // Return all F</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:   assign msg_fifo_rerror = '1;  // Return error for read access</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:   assign msg_fifo_gnt    = msg_fifo_req & ~hmac_fifo_wsel & packer_ready;</pre>
<pre style="margin:0; padding:0 "> 248: </pre>
<pre style="margin:0; padding:0 "> 249:   // FIFO control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 250:   sha_fifo_t reg_fifo_wentry;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 251:   assign reg_fifo_wentry.data = conv_endian(reg_fifo_wdata, 1'b1); // always convert</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:   assign reg_fifo_wentry.mask = {reg_fifo_wmask[0],  reg_fifo_wmask[8],</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:                                  reg_fifo_wmask[16], reg_fifo_wmask[24]};</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:   assign fifo_full   = ~fifo_wready;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:   assign fifo_empty  = ~fifo_rvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 256:   assign fifo_wvalid = (hmac_fifo_wsel && fifo_wready) ? hmac_fifo_wvalid : reg_fifo_wvalid;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 257:   assign fifo_wdata  = (hmac_fifo_wsel) ? '{data: digest[hmac_fifo_wdata_sel], mask: '1}</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:                                        : reg_fifo_wentry;</pre>
<pre style="margin:0; padding:0 "> 259: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 260:   prim_fifo_sync #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:     .Width ($bits(sha_fifo_t)),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 262:     .Pass  (1'b0),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:     .Depth (MsgFifoDepth)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:   ) u_msg_fifo (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 265:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 266:     .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 267:     .clr_i  (1'b0),</pre>
<pre style="margin:0; padding:0 "> 268: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:     .wvalid (fifo_wvalid & sha_en),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 270:     .wready (fifo_wready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 271:     .wdata  (fifo_wdata),</pre>
<pre style="margin:0; padding:0 "> 272: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 273:     .depth  (fifo_depth),</pre>
<pre style="margin:0; padding:0 "> 274: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 275:     .rvalid (fifo_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 276:     .rready (fifo_rready),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 277:     .rdata  (fifo_rdata)</pre>
<pre style="margin:0; padding:0 "> 278:   );</pre>
<pre style="margin:0; padding:0 "> 279: </pre>
<pre style="margin:0; padding:0 "> 280:   // TL ADAPTER SRAM</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 281:   tlul_adapter_sram #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 282:     .SramAw (9),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 283:     .SramDw (32),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 284:     .Outstanding (1),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 285:     .ByteAccess  (1),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 286:     .ErrOnRead   (1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 287:   ) u_tlul_adapter (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 288:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 289:     .rst_ni,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:     .tl_i   (tl_win_h2d[0]),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 291:     .tl_o   (tl_win_d2h[0]),</pre>
<pre style="margin:0; padding:0 "> 292: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 293:     .req_o    (msg_fifo_req   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 294:     .gnt_i    (msg_fifo_gnt   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 295:     .we_o     (msg_fifo_we    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:     .addr_o   (msg_fifo_addr  ), // Doesn't care the address other than sub-word</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:     .wdata_o  (msg_fifo_wdata ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 298:     .wmask_o  (msg_fifo_wmask ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:     .rdata_i  (msg_fifo_rdata ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 300:     .rvalid_i (msg_fifo_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 301:     .rerror_i (msg_fifo_rerror)</pre>
<pre style="margin:0; padding:0 "> 302:   );</pre>
<pre style="margin:0; padding:0 "> 303: </pre>
<pre style="margin:0; padding:0 "> 304:   // TL-UL to MSG_FIFO byte write handling</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 305:   logic msg_write;</pre>
<pre style="margin:0; padding:0 "> 306: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 307:   assign msg_write = msg_fifo_req & msg_fifo_we & ~hmac_fifo_wsel & msg_allowed;</pre>
<pre style="margin:0; padding:0 "> 308: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309:   logic [$clog2(32+1)-1:0] wmask_ones;</pre>
<pre style="margin:0; padding:0 "> 310: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312:     wmask_ones = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 313:     for (int i = 0 ; i < 32 ; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314:       wmask_ones = wmask_ones + msg_fifo_wmask[i];</pre>
<pre style="margin:0; padding:0 "> 315:     end</pre>
<pre style="margin:0; padding:0 "> 316:   end</pre>
<pre style="margin:0; padding:0 "> 317: </pre>
<pre style="margin:0; padding:0 "> 318:   // Calculate written message</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 320:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:       message_length <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:     end else if (hash_start) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 323:       message_length <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 324:     end else if (msg_write && sha_en && packer_ready) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 325:       message_length <= message_length + 64'(wmask_ones);</pre>
<pre style="margin:0; padding:0 "> 326:     end</pre>
<pre style="margin:0; padding:0 "> 327:   end</pre>
<pre style="margin:0; padding:0 "> 328: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 329:   assign hw2reg.msg_length_upper.de = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:   assign hw2reg.msg_length_upper.d = message_length[63:32];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:   assign hw2reg.msg_length_lower.de = 1'b1;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:   assign hw2reg.msg_length_lower.d = message_length[31:0];</pre>
<pre style="margin:0; padding:0 "> 333: </pre>
<pre style="margin:0; padding:0 "> 334: </pre>
<pre style="margin:0; padding:0 "> 335:   // Convert endian here</pre>
<pre style="margin:0; padding:0 "> 336:   //    prim_packer always packs to the right, but SHA engine assumes incoming</pre>
<pre style="margin:0; padding:0 "> 337:   //    to be big-endian, [31:24] comes first. So, the data is reverted after</pre>
<pre style="margin:0; padding:0 "> 338:   //    prim_packer before the message fifo. here to reverse if not big-endian</pre>
<pre style="margin:0; padding:0 "> 339:   //    before pushing to the packer.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340:   assign msg_fifo_wdata_endian = conv_endian(msg_fifo_wdata, ~endian_swap);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 341:   assign msg_fifo_wmask_endian = conv_endian(msg_fifo_wmask, ~endian_swap);</pre>
<pre style="margin:0; padding:0 "> 342: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:   prim_packer #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 344:     .InW      (32),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 345:     .OutW     (32)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 346:   ) u_packer (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 347:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 348:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 349: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:     .valid_i      (msg_write & sha_en),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 351:     .data_i       (msg_fifo_wdata_endian),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 352:     .mask_i       (msg_fifo_wmask_endian),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 353:     .ready_o      (packer_ready),</pre>
<pre style="margin:0; padding:0 "> 354: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:     .valid_o      (reg_fifo_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 356:     .data_o       (reg_fifo_wdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 357:     .mask_o       (reg_fifo_wmask),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:     .ready_i      (fifo_wready & ~hmac_fifo_wsel),</pre>
<pre style="margin:0; padding:0 "> 359: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:     .flush_i      (reg_hash_process),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:     .flush_done_o (packer_flush_done) // ignore at this moment</pre>
<pre style="margin:0; padding:0 "> 362:   );</pre>
<pre style="margin:0; padding:0 "> 363: </pre>
<pre style="margin:0; padding:0 "> 364: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:   hmac_core u_hmac (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 366:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 368: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 369:     .secret_key,</pre>
<pre style="margin:0; padding:0 "> 370: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 371:     .wipe_secret,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 372:     .wipe_v,</pre>
<pre style="margin:0; padding:0 "> 373: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 374:     .hmac_en,</pre>
<pre style="margin:0; padding:0 "> 375: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:     .reg_hash_start   (hash_start),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 377:     .reg_hash_process (packer_flush_done), // Trigger after all msg written</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 378:     .hash_done      (reg_hash_done),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:     .sha_hash_start,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:     .sha_hash_process,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     .sha_hash_done,</pre>
<pre style="margin:0; padding:0 "> 382: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 383:     .sha_rvalid     (shaf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 384:     .sha_rdata      (shaf_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 385:     .sha_rready     (shaf_rready),</pre>
<pre style="margin:0; padding:0 "> 386: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:     .fifo_rvalid,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:     .fifo_rdata,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389:     .fifo_rready,</pre>
<pre style="margin:0; padding:0 "> 390: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 391:     .fifo_wsel      (hmac_fifo_wsel),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 392:     .fifo_wvalid    (hmac_fifo_wvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 393:     .fifo_wdata_sel (hmac_fifo_wdata_sel),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:     .fifo_wready,</pre>
<pre style="margin:0; padding:0 "> 395: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 396:     .message_length,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 397:     .sha_message_length</pre>
<pre style="margin:0; padding:0 "> 398:   );</pre>
<pre style="margin:0; padding:0 "> 399: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 400:   sha2 u_sha2 (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 401:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 402:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 403: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 404:     .wipe_secret,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 405:     .wipe_v,</pre>
<pre style="margin:0; padding:0 "> 406: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 407:     .fifo_rvalid      (shaf_rvalid),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 408:     .fifo_rdata       (shaf_rdata),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 409:     .fifo_rready      (shaf_rready),</pre>
<pre style="margin:0; padding:0 "> 410: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 411:     .sha_en,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 412:     .hash_start       (sha_hash_start),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 413:     .hash_process     (sha_hash_process),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 414:     .hash_done        (sha_hash_done),</pre>
<pre style="margin:0; padding:0 "> 415: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 416:     .message_length   (sha_message_length),</pre>
<pre style="margin:0; padding:0 "> 417: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 418:     .digest</pre>
<pre style="margin:0; padding:0 "> 419:   );</pre>
<pre style="margin:0; padding:0 "> 420: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 421:   hmac_reg_top u_reg (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 422:     .clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 423:     .rst_ni,</pre>
<pre style="margin:0; padding:0 "> 424: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 425:     .tl_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 426:     .tl_o,</pre>
<pre style="margin:0; padding:0 "> 427: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 428:     .tl_win_o   (tl_win_h2d),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 429:     .tl_win_i   (tl_win_d2h),</pre>
<pre style="margin:0; padding:0 "> 430: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 431:     .reg2hw,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 432:     .hw2reg,</pre>
<pre style="margin:0; padding:0 "> 433: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 434:     .devmode_i  (1'b1)</pre>
<pre style="margin:0; padding:0 "> 435:   );</pre>
<pre style="margin:0; padding:0 "> 436: </pre>
<pre style="margin:0; padding:0 "> 437:   /////////////////////////</pre>
<pre style="margin:0; padding:0 "> 438:   // HMAC Error Handling //</pre>
<pre style="margin:0; padding:0 "> 439:   /////////////////////////</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 440:   logic msg_push_sha_disabled, hash_start_sha_disabled, update_seckey_inprocess;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 441:   logic hash_start_active;  // `reg_hash_start` set when hash already in active</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 442:   logic msg_push_not_allowed; // Message is received when `hash_start` isn't set</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 443:   assign msg_push_sha_disabled = msg_write & ~sha_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 444:   assign hash_start_sha_disabled = reg_hash_start & ~sha_en;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 445:   assign hash_start_active = reg_hash_start & cfg_block;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 446:   assign msg_push_not_allowed = msg_fifo_req & ~msg_allowed;</pre>
<pre style="margin:0; padding:0 "> 447: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 448:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 449:     update_seckey_inprocess = 1'b0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 450:     if (cfg_block) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 451:       for (int i = 0 ; i < 8 ; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 452:         if (reg2hw.key[i].qe) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 453:           update_seckey_inprocess = update_seckey_inprocess | 1'b1;</pre>
<pre style="margin:0; padding:0 "> 454:         end</pre>
<pre style="margin:0; padding:0 "> 455:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 456:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 457:       update_seckey_inprocess = 1'b0;</pre>
<pre style="margin:0; padding:0 "> 458:     end</pre>
<pre style="margin:0; padding:0 "> 459:   end</pre>
<pre style="margin:0; padding:0 "> 460: </pre>
<pre style="margin:0; padding:0 "> 461:   // Update ERR_CODE register and interrupt only when no pending interrupt.</pre>
<pre style="margin:0; padding:0 "> 462:   // This ensures only the first event of the series of events can be seen to sw.</pre>
<pre style="margin:0; padding:0 "> 463:   // It is recommended that the software reads ERR_CODE register when interrupt</pre>
<pre style="margin:0; padding:0 "> 464:   // is pending to avoid any race conditions.</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 465:   assign err_valid = ~reg2hw.intr_state.hmac_err.q &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 466:                    ( msg_push_sha_disabled | hash_start_sha_disabled</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 467:                    | update_seckey_inprocess | hash_start_active</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 468:                    | msg_push_not_allowed );</pre>
<pre style="margin:0; padding:0 "> 469: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 470:   always_comb begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 471:     err_code = NoError;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 472:     unique case (1'b1)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 473:       msg_push_sha_disabled: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 474:         err_code = SwPushMsgWhenShaDisabled;</pre>
<pre style="margin:0; padding:0 "> 475:       end</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 476:       hash_start_sha_disabled: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 477:         err_code = SwHashStartWhenShaDisabled;</pre>
<pre style="margin:0; padding:0 "> 478:       end</pre>
<pre style="margin:0; padding:0 "> 479: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 480:       update_seckey_inprocess: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 481:         err_code = SwUpdateSecretKeyInProcess;</pre>
<pre style="margin:0; padding:0 "> 482:       end</pre>
<pre style="margin:0; padding:0 "> 483: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 484:       hash_start_active: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 485:         err_code = SwHashStartWhenActive;</pre>
<pre style="margin:0; padding:0 "> 486:       end</pre>
<pre style="margin:0; padding:0 "> 487: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 488:       msg_push_not_allowed: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 489:         err_code = SwPushMsgWhenDisallowed;</pre>
<pre style="margin:0; padding:0 "> 490:       end</pre>
<pre style="margin:0; padding:0 "> 491: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 492:       default: begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 493:         err_code = NoError;</pre>
<pre style="margin:0; padding:0 "> 494:       end</pre>
<pre style="margin:0; padding:0 "> 495:     endcase</pre>
<pre style="margin:0; padding:0 "> 496:   end</pre>
<pre style="margin:0; padding:0 "> 497: </pre>
<pre style="margin:0; padding:0 "> 498:   /////////////////////</pre>
<pre style="margin:0; padding:0 "> 499:   // Hardware Alerts //</pre>
<pre style="margin:0; padding:0 "> 500:   /////////////////////</pre>
<pre style="margin:0; padding:0 "> 501: </pre>
<pre style="margin:0; padding:0 "> 502:   // TODO: add CSR with REGWEN to test alert via SW</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 503:   logic [NumAlerts-1:0] alerts;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 504:   assign alerts = {msg_push_sha_disabled};</pre>
<pre style="margin:0; padding:0 "> 505: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 506:   for (genvar j = 0; j < hmac_pkg::NumAlerts; j++) begin : gen_alert_tx</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 507:     prim_alert_sender #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 508:       .AsyncOn(hmac_pkg::AlertAsyncOn[j])</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 509:     ) i_prim_alert_sender (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 510:       .clk_i      ( clk_i         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 511:       .rst_ni     ( rst_ni        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 512:       .alert_i    ( alerts[j]     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 513:       .alert_rx_i ( alert_rx_i[j] ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 514:       .alert_tx_o ( alert_tx_o[j] )</pre>
<pre style="margin:0; padding:0 "> 515:     );</pre>
<pre id="id516" style="background-color: #FFB6C1; margin:0; padding:0 "> 516:   end : gen_alert_tx</pre>
<pre style="margin:0; padding:0 "> 517: </pre>
<pre style="margin:0; padding:0 "> 518:   //////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 519:   // Assertions, Assumptions, and Coverpoints //</pre>
<pre style="margin:0; padding:0 "> 520:   //////////////////////////////////////////////</pre>
<pre style="margin:0; padding:0 "> 521: </pre>
<pre style="margin:0; padding:0 "> 522: `ifndef VERILATOR</pre>
<pre style="margin:0; padding:0 "> 523: `ifndef SYNTHESIS</pre>
<pre style="margin:0; padding:0 "> 524:   // HMAC assumes TL-UL mask is byte-aligned.</pre>
<pre style="margin:0; padding:0 "> 525:   property wmask_bytealign_p(wmask_byte, clk, rst_n);</pre>
<pre style="margin:0; padding:0 "> 526:     @(posedge clk) disable iff (rst_n == 0)</pre>
<pre style="margin:0; padding:0 "> 527:       msg_fifo_req & msg_fifo_we |-> wmask_byte inside {'0, '1};</pre>
<pre style="margin:0; padding:0 "> 528:   endproperty</pre>
<pre style="margin:0; padding:0 "> 529: </pre>
<pre style="margin:0; padding:0 "> 530:   for (genvar i = 0 ; i < 4; i++) begin: gen_assert_wmask_bytealign</pre>
<pre style="margin:0; padding:0 "> 531:     assert property (wmask_bytealign_p(msg_fifo_wmask[8*i+:8], clk_i, rst_ni));</pre>
<pre style="margin:0; padding:0 "> 532:   end</pre>
<pre style="margin:0; padding:0 "> 533: </pre>
<pre style="margin:0; padding:0 "> 534:   // To pass FPV, this shouldn't add pragma translate_off even these two signals</pre>
<pre style="margin:0; padding:0 "> 535:   // are used in Assertion only</pre>
<pre style="margin:0; padding:0 "> 536:   logic in_process;</pre>
<pre style="margin:0; padding:0 "> 537:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="margin:0; padding:0 "> 538:     if (!rst_ni)               in_process <= 1'b0;</pre>
<pre style="margin:0; padding:0 "> 539:     else if (reg_hash_process) in_process <= 1'b1;</pre>
<pre style="margin:0; padding:0 "> 540:     else if (reg_hash_done)    in_process <= 1'b0;</pre>
<pre style="margin:0; padding:0 "> 541:   end</pre>
<pre style="margin:0; padding:0 "> 542: </pre>
<pre style="margin:0; padding:0 "> 543:   logic initiated;</pre>
<pre style="margin:0; padding:0 "> 544:   always_ff @(posedge clk_i or negedge rst_ni) begin</pre>
<pre style="margin:0; padding:0 "> 545:     if (!rst_ni)               initiated <= 1'b0;</pre>
<pre style="margin:0; padding:0 "> 546:     else if (hash_start)       initiated <= 1'b1;</pre>
<pre style="margin:0; padding:0 "> 547:     else if (reg_hash_process) initiated <= 1'b0;</pre>
<pre style="margin:0; padding:0 "> 548:   end</pre>
<pre style="margin:0; padding:0 "> 549: </pre>
<pre style="margin:0; padding:0 "> 550:   // the host doesn't write data after hash_process until hash_start.</pre>
<pre style="margin:0; padding:0 "> 551:   // Same as "message_length shouldn't be changed between hash_process and done</pre>
<pre style="margin:0; padding:0 "> 552:   `ASSERT(ValidWriteAssert, msg_fifo_req |-> !in_process)</pre>
<pre style="margin:0; padding:0 "> 553: </pre>
<pre style="margin:0; padding:0 "> 554:   // `hash_process` shall be toggle and paired with `hash_start`.</pre>
<pre style="margin:0; padding:0 "> 555:   // Below condition is covered by the design (2020-02-19)</pre>
<pre style="margin:0; padding:0 "> 556:   //`ASSERT(ValidHashStartAssert, hash_start |-> !initiated)</pre>
<pre style="margin:0; padding:0 "> 557:   `ASSERT(ValidHashProcessAssert, reg_hash_process |-> initiated)</pre>
<pre style="margin:0; padding:0 "> 558: </pre>
<pre style="margin:0; padding:0 "> 559:   // between `hash_done` and `hash_start`, message FIFO should be empty</pre>
<pre style="margin:0; padding:0 "> 560:   `ASSERT(MsgFifoEmptyWhenNoOpAssert,</pre>
<pre style="margin:0; padding:0 "> 561:           !in_process && !initiated |-> $stable(message_length))</pre>
<pre style="margin:0; padding:0 "> 562: </pre>
<pre style="margin:0; padding:0 "> 563:   // hmac_en should be modified only when the logic is Idle</pre>
<pre style="margin:0; padding:0 "> 564:   `ASSERT(ValidHmacEnConditionAssert,</pre>
<pre style="margin:0; padding:0 "> 565:           hmac_en != $past(hmac_en) |-> !in_process && !initiated)</pre>
<pre style="margin:0; padding:0 "> 566: </pre>
<pre style="margin:0; padding:0 "> 567:   // All outputs should be known value after reset</pre>
<pre style="margin:0; padding:0 "> 568:   `ASSERT_KNOWN(IntrHmacDoneOKnown, intr_hmac_done_o)</pre>
<pre style="margin:0; padding:0 "> 569:   `ASSERT_KNOWN(IntrFifoEmptyOKnown, intr_fifo_empty_o)</pre>
<pre style="margin:0; padding:0 "> 570:   `ASSERT_KNOWN(TlODValidKnown, tl_o.d_valid)</pre>
<pre style="margin:0; padding:0 "> 571:   `ASSERT_KNOWN(TlOAReadyKnown, tl_o.a_ready)</pre>
<pre style="margin:0; padding:0 "> 572: </pre>
<pre style="margin:0; padding:0 "> 573:   // Alert outputs</pre>
<pre style="margin:0; padding:0 "> 574:   `ASSERT_KNOWN(AlertTxOKnown, alert_tx_o)</pre>
<pre style="margin:0; padding:0 "> 575: </pre>
<pre style="margin:0; padding:0 "> 576: `endif // SYNTHESIS</pre>
<pre style="margin:0; padding:0 "> 577: `endif // VERILATOR</pre>
<pre style="margin:0; padding:0 "> 578: </pre>
<pre style="margin:0; padding:0 "> 579: endmodule</pre>
<pre style="margin:0; padding:0 "> 580: </pre>
</body>
</html>
