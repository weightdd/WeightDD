
<!DOCTYPE html>
<html>
<head>
<style>
body {

}
p {
font-size: 14px;
}</style>
<h3>hw/ip/aes/rtl/aes_core.sv Cov: 100% </h3>
<pre style="margin:0; padding:0 ">   1: // Copyright lowRISC contributors.</pre>
<pre style="margin:0; padding:0 ">   2: // Licensed under the Apache License, Version 2.0, see LICENSE for details.</pre>
<pre style="margin:0; padding:0 ">   3: // SPDX-License-Identifier: Apache-2.0</pre>
<pre style="margin:0; padding:0 ">   4: //</pre>
<pre style="margin:0; padding:0 ">   5: // AES core implementation</pre>
<pre style="margin:0; padding:0 ">   6: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   7: module aes_core #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   8:   parameter bit AES192Enable = 1,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">   9:   parameter     SBoxImpl     = "lut"</pre>
<pre style="margin:0; padding:0 ">  10: ) (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  11:   input                            clk_i,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  12:   input                            rst_ni,</pre>
<pre style="margin:0; padding:0 ">  13: </pre>
<pre style="margin:0; padding:0 ">  14:   // Bus Interface</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  15:   input  aes_reg_pkg::aes_reg2hw_t reg2hw,</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  16:   output aes_reg_pkg::aes_hw2reg_t hw2reg</pre>
<pre style="margin:0; padding:0 ">  17: );</pre>
<pre style="margin:0; padding:0 ">  18: </pre>
<pre style="margin:0; padding:0 ">  19:   import aes_reg_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  20:   import aes_pkg::*;</pre>
<pre style="margin:0; padding:0 ">  21: </pre>
<pre style="margin:0; padding:0 ">  22:   // Signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  23:   logic     [3:0][31:0] data_in;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  24:   logic     [3:0]       data_in_qe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  25:   logic                 data_in_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  26:   logic     [7:0][31:0] key_init;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  27:   logic     [7:0]       key_init_qe;</pre>
<pre style="margin:0; padding:0 ">  28: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  29:   logic                 ctrl_qe;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  30:   logic                 ctrl_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  31:   mode_e                mode_d, mode_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  32:   key_len_e             key_len;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  33:   key_len_e             key_len_d, key_len_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  34:   logic                 manual_start_trigger_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  35:   logic                 force_data_overwrite_q;</pre>
<pre style="margin:0; padding:0 ">  36: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  37:   logic [3:0][3:0][7:0] state_init;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  38:   logic [3:0][3:0][7:0] state_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  39:   logic [3:0][3:0][7:0] state_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  40:   logic                 state_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  41:   state_sel_e           state_sel;</pre>
<pre style="margin:0; padding:0 ">  42: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  43:   logic [3:0][3:0][7:0] sub_bytes_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  44:   logic [3:0][3:0][7:0] shift_rows_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  45:   logic [3:0][3:0][7:0] mix_columns_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  46:   logic [3:0][3:0][7:0] add_round_key_in;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  47:   logic [3:0][3:0][7:0] add_round_key_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  48:   add_rk_sel_e          add_round_key_in_sel;</pre>
<pre style="margin:0; padding:0 ">  49: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  50:   logic     [7:0][31:0] key_init_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  51:   logic     [7:0][31:0] key_init_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  52:   logic     [7:0]       key_init_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  53:   key_init_sel_e        key_init_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  54:   logic     [7:0][31:0] key_full_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  55:   logic     [7:0][31:0] key_full_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  56:   logic                 key_full_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  57:   key_full_sel_e        key_full_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  58:   logic     [7:0][31:0] key_dec_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  59:   logic     [7:0][31:0] key_dec_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  60:   logic                 key_dec_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  61:   key_dec_sel_e         key_dec_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  62:   logic     [7:0][31:0] key_expand_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  63:   mode_e                key_expand_mode;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  64:   logic                 key_expand_step;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  65:   logic                 key_expand_clear;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  66:   logic           [3:0] key_expand_round;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  67:   key_words_sel_e       key_words_sel;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  68:   logic     [3:0][31:0] key_words;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  69:   logic [3:0][3:0][7:0] key_bytes;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  70:   logic [3:0][3:0][7:0] key_mix_columns_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  71:   logic [3:0][3:0][7:0] round_key;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  72:   round_key_sel_e       round_key_sel;</pre>
<pre style="margin:0; padding:0 ">  73: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  74:   logic     [3:0][31:0] data_out_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  75:   logic     [3:0][31:0] data_out_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  76:   logic                 data_out_we;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  77:   logic           [3:0] data_out_re;</pre>
<pre style="margin:0; padding:0 ">  78: </pre>
<pre style="margin:0; padding:0 ">  79:   // Unused signals</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  80:   logic     [3:0][31:0] unused_data_out_q;</pre>
<pre style="margin:0; padding:0 ">  81: </pre>
<pre style="margin:0; padding:0 ">  82:   ////////////</pre>
<pre style="margin:0; padding:0 ">  83:   // Inputs //</pre>
<pre style="margin:0; padding:0 ">  84:   ////////////</pre>
<pre style="margin:0; padding:0 ">  85: </pre>
<pre style="margin:0; padding:0 ">  86:   // Inputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  87:   always_comb begin : key_init_get</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  88:     for (int i=0; i<8; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  89:       key_init[i]    = reg2hw.key[i].q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  90:       key_init_qe[i] = reg2hw.key[i].qe;</pre>
<pre style="margin:0; padding:0 ">  91:     end</pre>
<pre style="margin:0; padding:0 ">  92:   end</pre>
<pre style="margin:0; padding:0 ">  93: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  94:   always_comb begin : data_in_get</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  95:     for (int i=0; i<4; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  96:       data_in[i]    = reg2hw.data_in[i].q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 ">  97:       data_in_qe[i] = reg2hw.data_in[i].qe;</pre>
<pre style="margin:0; padding:0 ">  98:     end</pre>
<pre style="margin:0; padding:0 ">  99:   end</pre>
<pre style="margin:0; padding:0 "> 100: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 101:   always_comb begin : data_out_get</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 102:     for (int i=0; i<4; i++) begin</pre>
<pre style="margin:0; padding:0 "> 103:       // data_out is actually hwo, but we need hrw for hwre</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 104:       unused_data_out_q[i] = reg2hw.data_out[i].q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 105:       data_out_re[i]       = reg2hw.data_out[i].re;</pre>
<pre style="margin:0; padding:0 "> 106:     end</pre>
<pre style="margin:0; padding:0 "> 107:   end</pre>
<pre style="margin:0; padding:0 "> 108: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 109:   assign mode_d = mode_e'(reg2hw.ctrl.mode.q);</pre>
<pre style="margin:0; padding:0 "> 110: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 111:   assign key_len = key_len_e'(reg2hw.ctrl.key_len.q);</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 112:   always_comb begin : get_key_len</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 113:     unique case (key_len)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 114:       AES_128: key_len_d = AES_128;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 115:       AES_256: key_len_d = AES_256;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 116:       AES_192: key_len_d = AES192Enable ? AES_192 : AES_128;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 117:       default: key_len_d = AES_128; // unsupported values are mapped to AES_128</pre>
<pre style="margin:0; padding:0 "> 118:     endcase</pre>
<pre style="margin:0; padding:0 "> 119:   end</pre>
<pre style="margin:0; padding:0 "> 120: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 121:   assign ctrl_qe = reg2hw.ctrl.mode.qe & reg2hw.ctrl.key_len.qe &</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 122:       reg2hw.ctrl.manual_start_trigger.qe & reg2hw.ctrl.force_data_overwrite.qe;</pre>
<pre style="margin:0; padding:0 "> 123: </pre>
<pre style="margin:0; padding:0 "> 124:   //////////</pre>
<pre style="margin:0; padding:0 "> 125:   // Data //</pre>
<pre style="margin:0; padding:0 "> 126:   //////////</pre>
<pre style="margin:0; padding:0 "> 127: </pre>
<pre style="margin:0; padding:0 "> 128:   // Convert input data to state (every input data word contains one state column)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 129:   assign state_init = aes_transpose(data_in);</pre>
<pre style="margin:0; padding:0 "> 130: </pre>
<pre style="margin:0; padding:0 "> 131:   // State registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 132:   always_comb begin : state_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 133:     unique case (state_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 134:       STATE_INIT:  state_d = state_init;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 135:       STATE_ROUND: state_d = add_round_key_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 136:       STATE_CLEAR: state_d = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 137:       default:     state_d = state_init;</pre>
<pre style="margin:0; padding:0 "> 138:     endcase</pre>
<pre style="margin:0; padding:0 "> 139:   end</pre>
<pre style="margin:0; padding:0 "> 140: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 141:   always_ff @(posedge clk_i or negedge rst_ni) begin : state_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 142:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 143:       state_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 144:     end else if (state_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 145:       state_q <= state_d;</pre>
<pre style="margin:0; padding:0 "> 146:     end</pre>
<pre style="margin:0; padding:0 "> 147:   end</pre>
<pre style="margin:0; padding:0 "> 148: </pre>
<pre style="margin:0; padding:0 "> 149:   // Cipher data path</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 150:   aes_sub_bytes #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 151:   .SBoxImpl     ( SBoxImpl )</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 152:   ) aes_sub_bytes (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 153:     .mode_i ( mode_q        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 154:     .data_i ( state_q       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 155:     .data_o ( sub_bytes_out )</pre>
<pre style="margin:0; padding:0 "> 156:   );</pre>
<pre style="margin:0; padding:0 "> 157: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 158:   aes_shift_rows aes_shift_rows (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 159:     .mode_i ( mode_q         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 160:     .data_i ( sub_bytes_out  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 161:     .data_o ( shift_rows_out )</pre>
<pre style="margin:0; padding:0 "> 162:   );</pre>
<pre style="margin:0; padding:0 "> 163: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 164:   aes_mix_columns aes_mix_columns (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 165:     .mode_i ( mode_q          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 166:     .data_i ( shift_rows_out  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 167:     .data_o ( mix_columns_out )</pre>
<pre style="margin:0; padding:0 "> 168:   );</pre>
<pre style="margin:0; padding:0 "> 169: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 170:   always_comb begin : add_round_key_in_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 171:     unique case (add_round_key_in_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 172:       ADD_RK_INIT:  add_round_key_in = state_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 173:       ADD_RK_ROUND: add_round_key_in = mix_columns_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 174:       ADD_RK_FINAL: add_round_key_in = shift_rows_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 175:       default:      add_round_key_in = state_q;</pre>
<pre style="margin:0; padding:0 "> 176:     endcase</pre>
<pre style="margin:0; padding:0 "> 177:   end</pre>
<pre style="margin:0; padding:0 "> 178: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 179:   assign add_round_key_out = add_round_key_in ^ round_key;</pre>
<pre style="margin:0; padding:0 "> 180: </pre>
<pre style="margin:0; padding:0 "> 181:   /////////</pre>
<pre style="margin:0; padding:0 "> 182:   // Key //</pre>
<pre style="margin:0; padding:0 "> 183:   /////////</pre>
<pre style="margin:0; padding:0 "> 184: </pre>
<pre style="margin:0; padding:0 "> 185:   // Initial Key registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 186:   always_comb begin : key_init_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 187:     unique case (key_init_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 188:       KEY_INIT_INPUT: key_init_d = key_init;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 189:       KEY_INIT_CLEAR: key_init_d = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 190:       default:        key_init_d = key_init;</pre>
<pre style="margin:0; padding:0 "> 191:     endcase</pre>
<pre style="margin:0; padding:0 "> 192:   end</pre>
<pre style="margin:0; padding:0 "> 193: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 194:   always_ff @(posedge clk_i or negedge rst_ni) begin : key_init_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 195:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 196:       key_init_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 197:     end else begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 198:       for (int i=0; i<8; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 199:         if (key_init_we[i]) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 200:           key_init_q[i] <= key_init_d[i];</pre>
<pre style="margin:0; padding:0 "> 201:         end</pre>
<pre style="margin:0; padding:0 "> 202:       end</pre>
<pre style="margin:0; padding:0 "> 203:     end</pre>
<pre style="margin:0; padding:0 "> 204:   end</pre>
<pre style="margin:0; padding:0 "> 205: </pre>
<pre style="margin:0; padding:0 "> 206:   // Full Key registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 207:   always_comb begin : key_full_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 208:     unique case (key_full_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 209:       KEY_FULL_ENC_INIT: key_full_d = key_init_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 210:       KEY_FULL_DEC_INIT: key_full_d = key_dec_q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 211:       KEY_FULL_ROUND:    key_full_d = key_expand_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 212:       KEY_FULL_CLEAR:    key_full_d = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 213:       default:           key_full_d = key_init_q;</pre>
<pre style="margin:0; padding:0 "> 214:     endcase</pre>
<pre style="margin:0; padding:0 "> 215:   end</pre>
<pre style="margin:0; padding:0 "> 216: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 217:   always_ff @(posedge clk_i or negedge rst_ni) begin : key_full_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 218:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 219:       key_full_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 220:     end else if (key_full_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 221:       key_full_q <= key_full_d;</pre>
<pre style="margin:0; padding:0 "> 222:     end</pre>
<pre style="margin:0; padding:0 "> 223:   end</pre>
<pre style="margin:0; padding:0 "> 224: </pre>
<pre style="margin:0; padding:0 "> 225:   // Decryption Key registers</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 226:   always_comb begin : key_dec_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 227:     unique case (key_dec_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 228:       KEY_DEC_EXPAND: key_dec_d = key_expand_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 229:       KEY_DEC_CLEAR:  key_dec_d = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 230:       default:        key_dec_d = key_expand_out;</pre>
<pre style="margin:0; padding:0 "> 231:     endcase</pre>
<pre style="margin:0; padding:0 "> 232:   end</pre>
<pre style="margin:0; padding:0 "> 233: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 234:   always_ff @(posedge clk_i or negedge rst_ni) begin : key_dec_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 235:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 236:       key_dec_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 237:     end else if (key_dec_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 238:       key_dec_q <= key_dec_d;</pre>
<pre style="margin:0; padding:0 "> 239:     end</pre>
<pre style="margin:0; padding:0 "> 240:   end</pre>
<pre style="margin:0; padding:0 "> 241: </pre>
<pre style="margin:0; padding:0 "> 242:   // Key expand data path</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 243:   aes_key_expand #(</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 244:   .AES192Enable ( AES192Enable ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 245:   .SBoxImpl     ( SBoxImpl     )</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 246:   ) aes_key_expand (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 247:     .clk_i     ( clk_i            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 248:     .rst_ni    ( rst_ni           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 249:     .mode_i    ( key_expand_mode  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 250:     .step_i    ( key_expand_step  ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 251:     .clear_i   ( key_expand_clear ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 252:     .round_i   ( key_expand_round ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 253:     .key_len_i ( key_len_q        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 254:     .key_i     ( key_full_q       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 255:     .key_o     ( key_expand_out   )</pre>
<pre style="margin:0; padding:0 "> 256:   );</pre>
<pre style="margin:0; padding:0 "> 257: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 258:   always_comb begin : key_words_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 259:     unique case (key_words_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 260:       KEY_WORDS_0123: key_words = key_full_q[3:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 261:       KEY_WORDS_2345: key_words = AES192Enable ? key_full_q[5:2] : key_full_q[3:0];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 262:       KEY_WORDS_4567: key_words = key_full_q[7:4];</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 263:       KEY_WORDS_ZERO: key_words = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 264:       default:        key_words = key_full_q[3:0];</pre>
<pre style="margin:0; padding:0 "> 265:     endcase</pre>
<pre style="margin:0; padding:0 "> 266:   end</pre>
<pre style="margin:0; padding:0 "> 267: </pre>
<pre style="margin:0; padding:0 "> 268:   // Convert words to bytes (every key word contains one column)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 269:   assign key_bytes = aes_transpose(key_words);</pre>
<pre style="margin:0; padding:0 "> 270: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 271:   aes_mix_columns aes_key_mix_columns (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 272:     .mode_i ( AES_DEC             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 273:     .data_i ( key_bytes           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 274:     .data_o ( key_mix_columns_out )</pre>
<pre style="margin:0; padding:0 "> 275:   );</pre>
<pre style="margin:0; padding:0 "> 276: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 277:   always_comb begin : round_key_mux</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 278:     unique case (round_key_sel)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 279:       ROUND_KEY_DIRECT: round_key = key_bytes;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 280:       ROUND_KEY_MIXED:  round_key = key_mix_columns_out;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 281:       default:          round_key = key_bytes;</pre>
<pre style="margin:0; padding:0 "> 282:     endcase</pre>
<pre style="margin:0; padding:0 "> 283:   end</pre>
<pre style="margin:0; padding:0 "> 284: </pre>
<pre style="margin:0; padding:0 "> 285:   /////////////</pre>
<pre style="margin:0; padding:0 "> 286:   // Control //</pre>
<pre style="margin:0; padding:0 "> 287:   /////////////</pre>
<pre style="margin:0; padding:0 "> 288: </pre>
<pre style="margin:0; padding:0 "> 289:   // Control</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 290:   aes_control aes_control (</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 291:     .clk_i                  ( clk_i                              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 292:     .rst_ni                 ( rst_ni                             ),</pre>
<pre style="margin:0; padding:0 "> 293: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 294:     .mode_i                 ( mode_q                             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 295:     .key_len_i              ( key_len_q                          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 296:     .manual_start_trigger_i ( manual_start_trigger_q             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 297:     .force_data_overwrite_i ( force_data_overwrite_q             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 298:     .start_i                ( reg2hw.trigger.start.q             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 299:     .key_clear_i            ( reg2hw.trigger.key_clear.q         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 300:     .data_in_clear_i        ( reg2hw.trigger.data_in_clear.q     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 301:     .data_out_clear_i       ( reg2hw.trigger.data_out_clear.q    ),</pre>
<pre style="margin:0; padding:0 "> 302: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 303:     .data_in_qe_i           ( data_in_qe                         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 304:     .key_init_qe_i          ( key_init_qe                        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 305:     .data_out_re_i          ( data_out_re                        ),</pre>
<pre style="margin:0; padding:0 "> 306: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 307:     .state_sel_o            ( state_sel                          ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 308:     .state_we_o             ( state_we                           ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 309:     .add_rk_sel_o           ( add_round_key_in_sel               ),</pre>
<pre style="margin:0; padding:0 "> 310: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 311:     .key_expand_mode_o      ( key_expand_mode                    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 312:     .key_init_sel_o         ( key_init_sel                       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 313:     .key_init_we_o          ( key_init_we                        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 314:     .key_full_sel_o         ( key_full_sel                       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 315:     .key_full_we_o          ( key_full_we                        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 316:     .key_dec_sel_o          ( key_dec_sel                        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 317:     .key_dec_we_o           ( key_dec_we                         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 318:     .key_expand_step_o      ( key_expand_step                    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 319:     .key_expand_clear_o     ( key_expand_clear                   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 320:     .key_expand_round_o     ( key_expand_round                   ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 321:     .key_words_sel_o        ( key_words_sel                      ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 322:     .round_key_sel_o        ( round_key_sel                      ),</pre>
<pre style="margin:0; padding:0 "> 323: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 324:     .data_in_we_o           ( data_in_we                         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 325:     .data_out_we_o          ( data_out_we                        ),</pre>
<pre style="margin:0; padding:0 "> 326: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 327:     .start_o                ( hw2reg.trigger.start.d             ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 328:     .start_we_o             ( hw2reg.trigger.start.de            ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 329:     .key_clear_o            ( hw2reg.trigger.key_clear.d         ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 330:     .key_clear_we_o         ( hw2reg.trigger.key_clear.de        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 331:     .data_in_clear_o        ( hw2reg.trigger.data_in_clear.d     ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 332:     .data_in_clear_we_o     ( hw2reg.trigger.data_in_clear.de    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 333:     .data_out_clear_o       ( hw2reg.trigger.data_out_clear.d    ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 334:     .data_out_clear_we_o    ( hw2reg.trigger.data_out_clear.de   ),</pre>
<pre style="margin:0; padding:0 "> 335: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 336:     .output_valid_o         ( hw2reg.status.output_valid.d       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 337:     .output_valid_we_o      ( hw2reg.status.output_valid.de      ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 338:     .input_ready_o          ( hw2reg.status.input_ready.d        ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 339:     .input_ready_we_o       ( hw2reg.status.input_ready.de       ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 340:     .idle_o                 ( hw2reg.status.idle.d               ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 341:     .idle_we_o              ( hw2reg.status.idle.de              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 342:     .stall_o                ( hw2reg.status.stall.d              ),</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 343:     .stall_we_o             ( hw2reg.status.stall.de             )</pre>
<pre style="margin:0; padding:0 "> 344:   );</pre>
<pre style="margin:0; padding:0 "> 345: </pre>
<pre style="margin:0; padding:0 "> 346:   // Input data register clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 347:   always_comb begin : data_in_reg_clear</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 348:     for (int i=0; i<4; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 349:       hw2reg.data_in[i].d  = '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 350:       hw2reg.data_in[i].de = data_in_we;</pre>
<pre style="margin:0; padding:0 "> 351:     end</pre>
<pre style="margin:0; padding:0 "> 352:   end</pre>
<pre style="margin:0; padding:0 "> 353: </pre>
<pre style="margin:0; padding:0 "> 354:   // Control register</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 355:   assign ctrl_we = ctrl_qe & hw2reg.status.idle.d;</pre>
<pre style="margin:0; padding:0 "> 356: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 357:   always_ff @(posedge clk_i or negedge rst_ni) begin : ctrl_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 358:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 359:       mode_q                 <= AES_ENC;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 360:       key_len_q              <= AES_128;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 361:       manual_start_trigger_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 362:       force_data_overwrite_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 363:     end else if (ctrl_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 364:       mode_q                 <= mode_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 365:       key_len_q              <= key_len_d;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 366:       manual_start_trigger_q <= reg2hw.ctrl.manual_start_trigger.q;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 367:       force_data_overwrite_q <= reg2hw.ctrl.force_data_overwrite.q;</pre>
<pre style="margin:0; padding:0 "> 368:     end</pre>
<pre style="margin:0; padding:0 "> 369:   end</pre>
<pre style="margin:0; padding:0 "> 370: </pre>
<pre style="margin:0; padding:0 "> 371:   /////////////</pre>
<pre style="margin:0; padding:0 "> 372:   // Outputs //</pre>
<pre style="margin:0; padding:0 "> 373:   /////////////</pre>
<pre style="margin:0; padding:0 "> 374: </pre>
<pre style="margin:0; padding:0 "> 375:   // Convert output state to output data (every state column corresponds to one output word)</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 376:   assign data_out_d = aes_transpose(add_round_key_out);</pre>
<pre style="margin:0; padding:0 "> 377: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 378:   always_ff @(posedge clk_i or negedge rst_ni) begin : data_out_reg</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 379:     if (!rst_ni) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 380:       data_out_q <= '0;</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 381:     end else if (data_out_we) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 382:       data_out_q <= data_out_d;</pre>
<pre style="margin:0; padding:0 "> 383:     end</pre>
<pre style="margin:0; padding:0 "> 384:   end</pre>
<pre style="margin:0; padding:0 "> 385: </pre>
<pre style="margin:0; padding:0 "> 386:   // Outputs</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 387:   always_comb begin : key_reg_put</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 388:     for (int i=0; i<8; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 389:       hw2reg.key[i].d  = key_init_q[i];</pre>
<pre style="margin:0; padding:0 "> 390:     end</pre>
<pre style="margin:0; padding:0 "> 391:   end</pre>
<pre style="margin:0; padding:0 "> 392: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 393:   always_comb begin : data_out_put</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 394:     for (int i=0; i<4; i++) begin</pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 395:       hw2reg.data_out[i].d = data_out_q[i];</pre>
<pre style="margin:0; padding:0 "> 396:     end</pre>
<pre style="margin:0; padding:0 "> 397:   end</pre>
<pre style="margin:0; padding:0 "> 398: </pre>
<pre style="background-color: #C0C0C0; margin:0; padding:0 "> 399:   assign hw2reg.ctrl.key_len.d  = {key_len_q};</pre>
<pre style="margin:0; padding:0 "> 400: </pre>
<pre style="margin:0; padding:0 "> 401:   ////////////////</pre>
<pre style="margin:0; padding:0 "> 402:   // Assertions //</pre>
<pre style="margin:0; padding:0 "> 403:   ////////////////</pre>
<pre style="margin:0; padding:0 "> 404: </pre>
<pre style="margin:0; padding:0 "> 405:   // Selectors must be known/valid</pre>
<pre style="margin:0; padding:0 "> 406:   `ASSERT_KNOWN(AesModeKnown, mode_q, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 407:   `ASSERT(AesKeyLenValid, key_len_q inside {</pre>
<pre style="margin:0; padding:0 "> 408:       AES_128,</pre>
<pre style="margin:0; padding:0 "> 409:       AES_192,</pre>
<pre style="margin:0; padding:0 "> 410:       AES_256</pre>
<pre style="margin:0; padding:0 "> 411:       }, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 412:   `ASSERT(AesStateSelValid, state_sel inside {</pre>
<pre style="margin:0; padding:0 "> 413:       STATE_INIT,</pre>
<pre style="margin:0; padding:0 "> 414:       STATE_ROUND,</pre>
<pre style="margin:0; padding:0 "> 415:       STATE_CLEAR</pre>
<pre style="margin:0; padding:0 "> 416:       }, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 417:   `ASSERT(AesAddRKSelValid, add_round_key_in_sel inside {</pre>
<pre style="margin:0; padding:0 "> 418:       ADD_RK_INIT,</pre>
<pre style="margin:0; padding:0 "> 419:       ADD_RK_ROUND,</pre>
<pre style="margin:0; padding:0 "> 420:       ADD_RK_FINAL</pre>
<pre style="margin:0; padding:0 "> 421:       }, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 422:   `ASSERT_KNOWN(AesKeyInitSelKnown, key_init_sel, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 423:   `ASSERT_KNOWN(AesKeyFullSelKnown, key_full_sel, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 424:   `ASSERT_KNOWN(AesKeyDecSelKnown, key_dec_sel, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 425:   `ASSERT_KNOWN(AesKeyWordsSelKnown, key_words_sel, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 426:   `ASSERT_KNOWN(AesRoundKeySelKnown, round_key_sel, clk_i, !rst_ni)</pre>
<pre style="margin:0; padding:0 "> 427: </pre>
<pre style="margin:0; padding:0 "> 428: endmodule</pre>
<pre style="margin:0; padding:0 "> 429: </pre>
</body>
</html>
